workflow:
  name: zendesk-sync-articles
  title: Zendesk Sync Articles
  description: Workflow to fetch articles from Zendesk Help Center and save them to the database
  context-variables:
    debugger:
      enabled: true
    zendesk:
      username: $MACHINA_CONTEXT_VARIABLE_ZENDESK_USERNAME
      password: $MACHINA_CONTEXT_VARIABLE_ZENDESK_PASSWORD
  inputs:
    locale: $.get('locale', 'en-gb')
    sort_by: $.get('sort_by', 'updated_at')
    sort_order: $.get('sort_order', 'asc')
    page: $.get('page', 1)
    per_page: $.get('per_page', 30)
  outputs:
    articles_count: $.get('articles_count', 0)
    saved_count: $.get('saved_count', 0)
    saved_articles: $.get('saved_articles', [])
    workflow-status: $.get('articles_parsed', []) is None or len($.get('articles_parsed', [])) == 0 and 'skipped' or 'executed'
  tasks:

    # task-fetch-articles
    - type: connector
      name: task-fetch-articles
      description: Fetch articles from Zendesk Help Center
      connector:
        name: zendesk
        command: list_articles
      inputs:
        locale: $.get('locale')
        sort_by: $.get('sort_by')
        sort_order: $.get('sort_order')
        page: $.get('page')
        per_page: $.get('per_page')
      outputs:
        articles_response: $.get('data', {})
        articles: $.get('data', {}).get('articles', [])
        articles_count: $.get('data', {}).get('count', 0)
        articles_raw: |
          [
            {
              'metadata': {
                'article_id': str(article.get('id', '')),
                'section_id': str(article.get('section_id', '')),
                'author_id': str(article.get('author_id', '')),
                'locale': str(article.get('locale', '')),
                'source_locale': str(article.get('source_locale', '')),
                'permission_group_id': str(article.get('permission_group_id', '')),
                'draft': bool(article.get('draft', False)),
                'promoted': bool(article.get('promoted', False)),
                'outdated': bool(article.get('outdated', False))
              },
              'title': str(article.get('title', article.get('name', ''))),
              'body_html': str(article.get('body', '')),
              'label_names': [str(label) for label in (article.get('label_names', []) or [])],
              'created_at': str(article.get('created_at', '')),
              'updated_at': str(article.get('updated_at', '')),
              'edited_at': str(article.get('edited_at', '')) if article.get('edited_at') else '',
              'id': str(article.get('id', '')),
              'url': str(article.get('url', '')),
              'html_url': str(article.get('html_url', ''))
            }
            for article in $.get('articles', [])
            if article.get('body')
          ]

    # zendesk-articles-html-to-text-mapping
    - type: mapping
      name: zendesk-articles-html-to-text-mapping
      description: Convert HTML content to clean text using bs4
      condition: $.get('articles_raw') is not None and len($.get('articles_raw', [])) > 0
      inputs:
        articles_raw: $.get('articles_raw', [])
      outputs:
        articles_parsed: $.get('articles_parsed', [])

    # bulk-save-articles
    - type: document
      name: bulk-save-articles
      condition: $.get('articles_parsed') is not None and len($.get('articles_parsed', [])) > 0
      description: Bulk save articles to the database
      config:
        action: bulk-update
        embed-vector: false
        force-update: true
      document_name: 'zendesk-article'
      documents:
        items: $.get('articles_parsed')
      inputs:
        articles_parsed: $.get('articles_parsed')
      outputs:
        saved_count: len($.get('documents', [])) if $.get('documents') else 0
        saved_articles: $.get('documents', []) if $.get('documents') else $.get('articles_parsed', [])

