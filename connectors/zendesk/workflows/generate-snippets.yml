workflow:
  name: zendesk-generate-snippets
  title: Zendesk Generate Snippets
  description: Workflow to generate snippets from Zendesk articles for search and retrieval
  context-variables:
    debugger:
      enabled: true
    google-genai:
      credential: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL
      project_id: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID
      api_key: $MACHINA_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY
    machina-ai:
      api_key: $MACHINA_CONTEXT_VARIABLE_OPENAI_API_KEY
  inputs:
    limit: $.get('limit', 100)
  outputs:
    snippets_count: $.get('snippets_count', 0)
    workflow-status: $.get('snippets_bulk', []) is None or len($.get('snippets_bulk', [])) == 0 and 'skipped' or 'executed'
  tasks:

    # load-articles
    - type: document
      name: load-articles
      description: Load articles from database (new version)
      config:
        action: search
        search-limit: 1000
        search-vector: false
      inputs:
        name: 'zendesk-article'
        search-limit: $.get('limit')
      outputs:
        articles: $.get('documents', [])
        articles_parsed: |
          [
            {
              '_id': str(article.get('_id', '')),
              'value': {
                'title': str(article.get('value', {}).get('title', '')),
                'body': str(article.get('value', {}).get('body', '')),
                'metadata': {
                  'article_id': str(article.get('value', {}).get('metadata', {}).get('article_id', '')),
                  'section_id': str(article.get('value', {}).get('metadata', {}).get('section_id', '')),
                  'author_id': str(article.get('value', {}).get('metadata', {}).get('author_id', '')),
                  'locale': str(article.get('value', {}).get('metadata', {}).get('locale', '')),
                  'label_names': [str(label) for label in (article.get('value', {}).get('metadata', {}).get('label_names', []) or [])]
                }
              }
            }
            for article in $.get('documents', [])
            if article.get('value', {}).get('body')
          ]

    # load-labels
    - type: document
      name: load-labels
      description: Load labels from database
      config:
        action: search
        search-limit: 1000
        search-vector: false
      inputs:
        name: 'zendesk-label'
      outputs:
        labels: $.get('documents', [])
        labels_parsed: |
          [
            {
              '_id': str(label.get('_id', '')),
              'value': {
                'id': str(label.get('value', {}).get('id', '')),
                'name': str(label.get('value', {}).get('name', '')),
                'title': str(label.get('value', {}).get('title', '')),
                'url': str(label.get('value', {}).get('url', '')) if label.get('value', {}).get('url') else ''
              },
              'metadata': {
                'label_id': str(label.get('metadata', {}).get('label_id', '')),
                'name': str(label.get('metadata', {}).get('name', ''))
              }
            }
            for label in $.get('documents', [])
          ]

    - type: prompt
      name: content-snippet-prompt
      description: Generate snippets from articles using AI
      condition: $.get('articles_parsed') is not None and len($.get('articles_parsed', [])) > 0 and $.get('labels_parsed') is not None and len($.get('labels_parsed', [])) > 0
      connector:
        command: invoke_prompt
        name: google-genai
        model: gemini-3-pro-preview
        location: global
        provider: vertex_ai
      inputs:
        articles: $.get('articles_parsed', [])
        labels: $.get('labels_parsed', [])
      outputs:
        snippets_bulk: |
          [
            {
              'text': snippet.get('content', ''),
              'title': snippet.get('title', ''),
              'metadata': {
                'article_id': snippet.get('article_id', ''),
                'article_title': next((article.get('value', {}).get('title', '') for article in ($.get('articles_parsed', []) or []) if article.get('value', {}).get('metadata', {}).get('article_id', '') == snippet.get('article_id', '')), ''),
                'subject': snippet.get('subject', ''),
                'questions': snippet.get('questions', ''),
                'source': 'zendesk-help-center',
                'document_type': 'article-snippet'
              }
            }
            for snippet in ($.get('snippets', []) if $.get('snippets') else [])
          ]

    # bulk-save-snippets
    - type: document
      name: bulk-save-snippets
      condition: $.get('snippets_bulk') is not None and len($.get('snippets_bulk', [])) > 0
      description: Bulk save snippets to the database
      config:
        action: bulk-update
        embed-vector: true
        force-update: true
      document_name: 'zendesk-content-snippet'
      documents:
        items: $.get('snippets_bulk', [])
      inputs:
        snippets_bulk: $.get('snippets_bulk', [])
      outputs:
        saved_count: len($.get('documents', [])) if $.get('documents') else 0

