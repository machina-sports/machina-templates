workflow:

  # sportradar-soccer-sync-season-schedules
  name: sportradar-soccer-sync-season-schedules
  title: Sportradar Soccer - Season Schedules
  description: Workflow to synchronize season schedules from SportRadar API to Machina as season:Schedule documents.
  context-variables:
    debugger:
      enabled: false
    machina-ai:
      api_key: $TEMP_CONTEXT_VARIABLE_SDK_OPENAI_API_KEY
    sportradar-soccer:
      api_key: $TEMP_CONTEXT_VARIABLE_SPORTRADAR_SOCCER_V4_API_KEY
  inputs:
    season_ids: $.get('season_ids', [])
  outputs:
    season_schedules: $.get('season_schedules_list', [])
    workflow-status: len($.get('season_schedules_list', [])) > 0 and 'executed' or 'skipped'
  tasks:

    # load-season-schedules
    - type: connector
      name: load-season-schedules
      description: Get season schedules from SportRadar for each season
      connector:
        name: sportradar-soccer
        command: get-seasons/{season_id}/{data_type}
        command_attribute:
          season_id: $.get('season-id')
          data_type: "'schedules.json'"
      foreach:
        name: season-id
        expr: $
        value: $.get('season_ids', [])
      condition: $.get('season_ids') is not None and len($.get('season_ids', [])) > 0
      inputs:
        api_key: $.get('api_key')
        start: "'0'"
      outputs:
        season_schedules_list: |
          [
            {
              'season_id': context.get('season-id'),
              'sr_session_id': str(context.get('season-id', '')).replace('urn:sportradar:season:', '').replace('sr:season:', ''),
              'schedules': $.get('schedules', [])
            }
          ]

    # check-existing-season-schedules
    - type: document
      name: check-existing-season-schedules
      condition: $.get('season_schedules_list') is not None and len($.get('season_schedules_list', [])) > 0
      description: Check for existing season schedule documents.
      config:
        action: search
        search-limit: 10000
        search-vector: false
      filters:
        metadata.season_id: |
          {'$in': [item.get('season_id', '') for item in $.get('season_schedules_list', [])]}
      inputs:
        name: "'season:Schedule'"
      outputs:
        existing_season_ids: |
          [
            doc.get('metadata', {}).get('season_id', '')
            for doc in $.get('documents', [])
          ]

    # bulk-save-season-schedules
    - type: document
      name: bulk-save-season-schedules
      description: Bulk save season schedule documents
      condition: $.get('season_schedules_list') is not None and len($.get('season_schedules_list', [])) > 0
      config:
        action: bulk-update
        embed-selector: $.get('title')
        embed-vector: true
        force-update: true
      connector:
        name: machina-ai
        command: invoke_embedding
        model: text-embedding-3-small
      document_name: "'season:Schedule'"
      documents:
        items: |
          [
            {
              'name': 'season:Schedule',
              'metadata': {
                'season_id': item.get('season_id', ''),
                'sr_session_id': item.get('sr_session_id', ''),
                'sport': 'soccer'
              },
              'season': (
                lambda schedules: {
                  'id': schedules[0].get('sport_event_context', {}).get('season', {}).get('id', ''),
                  'name': schedules[0].get('sport_event_context', {}).get('season', {}).get('name', ''),
                  'start_date': schedules[0].get('sport_event_context', {}).get('season', {}).get('start_date', ''),
                  'end_date': schedules[0].get('sport_event_context', {}).get('season', {}).get('end_date', '')
                }
                if schedules and len(schedules) > 0 and schedules[0].get('sport_event_context') else {
                  'id': '', 'name': '', 'start_date': '', 'end_date': ''
                }
              )(item.get('schedules', [])),
              'competition': (
                lambda schedules: {
                  'id': schedules[0].get('sport_event_context', {}).get('competition', {}).get('id', ''),
                  'name': schedules[0].get('sport_event_context', {}).get('competition', {}).get('name', '')
                }
                if schedules and len(schedules) > 0 and schedules[0].get('sport_event_context') else {
                  'id': '', 'name': ''
                }
              )(item.get('schedules', [])),
              'events': [
                {
                  'event_id': schedule.get('sport_event', {}).get('id', ''),
                  'start_time': schedule.get('sport_event', {}).get('start_time', ''),
                  'start_time_confirmed': schedule.get('sport_event', {}).get('start_time_confirmed', False),
                  'home': (
                    lambda competitors: {
                      'id': next((c.get('id', '') for c in competitors if c.get('qualifier') == 'home'), ''),
                      'name': next((c.get('name', '') for c in competitors if c.get('qualifier') == 'home'), ''),
                      'abbreviation': next((c.get('abbreviation', '') for c in competitors if c.get('qualifier') == 'home'), ''),
                      'score': schedule.get('sport_event_status', {}).get('home_score') if schedule.get('sport_event_status', {}).get('status') == 'closed' else None
                    } if any(c.get('qualifier') == 'home' for c in competitors) else {
                      'id': '', 'name': '', 'abbreviation': '', 'score': None
                    }
                  )(schedule.get('sport_event', {}).get('competitors', [])),
                  'away': (
                    lambda competitors: {
                      'id': next((c.get('id', '') for c in competitors if c.get('qualifier') == 'away'), ''),
                      'name': next((c.get('name', '') for c in competitors if c.get('qualifier') == 'away'), ''),
                      'abbreviation': next((c.get('abbreviation', '') for c in competitors if c.get('qualifier') == 'away'), ''),
                      'score': schedule.get('sport_event_status', {}).get('away_score') if schedule.get('sport_event_status', {}).get('status') == 'closed' else None
                    } if any(c.get('qualifier') == 'away' for c in competitors) else {
                      'id': '', 'name': '', 'abbreviation': '', 'score': None
                    }
                  )(schedule.get('sport_event', {}).get('competitors', [])),
                  'status': schedule.get('sport_event_status', {}).get('status', 'not_started'),
                  'match_status': schedule.get('sport_event_status', {}).get('match_status', 'not_started')
                }
                for schedule in (item.get('schedules', []) if isinstance(item.get('schedules', []), list) else [])
              ],
              'total_events': len(item.get('schedules', []) if isinstance(item.get('schedules', []), list) else []),
              'title': f"{item.get('season_id', '')} Schedule"
            }
            for item in $.get('season_schedules_list', [])
          ]
