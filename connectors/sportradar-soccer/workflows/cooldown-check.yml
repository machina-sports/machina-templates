workflow:
  name: sportradar-soccer-cooldown-check
  title: Sportradar Soccer - Cooldown Check
  description: Check if enough time has passed since last execution to prevent infinite loops
  outputs:
    should-execute: $.get('should-execute', True)
    last-execution-time: $.get('last-execution-time', '')
    time-since-last-run: $.get('time-since-last-run', 0)
    workflow-status: "'executed'"
  tasks:

    # Load last execution timestamp from document
    - type: document
      name: load-last-execution-timestamp
      description: Load the last execution timestamp from database
      config:
        action: search
        search-limit: 1
        search-vector: false
      filters:
        name: sportradar-soccer-config-seasons-execution-lock
      outputs:
        last-execution-raw: $.get('documents', [])
        last-execution-time: |
          $.get('documents', [])[0].get('value', {}).get('last_execution_time', '') if len($.get('documents', [])) > 0 else ''
        cooldown-minutes-config: |
          $.get('documents', [])[0].get('value', {}).get('cooldown_minutes', 120) if len($.get('documents', [])) > 0 else 120

    # Calculate time since last execution (inline Python calculation)
    - type: document
      name: calculate-time-since-last-run
      description: Calculate minutes since last execution using inline Python
      config:
        action: noop
      outputs:
        time-since-last-run: |
          (
            (__import__('datetime').datetime.utcnow() - __import__('datetime').datetime.fromisoformat($.get('last-execution-time', '').replace('Z', '+00:00'))).total_seconds() / 60
            if $.get('last-execution-time', '') != ''
            else 999999
          )

    # Determine if we should execute
    - type: document
      name: determine-should-execute
      description: Decide if enough time has passed (or if this is first run)
      config:
        action: noop
      outputs:
        should-execute: |
          ($.get('last-execution-time', '') == '') or ($.get('time-since-last-run', 0) >= $.get('cooldown-minutes-config', 120))
        execution-decision-reason: |
          'First run - no previous execution' if $.get('last-execution-time', '') == '' else (
            f"Cooldown passed: {$.get('time-since-last-run', 0)} >= {$.get('cooldown-minutes-config', 120)} minutes" if $.get('time-since-last-run', 0) >= $.get('cooldown-minutes-config', 120) else
            f"Cooldown active: {$.get('time-since-last-run', 0)} < {$.get('cooldown-minutes-config', 120)} minutes - SKIPPING"
          )
