workflow:

  name: sportradar-soccer-config-seasons-workflow
  title: Sportradar Soccer - Config Seasons Workflow
  description: Workflow to load seasons for coverage tools
  context-variables:
    debugger:
      enabled: true
    google-genai:
      credential: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL
      project_id: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID
    machina-ai:
      api_key: $TEMP_CONTEXT_VARIABLE_SDK_OPENAI_API_KEY
    sportradar-soccer:
      api_key: $TEMP_CONTEXT_VARIABLE_SPORTRADAR_SOCCER_V4_API_KEY
  outputs:
    competition-ids: $.get('competition-ids')
    current-seasons: $.get('current-seasons')
    current-seasons-id: $.get('current-seasons-id')
    competitor-ids: $.get('all-competitor-ids', [])
    workflow-status: "'executed'"
  tasks:

    # load dispatch configuration
    - type: document
      name: load-seasons-config
      description: Load seasons configuration (supports sportradar-soccer-config or coverage-soccer-preview-config)
      config:
        action: search
        search-limit: 1
        search-vector: false
      filters:
        name: "{'$in': ['sportradar-soccer-config', 'coverage-soccer-preview-config']}"
      sorters:
        - "name"
        - -1
      outputs:
        coverage-soccer-preview: $.get('documents', [])[0].get('value', {}).get('coverage-soccer-preview', []) if len($.get('documents', [])) > 0 else []
        competition-ids: |
          [
            competition_id.replace('urn:sportradar:competition:', 'sr:competition:')
            for competition_id in $.get('documents', [])[0].get('value', {}).get('coverage-soccer-preview', [])
          ]

    # task-load-seasons
    - type: connector
      name: task-load-seasons
      description: Get Seasons from SportRadar
      condition: $.get('competition-ids') is not None and len($.get('competition-ids', [])) > 0
      connector:
        name: sportradar-soccer
        command: get-competitions/{competition_id}/seasons.json
        command_attribute:
          competition_id: $.get('competition-id')
      foreach:
        name: competition-id
        expr: $
        value: $.get('competition-ids')
      inputs:
        api_key: $.get('api_key')
      outputs:
        competitions-seasons: |
          [
            $.get('seasons', [])
          ]

    # task-parse-season
    - type: connector
      name: task-parse-season
      description: Parse Season
      connector:
        name: coverage-get-current-season
        command: invoke_get_current_season
      foreach:
        name: seasons
        expr: $
        value: $.get('competitions-seasons', [])
      inputs:
        seasons: $.get('seasons')
      outputs:
        current-seasons: |
          [
            $.get('current-season')
          ]
        current-seasons-id: |
          [
            $.get('current-season', {}).get('id', '')
          ]

    # task-load-competitors-for-summaries
    - type: connector
      name: task-load-competitors-for-summaries
      description: Get competitors from each season to collect for summaries
      condition: $.get('current-seasons-id') is not None and len($.get('current-seasons-id', [])) > 0
      connector:
        name: sportradar-soccer
        command: get-seasons/{season_id}/{data_type}
        command_attribute:
          season_id: $.get('season-id')
          data_type: "'competitors.json'"
      foreach:
        name: season-id
        expr: $
        value: $.get('current-seasons-id', [])
      inputs:
        api_key: $.get('api_key')
      outputs:
        all-competitor-ids: |
          list(set(
            competitor.get('id', '')
            for competitor in $.get('season_competitors', [])
            if competitor.get('id', '')
          ))

    # NOTE:
    # Sync of `season:Schedule` and `competitor:Summarie` documents is orchestrated by the agent
    # (`connectors/sportradar-soccer/agents/config-seasons.yml`) to avoid
    # nested `type: workflow` execution issues in this workflow.
