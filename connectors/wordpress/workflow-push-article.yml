workflow:
  name: "wordpress-push-article"
  description: "This workflow creates a post in WordPress with auto token refresh"
  inputs:
    title: "Test Auto Refresh"
    content_html: "<p>Post via workflow.</p>"
    excerpt: "Summary"
    images:
      - url: "https://via.placeholder.com/1200x630.png?text=Workflow"
        alt_text: "Test"
    categories: []
    tags: []
    auto_append_images: true
    set_featured_image: true
  outputs:
    post_id: "$.get('post_id')"
    draft_url: "$.get('draft_url')"
    access_token: "$.get('access_token')"
    workflow-status: "$.get('workflow-status', 'completed')"
  tasks:
    - type: "connector"
      name: "refresh-token"
      description: "Refresh WordPress.com access token"
      connector:
        name: "wordpress"
        command: "refresh_wpcom_access_token"
      headers:
        client_id: "${MACHINA_CONTEXT_VARIABLE_WPCOM_CLIENT_ID}"
        client_secret: "${MACHINA_CONTEXT_VARIABLE_WPCOM_CLIENT_SECRET}"
        refresh_token: "${MACHINA_CONTEXT_VARIABLE_WPCOM_REFRESH_TOKEN}"
      outputs:
        access_token: "$.get('access_token')"
        
    - type: "connector"
      name: "upload-media"
      description: "Upload featured image to WordPress"
      condition: "images and len(images) > 0 and set_featured_image is True"
      connector:
        name: "wordpress"
        command: "upload_media"
      headers:
        site_url: "${MACHINA_CONTEXT_VARIABLE_WORDPRESS_SITE_URL}"
        authorization: "Bearer $('access_token')"
      inputs:
        url: "images[0].get('url')"
        filename: "featured-image.jpg"
      outputs:
        media_id: "$.get('id')"
        
    - type: "connector"
      name: "create-post"
      description: "Create a post in WordPress"
      connector:
        name: "wordpress"
        command: "create_draft_post"
      headers:
        site_url: "${MACHINA_CONTEXT_VARIABLE_WORDPRESS_SITE_URL}"
        authorization: "Bearer $('access_token')"
      inputs:
        title: "title"
        content_html: "content_html"
        excerpt: "excerpt"
        featured_media_id: "$('media_id', 0)"
        categories: "categories"
        tags: "tags"
      outputs:
        post_id: "$.get('id')"
        draft_url: "$.get('link')"
        workflow-status: "completed"
