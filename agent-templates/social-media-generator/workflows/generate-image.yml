workflow:
  name: social-media-generate-image
  title: Generate Image for Social Media Suggestion
  description: Generates AI image for a selected content suggestion with custom user input
  context-variables:
    debugger:
      enabled: true
    google-genai:
      credential: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL"
      project_id: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID"
      api_key: "$TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY"
    google-storage:
      api_key: "$TEMP_CONTEXT_VARIABLE_GOOGLE_STORAGE_API_KEY"
      bucket_name: "$TEMP_CONTEXT_VARIABLE_GOOGLE_STORAGE_BUCKET_NAME"
    machina-ai:
      api_key: "$TEMP_CONTEXT_VARIABLE_SDK_OPENAI_API_KEY"
  inputs:
    suggestion_id: "$.get('suggestion_id')"
    custom_prompt: "$.get('custom_prompt', '')"
    aspect_ratio: "$.get('aspect_ratio', '1:1')"
  outputs:
    workflow-status: "$.get('workflow_executed_status', 'executed')"
    image_url: "$.get('uploaded_image_url')"
    suggestion_id: "$.get('suggestion_id')"
  tasks:
    # 1. Load suggestion document
    - type: document
      name: load-suggestion
      config:
        action: search
        search-limit: 1
      filters:
        _id: "$.get('suggestion_id')"
      inputs:
        name: "'social-media-suggestion'"
      outputs:
        suggestion_exists: "len($.get('documents', [])) > 0"
        suggestion_data: "$.get('documents')[0].get('value') if len($.get('documents', [])) > 0 else {}"
        content_type: "$.get('documents')[0].get('value', {}).get('content_type') if len($.get('documents', [])) > 0 else 'meme'"
        matchup: "$.get('documents')[0].get('value', {}).get('matchup') if len($.get('documents', [])) > 0 else ''"
        home_team_name: "$.get('documents')[0].get('value', {}).get('home_team_name') if len($.get('documents', [])) > 0 else ''"
        content_data: "$.get('documents')[0].get('value', {}).get('content') if len($.get('documents', [])) > 0 else {}"
        content_context: "$.get('documents')[0].get('value', {}).get('context') if len($.get('documents', [])) > 0 else {}"

    # 2. Create image using Gemini (inline prompt like personalized-podcast)
    - type: connector
      name: create-content-image
      condition: "$.get('suggestion_exists') is True"
      connector:
        name: google-genai
        command: invoke_image
      inputs:
        model_name: "'gemini-3-pro-image-preview'"
        aspect_ratio: "$.get('aspect_ratio')"
        content_type: "$.get('content_type')"
        matchup: "$.get('matchup')"
        home_team_name: "$.get('home_team_name')"
        caption: "$.get('content_data', {}).get('caption', '')"
        custom_prompt: "$.get('custom_prompt', '')"
        prompt: |
          "=== SOCIAL MEDIA IMAGE GENERATION ===\n\nCONTENT TYPE: {{content_type}}\nMATCHUP: {{matchup}}\nCAPTION: {{caption}}\nASPECT RATIO: {{aspect_ratio}}\n\nGenerate a high-quality {{aspect_ratio}} social media image for {{matchup}}.\n\nContent Type Guidelines:\n- MEME: Bold, humorous, shareable. Popular meme formats with visual storytelling.\n- STATS: Clean, professional infographic style with data visualization.\n- QUIZ: Engaging, inviting, interactive feel that encourages participation.\n\nStyle Requirements:\n- High-quality sports photography aesthetic\n- Cinematic lighting and composition\n- Professional color grading\n- Sharp, engaging visuals optimized for social media\n- Team colors should be incorporated tastefully\n\nCRITICAL REQUIREMENTS:\n- ABSOLUTELY NO text, words, letters, numbers, or typography in the image\n- NO player names or individual athlete depictions\n- NO team logos or emblems\n- NO jerseys with visible text or numbers\n- The image should convey the concept through visual storytelling only\n\nThe caption will be added separately as text overlay by the social media platform.\nCreate a visually stunning image that supports the caption: {{caption}}"
      outputs:
        generated_image_path: "$.get('image_path')"

    # 3. Upload image to Google Storage
    - type: connector
      name: upload-image-to-storage
      condition: "$.get('generated_image_path') is not None"
      connector:
        name: google-storage
        command: invoke_upload
      inputs:
        api_key: "$.get('api_key')"
        image_path: "$.get('generated_image_path')"
      outputs:
        uploaded_image_url: "$.get('url')"

    # 4. Update suggestion document with image
    - type: document
      name: update-suggestion
      condition: "$.get('uploaded_image_url') is not None"
      config:
        action: update
        embed-vector: false
        force-update: true
      filters:
        _id: "$.get('suggestion_id')"
      documents:
        social-media-suggestion: |
          {
            **$.get('suggestion_data', {}),
            'has_image': True,
            'image_url': $.get('uploaded_image_url'),
            'custom_prompt': $.get('custom_prompt', ''),
            'aspect_ratio': $.get('aspect_ratio'),
            'status': 'completed',
            'image_generated_at': datetime.utcnow().isoformat()
          }
      outputs:
        workflow_executed_status: "'executed'"

