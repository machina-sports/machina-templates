workflow:
  name: bundesliga-podcast-generate-image
  title: Bundesliga Podcast Generate Image
  description: Workflow to generate Bundesliga podcast image based on user profile stored in documents and web search results
  context-variables:
    debugger:
      enabled: true
    google-genai:
      credential: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL
      project_id: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID
      api_key: $TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY
    google-storage:
      api_key: $TEMP_CONTEXT_VARIABLE_GOOGLE_STORAGE_API_KEY
      bucket_name: $TEMP_CONTEXT_VARIABLE_GOOGLE_STORAGE_BUCKET_NAME
    machina-ai:
      api_key: $TEMP_CONTEXT_VARIABLE_SDK_OPENAI_API_KEY
    oxylabs:
      username: $TEMP_CONTEXT_VARIABLE_OXYLABS_USERNAME
      password: $TEMP_CONTEXT_VARIABLE_OXYLABS_PASSWORD
  inputs:
    document_id: $.get('document_id')
    geo_location: $.get('geo_location', 'Brazil')
    limit: $.get('limit', 10)
    parser: ($.get('parser', 'true') == 'true') and True or False
    query: $.get('query')
    source: $.get('source', 'google_search')
    udm: int($.get('udm', 2))
  outputs:
    workflow-status: "'executed'"
  tasks:

    # Load user profile from documents
    - type: document
      name: load-user-profile
      description: "Load user profile from documents by email address"
      condition: "$.get('document_id') is not None"
      config:
        action: "search"
        search-limit: 1
        search-vector: false
      connector:
        name: "machina-ai"
        command: "invoke_embedding"
        model: "text-embedding-3-small"
      filters:
        document_id: $.get('document_id')
      inputs:
        name: "'user-profile'"
      outputs:
        document-exists: len($.get('documents', [])) > 0
        document-value: "$.get('documents', [])[0].get('value', {}) if len($.get('documents', [])) > 0 else {}"
        favorite_sport: "$.get('documents', [])[0].get('value', {}).get('favorite_sport') if len($.get('documents', [])) > 0 else None"
        favorite_team: "$.get('documents', [])[0].get('value', {}).get('favorite_team') if len($.get('documents', [])) > 0 else None"
        audio_content: "$.get('documents', [])[0].get('value', {}).get('audio_content') if len($.get('documents', [])) > 0 else None"
  
    # bundesliga-podcast-generate-image-queries
    - type: prompt
      name: bundesliga-podcast-generate-image-queries
      description: Generate image queries based on user's favorite sport and team.
      condition: $.get('document_id') is not None and $.get('document-exists') is True
      connector:
        command: invoke_prompt
        name: google-genai
        model: gemini-2.5-flash
        location: global
        provider: vertex_ai
      inputs:
        audio_content: $.get('audio_content')
        favorite_sport: $.get('favorite_sport')
        favorite_team: $.get('favorite_team')
      outputs:
        image_queries: "$.get('image_queries', [])"

    # oxylabs-post-queries
    - type: connector
      name: oxylabs-post-queries
      description: Search for images.
      condition: len($.get('image_queries', [])) > 0
      connector:
        name: oxylabs
        command: post-queries
      continue_on_error: true
      foreach:
        name: image_query
        expr: $
        value: $.get('image_queries', [])
      inputs:
        body: |
          {
            "context": [
              {
                "key": "udm",
                "value": $.get('udm')
              },
              {
                "key": "limit_per_page",
                "value": [
                  {
                    "page": 1,
                    "limit": $.get('limit')
                  }
                ]
              }
            ],
            "geo_location": $.get('geo_location'),
            "parse": $.get('parser'),
            "query": str($.get('image_query', '')),
            "source": $.get('source'),
          }
      outputs:
        image_urls: $.get('results', [])[0].get('content').get('results', {}).get('organic', [])[:5] if $.get('results', [])[0].get('content') else []

    # save-to-tmp
    - type: connector
      name: temp-bundesliga-podcast-logo-downloader
      description: Save the image to tmp.
      condition: len($.get('image_urls', [])) > 0
      connector:
        name: temp-downloader
        command: invoke_save_to_tmp
      foreach:
        name: image-item
        expr: $
        value: $.get('image_urls', [])
      inputs:
        image_base64: $.get('image-item', {}).get('image', '')
      outputs:
        reference_images: |
          [
            $.get('image_path')
          ]

    # bundesliga-podcast-generate-image-prompt
    - type: prompt
      name: bundesliga-podcast-generate-image-prompt
      description: Generate image prompt based on user's favorite sport and team.
      condition: $.get('document_id') is not None and $.get('document-exists') is True
      connector:
        command: invoke_prompt
        name: google-genai
        model: gemini-2.5-flash
        location: global
        provider: vertex_ai
      inputs:
        audio_content: $.get('audio_content')
        favorite_sport: "$.get('favorite_sport')"
        favorite_team: "$.get('favorite_team')"
        image_queries: "$.get('image_queries', [])"
      outputs:
        image_prompt: "$.get('image_prompt', '')"

    # create-background-image
    - type: connector
      name: create-background-image
      description: "Create the background image using Gemini based on the generated description."
      condition: "$.get('image_prompt') is not None"
      connector:
        name: "google-genai"
        command: "invoke_image"
      inputs:
        image_queries: "$.get('image_queries', [])"
        image_paths: "$.get('reference_images', [])"
        model_name: "'gemini-2.5-flash-image-preview'"
        prompt: |
          "Create a CINEMATIC, DREAMLIKE visual composition suitable for podcast headers. Generate a 16/9 widescreen landscape image (1920x1080 or equivalent proportions) that blends classic elements and motion, capturing timeless heritage meeting modern speed. CONTEXT This image is for a podcast about {{favorite_sport}} tailored for fans of {{favorite_team}}. The podcast script discusses {{audio_content}} Reference images have been provided based on these queries {{image_queries}}. The reference images include {{favorite_team}}s official logo, stadium, and mascot - these are CRITICAL visual elements that MUST be prominently featured in the final composition. REFERENCE IMAGE REQUIREMENTS - The reference image containing {{favorite_team}}s official logo - you MUST incorporate this logo design, shape, and visual identity into the composition. Recreate the logo's distinctive design elements, shapes, symbols, and iconography from the reference image, but render it in a cinematic, dreamlike style without any text or lettering. The logo should be recognizable as {{favorite_team}}s visual identity even when stylized.\n- The reference image showing {{favorite_team}}s stadium - you MUST prominently feature this stadium's distinctive elements, structure, and recognizable features in the composition. Incorporate the stadium's unique design, facade, stands, roof structure, or iconic elements that make it identifiable as {{favorite_team}}s home ground.\n- The reference image containing {{favorite_team}}s mascot - you MUST incorporate the mascot's distinctive appearance, character design, and visual elements into the composition. Recreate the mascot's recognizable features, form, and character in a cinematic, dreamlike style that maintains its identity.\n- Use the reference images containing the logo, stadium, and mascot as PRIMARY visual sources - they are the foundation of the composition. Extract and recreate their distinctive visual elements, shapes, colors, and forms while maintaining cinematic quality.\n- Additional reference images may contain other relevant visual elements - incorporate these as secondary elements that support the main composition.\n- Recreate all visual elements from reference images without any watermarks, logos, text overlays, copyright marks, or branding. If reference images contain watermarks or text, recreate those visual elements without them. CRITICAL REQUIREMENTS - ABSOLUTELY NO text, words, letters, numbers, typography, or written elements anywhere in the image - completely text-free\n- ABSOLUTELY NO player names, player references, or individual athletes - focus only on stadiums, team colors, motion, heritage, mascots, and cinematic composition\n- The team logo from the reference images MUST be prominently visible and recognizable in the composition - incorporate its design elements, shapes, and visual identity\n- The stadium from the reference images MUST be a central or prominent element in the composition - showcase its distinctive structure and recognizable features\n- The mascot from the reference images MUST be incorporated into the composition - feature its distinctive character design and recognizable elements\n- Only incorporate visual elements, teams, and concepts that correspond to the provided reference images and image queries\n- The image must celebrate {{favorite_team}}s identity and spirit through the logo, stadium, mascot, team colors, and visual symbolism DESIGN STYLE Create a realistic photographic composition with cinematic qualities (NOT abstract, NOT graphic design). The composition should feel like a retro-futuristic travel poster - poetic, fast, slightly surreal, suspended between memory and motion. The subject should convey elegance, power, and history â€” like an icon of culture meeting a symbol of velocity. Use minimal, editorial framing suitable for podcast headers. Integrate the team logo, stadium, and mascot from reference images in a way that feels natural and cinematic, not forced or graphic. COLOR PALETTE Use a warm, muted palette with gentle light leaks and shadows suggesting analog photography. Incorporate soft, nostalgic tones that evoke film-grain texture. Integrate {{favorite_team}}s primary and secondary team colors throughout the composition in a subtle, cinematic way that maintains the dreamlike aesthetic. Extract team colors from the logo reference image and use them throughout the composition. Weave the team colors into the warm muted palette, light leaks, shadows, and overall color scheme. Use deep shadows and warm highlights to create depth and atmosphere. Avoid overly saturated or flat colors - maintain the dreamlike, cinematic quality while incorporating team colors. Use color relationships to create the feeling of timeless heritage, incorporating {{favorite_team}}s colors as part of that heritage. COMPOSITION Create a cinematic, dreamlike composition with soft diffusion. The team logo from the reference images should be integrated prominently - either as a central focal point, background element, or visual detail. The stadium from the reference images should be featured as a primary element - showcase its distinctive structure, facade, or recognizable features. The mascot from the reference images should be incorporated naturally - either as a foreground element, visual detail, or symbolic presence. Blend the stadium and motion in the frame. Use minimal, editorial framing with balanced visual hierarchy. Employ strategic use of negative space and composition flow. Create depth through realistic layering, depth of field, and cinematic perspective. Arrange visual elements to represent the story and themes from the podcast content. The composition should feel like a retro-futuristic travel poster - poetic and slightly surreal. Ensure the logo, stadium, and mascot work together harmoniously in the composition. VISUAL EFFECTS Apply heavy motion blur to elements suggesting speed and movement. Use soft diffusion throughout to create dreamlike, cinematic quality. Apply nostalgic film-grain texture to the entire image. Include gentle light leaks and shadows suggesting analog photography. Use realistic photographic effects depth of field, motion blur, lens flares, atmospheric haze. The team logo, stadium, and mascot should be rendered with cinematic effects - they can have motion blur, depth of field, or atmospheric haze applied while remaining recognizable. The final image should feel suspended between memory and motion. Maintain realistic rendering with cinematic, dreamlike qualities. The image must be completely free of text, words, letters, numbers, typography, or written elements. It must be 16/9 widescreen landscape aspect ratio (1920x1080 or equivalent proportions). It must be CINEMATIC and DREAMLIKE - a realistic photographic composition with retro-futuristic travel poster aesthetic, poetic, fast, slightly surreal, suspended between memory and motion. The team logo, stadium, and mascot from the reference images must be clearly recognizable and prominently featured."
      outputs:
        data: "$"
        image_path: "$.get('image_path')"

    # upload image to google storage
    - type: connector
      name: upload-image-to-google-storage
      description: Upload the image to Google Storage.
      condition: $.get('image_path') is not None
      connector:
        name: google-storage
        command: invoke_upload
      inputs:
        api_key: $.get('api_key')
        image_path: $.get('image_path')
      outputs:
        uploaded_image_path: "$.get('url')"

    # version-control-update
    - type: document
      name: version-control-update
      description: Update the user profile document version control.
      condition: $.get('document-exists') is True
      config:
        action: update
        embed-vector: false
        force-update: true
      filters:
        document_id: $.get('document_id')
      documents:
        user-profile: |
          {
            **$.get('document-value', {}),
            "audio_content": $.get('audio_content'),
            "image_path": $.get('uploaded_image_path'),
          }
      