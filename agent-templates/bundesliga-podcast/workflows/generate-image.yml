workflow:
  name: bundesliga-podcast-generate-image
  title: Bundesliga Podcast Generate Image
  description: Workflow to generate Bundesliga podcast image based on user profile stored in documents and web search results
  context-variables:
    debugger:
      enabled: true
    google-genai:
      credential: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL
      project_id: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID
      api_key: $TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY
    google-storage:
      api_key: $TEMP_CONTEXT_VARIABLE_GOOGLE_STORAGE_API_KEY
      bucket_name: $TEMP_CONTEXT_VARIABLE_GOOGLE_STORAGE_BUCKET_NAME
    machina-ai:
      api_key: $TEMP_CONTEXT_VARIABLE_SDK_OPENAI_API_KEY
    oxylabs:
      username: $TEMP_CONTEXT_VARIABLE_OXYLABS_USERNAME
      password: $TEMP_CONTEXT_VARIABLE_OXYLABS_PASSWORD
  inputs:
    document_id: $.get('document_id')
    geo_location: $.get('geo_location', 'Brazil')
    limit: $.get('limit', 10)
    parser: ($.get('parser', 'true') == 'true') and True or False
    query: $.get('query')
    source: $.get('source', 'google_search')
    udm: int($.get('udm', 2))
  outputs:
    workflow-status: "'executed'"
  tasks:

    # Load user profile from documents
    - type: document
      name: load-user-profile
      description: "Load user profile from documents by email address"
      condition: "$.get('document_id') is not None"
      config:
        action: "search"
        search-limit: 1
        search-vector: false
      connector:
        name: "machina-ai"
        command: "invoke_embedding"
        model: "text-embedding-3-small"
      filters:
        document_id: $.get('document_id')
      inputs:
        name: "'user-profile'"
      outputs:
        document-exists: len($.get('documents', [])) > 0
        document-value: "$.get('documents', [])[0].get('value', {}) if len($.get('documents', [])) > 0 else {}"
        favorite_sport: "$.get('documents', [])[0].get('value', {}).get('favorite_sport') if len($.get('documents', [])) > 0 else None"
        favorite_team: "$.get('documents', [])[0].get('value', {}).get('favorite_team') if len($.get('documents', [])) > 0 else None"
        audio_content: "$.get('documents', [])[0].get('value', {}).get('audio_content') if len($.get('documents', [])) > 0 else None"
  
    # bundesliga-podcast-generate-image-queries
    - type: prompt
      name: bundesliga-podcast-generate-image-queries
      description: Generate image queries based on user's favorite sport and team.
      condition: $.get('document_id') is not None and $.get('document-exists') is True
      connector:
        command: invoke_prompt
        name: google-genai
        model: gemini-2.5-flash
        location: global
        provider: vertex_ai
      inputs:
        audio_content: $.get('audio_content')
        favorite_sport: $.get('favorite_sport')
        favorite_team: $.get('favorite_team')
      outputs:
        image_queries: "$.get('image_queries', [])"

    # oxylabs-post-queries
    - type: connector
      name: oxylabs-post-queries
      description: Search for images.
      condition: len($.get('image_queries', [])) > 0
      connector:
        name: oxylabs
        command: post-queries
      continue_on_error: true
      foreach:
        name: image_query
        expr: $
        value: $.get('image_queries', [])
      inputs:
        body: |
          {
            "context": [
              {
                "key": "udm",
                "value": $.get('udm')
              },
              {
                "key": "limit_per_page",
                "value": [
                  {
                    "page": 1,
                    "limit": $.get('limit')
                  }
                ]
              }
            ],
            "geo_location": $.get('geo_location'),
            "parse": $.get('parser'),
            "query": str($.get('image_query', '')),
            "source": $.get('source'),
          }
      outputs:
        image_urls: $.get('results', [])[0].get('content').get('results', {}).get('organic', [])[:1] if $.get('results', [])[0].get('content') else []

    # save-to-tmp
    - type: connector
      name: temp-bundesliga-podcast-logo-downloader
      description: Save the image to tmp.
      condition: len($.get('image_urls', [])) > 0
      connector:
        name: temp-downloader
        command: invoke_save_to_tmp
      foreach:
        name: image-item
        expr: $
        value: $.get('image_urls', [])
      inputs:
        image_base64: $.get('image-item', {}).get('image', '')
      outputs:
        reference_images: |
          [
            $.get('image_path')
          ]

    # bundesliga-podcast-generate-image-prompt
    - type: prompt
      name: bundesliga-podcast-generate-image-prompt
      description: Generate image prompt based on user's favorite sport and team.
      condition: $.get('document_id') is not None and $.get('document-exists') is True
      connector:
        command: invoke_prompt
        name: google-genai
        model: gemini-2.5-flash
        location: global
        provider: vertex_ai
      inputs:
        favorite_sport: "$.get('favorite_sport')"
        favorite_team: "$.get('favorite_team')"
        image_queries: "$.get('image_queries', [])"
      outputs:
        image_prompt: "$.get('image_prompt', '')"

    # create-background-image
    - type: connector
      name: create-background-image
      description: "Create the background image using Gemini based on the generated description."
      condition: "$.get('image_prompt') is not None"
      connector:
        name: "google-genai"
        command: "invoke_image"
      inputs:
        image_queries: "$.get('image_queries', [])"
        image_paths: "$.get('reference_images', [])"
        model_name: "'gemini-2.5-flash-image-preview'"
        prompt: |
          "ASPECT RATIO REQUIREMENT: The image MUST be exactly 16:9 aspect ratio (1920x1080 pixels). This is MANDATORY and NON-NEGOTIABLE. Create a MARVEL/DC COMIC BOOK COVER STYLE visual composition suitable for podcast headers. CONTEXT This image is for a podcast about {{favorite_sport}} tailored for fans of {{favorite_team}}. Reference images have been provided based on these queries {{image_queries}}. REFERENCE IMAGE REQUIREMENTS - Use the provided reference images exactly as they are - DO NOT change, modify, alter, or recreate them. Especially preserve team logos exactly as they appear in the reference images.\n- Combine the multiple reference images into a single cohesive image. Keep all key subjects recognizable and maintain their proportions and details. Blend the images naturally with consistent lighting, shadows, perspective, and style.\n- Integrate the reference images seamlessly into the composition so they feel like natural, integral parts of the design.\n- The reference images may include team logos, stadiums, mascots, and other team-related visual elements - incorporate all of these without modification. CRITICAL REQUIREMENTS - ABSOLUTELY NO text, words, letters, numbers, typography, or written elements anywhere in the image\n- ABSOLUTELY NO player names, player references, or individual athletes\n- Reference images must be prominently visible and seamlessly integrated\n- Only incorporate visual elements that correspond to the provided reference images DESIGN STYLE Create a Marvel/DC comic book cover style illustration. Bold, dynamic, and action-oriented composition with dramatic superhero comic book aesthetics. The style should evoke iconic comic book covers from Marvel and DC Comics - powerful, vibrant, and visually striking. Use dramatic angles and dynamic perspectives typical of comic book covers. COLOR PALETTE Use bold, vibrant, saturated colors typical of comic book covers. Strong contrast between light and shadow. Integrate {{favorite_team}}s primary and secondary team colors throughout the composition in bold, dramatic ways. Extract team colors from the reference images and use them prominently. Use deep shadows and bright highlights to create dramatic depth and impact. The color palette should be bold and eye-catching like Marvel/DC comic book covers. COMPOSITION Create a dynamic, action-oriented comic book cover composition. Integrate the reference images seamlessly - they should appear as powerful, iconic elements in the overall design. Use dramatic angles, dynamic perspectives, and bold visual hierarchy typical of superhero comic book covers. Create depth through dramatic layering and bold perspective. The composition should feel powerful, energetic, and iconic like a Marvel or DC comic book cover. VISUAL EFFECTS Apply bold, dramatic lighting typical of comic book covers. Use strong contrast between light and shadow. Apply comic book style rendering - bold lines, vibrant colors, dramatic effects. Include dynamic motion lines and energy effects if appropriate. Use dramatic lighting effects: strong highlights, deep shadows, dramatic rim lighting. The reference images should remain recognizable while being rendered in comic book cover style. The final image should feel powerful, dynamic, and iconic like a superhero comic book cover. Maintain comic book illustration style with bold, dramatic qualities. FINAL REQUIREMENT: The image MUST be exactly 16:9 aspect ratio (1920x1080 pixels). This is MANDATORY. The output image dimensions must be 1920 pixels wide by 1080 pixels tall."
      outputs:
        data: "$"
        image_path: "$.get('image_path')"

    # upload image to google storage
    - type: connector
      name: upload-image-to-google-storage
      description: Upload the image to Google Storage.
      condition: $.get('image_path') is not None
      connector:
        name: google-storage
        command: invoke_upload
      inputs:
        api_key: $.get('api_key')
        image_path: $.get('image_path')
      outputs:
        uploaded_image_path: "$.get('url')"

    # version-control-update
    - type: document
      name: version-control-update
      description: Update the user profile document version control.
      condition: $.get('document-exists') is True
      config:
        action: update
        embed-vector: false
        force-update: true
      filters:
        document_id: $.get('document_id')
      documents:
        user-profile: |
          {
            **$.get('document-value', {}),
            "audio_content": $.get('audio_content'),
            "image_path": $.get('uploaded_image_path'),
          }
      