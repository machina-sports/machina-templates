workflow:
  name: bundesliga-podcast-generate-image
  title: Bundesliga Podcast Generate Image
  description: Workflow to generate Bundesliga podcast image based on user profile stored in documents and web search results
  context-variables:
    debugger:
      enabled: true
    google-genai:
      credential: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL
      project_id: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID
      api_key: $TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY
    google-storage:
      api_key: $TEMP_CONTEXT_VARIABLE_GOOGLE_STORAGE_API_KEY
      bucket_name: $TEMP_CONTEXT_VARIABLE_GOOGLE_STORAGE_BUCKET_NAME
    machina-ai:
      api_key: $TEMP_CONTEXT_VARIABLE_SDK_OPENAI_API_KEY
    oxylabs:
      username: $TEMP_CONTEXT_VARIABLE_OXYLABS_USERNAME
      password: $TEMP_CONTEXT_VARIABLE_OXYLABS_PASSWORD
  inputs:
    canvas_image_url: $.get('canvas_image_url', 'https://storage.googleapis.com/machina-templates-bucket-default/static/newsletters-templates/template-bundesliga-16-9.png')
    document_id: $.get('document_id')
    geo_location: $.get('geo_location', 'Brazil')
    limit: $.get('limit', 10)
    parser: ($.get('parser', 'true') == 'true') and True or False
    query: $.get('query')
    source: $.get('source', 'google_search')
    udm: int($.get('udm', 2))
  outputs:
    workflow-status: "'executed'"
  tasks:

    # Load user profile from documents
    - type: document
      name: load-user-profile
      description: "Load user profile from documents by email address"
      condition: "$.get('document_id') is not None"
      config:
        action: "search"
        search-limit: 1
        search-vector: false
      connector:
        name: "machina-ai"
        command: "invoke_embedding"
        model: "text-embedding-3-small"
      filters:
        document_id: $.get('document_id')
      inputs:
        name: "'user-profile'"
      outputs:
        document-exists: len($.get('documents', [])) > 0
        document-value: "$.get('documents', [])[0].get('value', {}) if len($.get('documents', [])) > 0 else {}"
        favorite_sport: "$.get('documents', [])[0].get('value', {}).get('favorite_sport') if len($.get('documents', [])) > 0 else None"
        favorite_team: "$.get('documents', [])[0].get('value', {}).get('favorite_team') if len($.get('documents', [])) > 0 else None"
        audio_content: "$.get('documents', [])[0].get('value', {}).get('audio_content') if len($.get('documents', [])) > 0 else None"
  
    # bundesliga-podcast-generate-image-queries
    - type: prompt
      name: bundesliga-podcast-generate-image-queries
      description: Generate image queries based on user's favorite sport and team.
      condition: $.get('document_id') is not None and $.get('document-exists') is True
      connector:
        command: invoke_prompt
        name: google-genai
        model: gemini-2.5-flash
        location: global
        provider: vertex_ai
      inputs:
        audio_content: $.get('audio_content')
        favorite_sport: $.get('favorite_sport')
        favorite_team: $.get('favorite_team')
      outputs:
        image_queries: "$.get('image_queries', [])"

    # oxylabs-post-queries
    - type: connector
      name: oxylabs-post-queries
      description: Search for images.
      condition: len($.get('image_queries', [])) > 0
      connector:
        name: oxylabs
        command: post-queries
      continue_on_error: true
      foreach:
        name: image_query
        expr: $
        value: $.get('image_queries', [])
      inputs:
        body: |
          {
            "context": [
              {
                "key": "udm",
                "value": $.get('udm')
              },
              {
                "key": "limit_per_page",
                "value": [
                  {
                    "page": 1,
                    "limit": $.get('limit')
                  }
                ]
              }
            ],
            "geo_location": $.get('geo_location'),
            "parse": $.get('parser'),
            "query": str($.get('image_query', '')),
            "source": $.get('source'),
          }
      outputs:
        image_urls: $.get('results', [])[0].get('content').get('results', {}).get('organic', [])[:1] if $.get('results', [])[0].get('content') else []

    # save-to-tmp
    - type: connector
      name: temp-bundesliga-podcast-logo-downloader
      description: Save the image to tmp.
      condition: len($.get('image_urls', [])) > 0
      connector:
        name: temp-downloader
        command: invoke_save_to_tmp
      foreach:
        name: image-item
        expr: $
        value: $.get('image_urls', [])
      inputs:
        image_base64: $.get('image-item', {}).get('image', '')
      outputs:
        reference_images: |
          [
            $.get('image_path')
          ]


    # create-background-image
    - type: connector
      name: create-background-image
      description: "Create the background image using Gemini based on the generated description."
      condition: "$.get('reference_images') is not None and len($.get('reference_images', [])) > 0"
      connector:
        name: "google-genai"
        command: "invoke_image"
      inputs:
        aspect_ratio: "16:9"
        canvas_image_url: "$.get('canvas_image_url')"
        favorite_sport: "$.get('favorite_sport')"
        favorite_team: "$.get('favorite_team')"
        image_queries: "$.get('image_queries', [])"
        image_paths: "[$.get('canvas_image_url')] + $.get('reference_images', [])"
        model_name: "'gemini-2.5-flash-image-preview'"
        prompt: |
          "=== IMAGE GENERATION CONFIGURATION ===\n\nCANVAS IMAGE REQUIREMENTS:\n- The FIRST image provided is the CANVAS/TEMPLATE image\n- You MUST use the exact dimensions (width and height) of the canvas image\n- The output image MUST match the canvas image size EXACTLY\n- The canvas image defines the aspect ratio and dimensions for the final output\n- This is MANDATORY and NON-NEGOTIABLE\n\nOUTPUT REQUIREMENTS:\n- Dimensions: Match the canvas image dimensions EXACTLY\n- Aspect Ratio: Match the canvas image aspect ratio EXACTLY\n- Orientation: Match the canvas image orientation\n- Status: MANDATORY and NON-NEGOTIABLE\n\nCONTEXT:\n- Sport: {{favorite_sport}}\n- Team: {{favorite_team}}\n- Image Queries: {{image_queries}}\n\nREFERENCE IMAGE GUIDELINES:\n- Use reference images (images after the canvas) exactly as provided\n- DO NOT change, modify, alter, or recreate reference images\n- Combine multiple reference images into single cohesive image\n- Maintain proportions and details of all key subjects\n- Seamless integration required\n- The canvas image is ONLY for sizing - do not include its visual content in the output\n\nPROHIBITED ELEMENTS:\n- Text, words, letters, numbers, typography\n- Written elements of any kind\n- Player names or player references\n- Individual athletes\n- Logos or emblems (DO NOT add any logos or emblems to the image)\n\nREQUIRED ELEMENTS:\n- Reference images must be prominently visible\n- Reference images must be seamlessly integrated\n- Output must match canvas image dimensions exactly\n\nDESIGN STYLE:\n- Type: Marvel/DC comic book cover style\n- Characteristics: Bold, dynamic, action-oriented, dramatic, powerful, vibrant, visually striking\n- Use dramatic angles and dynamic perspectives\n\nCOLOR PALETTE:\n- Style: Comic book cover colors\n- Characteristics: Bold, vibrant, saturated, strong contrast, deep shadows, bright highlights\n- Team Colors: Extract from reference images and use prominently\n\nCOMPOSITION:\n- Orientation: Match canvas image orientation\n- Style: Dynamic action-oriented\n- Characteristics: Dramatic angles, dynamic perspectives, bold visual hierarchy, dramatic layering, bold perspective\n\nVISUAL EFFECTS:\n- Lighting: Bold and dramatic\n- Rendering: Comic book style\n- Characteristics: Bold lines, vibrant colors, dramatic effects, motion lines, energy effects, strong highlights, deep shadows, dramatic rim lighting\n\n=== INSTRUCTIONS ===\n\nCRITICAL: Follow these configuration parameters EXACTLY.\n\nThe FIRST image provided is the CANVAS/TEMPLATE image. You MUST:\n1. Analyze the canvas image dimensions (width and height)\n2. Generate the output image with EXACTLY the same dimensions as the canvas image\n3. Match the aspect ratio of the canvas image precisely\n4. DO NOT include any visual elements from the canvas image itself - it is ONLY for sizing reference\n\nThe output image MUST match the canvas image dimensions EXACTLY. This is MANDATORY and NON-NEGOTIABLE.\n\nCreate a MARVEL/DC COMIC BOOK COVER STYLE visual composition suitable for podcast headers.\nUse the provided reference images (all images after the canvas) exactly as they are - DO NOT change, modify, alter, or recreate them.\nCombine the multiple reference images into a single cohesive image that matches the canvas dimensions.\nKeep all key subjects recognizable and maintain their proportions and details.\nBlend the images naturally with consistent lighting, shadows, perspective, and style.\nIntegrate the reference images seamlessly into the composition so they feel like natural, integral parts of the design.\n\nABSOLUTELY NO text, words, letters, team logos, numbers, typography, or written elements anywhere in the image.\nABSOLUTELY NO player names, player references, or individual athletes.\nABSOLUTELY NO logos or emblems - DO NOT add any logos or emblems to the final image.\nExtract team colors from the reference images and use them prominently in bold, dramatic ways.\n\nThe final image MUST match the canvas image dimensions EXACTLY. This is MANDATORY."
      outputs:
        data: "$"
        image_path: "$.get('image_path')"

    # upload image to google storage
    - type: connector
      name: upload-image-to-google-storage
      description: Upload the image to Google Storage.
      condition: $.get('image_path') is not None
      connector:
        name: google-storage
        command: invoke_upload
      inputs:
        api_key: $.get('api_key')
        image_path: $.get('image_path')
      outputs:
        uploaded_image_path: "$.get('url')"

    # version-control-update
    - type: document
      name: version-control-update
      description: Update the user profile document version control.
      condition: $.get('document-exists') is True
      config:
        action: update
        embed-vector: false
        force-update: true
      filters:
        document_id: $.get('document_id')
      documents:
        user-profile: |
          {
            **$.get('document-value', {}),
            "audio_content": $.get('audio_content'),
            "image_path": $.get('uploaded_image_path'),
          }
      