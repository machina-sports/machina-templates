workflow:
  name: bundesliga-podcast-compose-template
  title: Bundesliga Podcast Compose Template
  description: Workflow to compose Bundesliga podcast template based on user profile stored in documents
  context-variables:
    api-mailgun:
      username: "api"
      password: "$TEMP_CONTEXT_VARIABLE_MAILGUN_API_KEY"
    debugger:
      enabled: true
    elevenlabs:
      api_key: "$TEMP_CONTEXT_VARIABLE_ELEVENLABS_API_KEY"
    google-genai:
      credential: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL"
      project_id: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID"
      api_key: "$TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY"
    machina-ai:
      api_key: "$TEMP_CONTEXT_VARIABLE_SDK_OPENAI_API_KEY"
    storage:
      api_key: "$TEMP_CONTEXT_VARIABLE_AZURE_BLOB_STRING"
  inputs:
    document_id: "$.get('document_id')"
    template_path: "$.get('template_path', 'https://storage.googleapis.com/machina-templates-bucket-default/static/newsletters-templates/template-podcast-bundesliga.html')"
  outputs:
    workflow-status: "'executed'"
  tasks:

    # Load user profile from documents
    - type: document
      name: load-user-profile
      description: "Load user profile from documents by email address"
      condition: "$.get('document_id') is not None"
      config:
        action: "search"
        search-limit: 1
        search-vector: false
      connector:
        name: "machina-ai"
        command: "invoke_embedding"
        model: "text-embedding-3-small"
      filters:
        document_id: $.get('document_id')
      inputs:
        name: "'user-profile'"
      outputs:
        document-exists: len($.get('documents', [])) > 0
        document-value: "$.get('documents', [])[0].get('value', {}) if len($.get('documents', [])) > 0 else {}"
        audio_content: "$.get('documents', [])[0].get('value', {}).get('audio_content') if len($.get('documents', [])) > 0 else None"
        audio_path: "$.get('documents', [])[0].get('value', {}).get('audio_path') if len($.get('documents', [])) > 0 else None"
        image_path: "$.get('documents', [])[0].get('value', {}).get('image_path') if len($.get('documents', [])) > 0 else None"
        duration: "$.get('documents', [])[0].get('value', {}).get('duration') if len($.get('documents', [])) > 0 else None"
        email_address: "$.get('documents', [])[0].get('value', {}).get('email_address') if len($.get('documents', [])) > 0 else None"
        favorite_sport: "$.get('documents', [])[0].get('value', {}).get('favorite_sport') if len($.get('documents', [])) > 0 else None"
        favorite_team: "$.get('documents', [])[0].get('value', {}).get('favorite_team') if len($.get('documents', [])) > 0 else None"
        language: "$.get('documents', [])[0].get('value', {}).get('language') if len($.get('documents', [])) > 0 else None"
        podcast_mood_tone: "$.get('documents', [])[0].get('value', {}).get('podcast_mood_tone') if len($.get('documents', [])) > 0 else None"
        sports_knowledge: "$.get('documents', [])[0].get('value', {}).get('sports_knowledge') if len($.get('documents', [])) > 0 else None"
        user_name: "$.get('documents', [])[0].get('value', {}).get('name') if len($.get('documents', [])) > 0 else None"

    # download the newsletter template
    - type: connector
      name: download the newsletter template
      description: Download the newsletter template.
      connector:
        name: temp-downloader
        command: invoke_download
      inputs:
        image_url: $.get('template_path')
      outputs:
        temp_newsletter_template_path: $.get('temp_path')

    # compose podcast email HTML
    - type: connector
      name: compose-podcast-email
      description: "Compose HTML email template for podcast"
      condition: "$.get('audio_path') is not None"
      connector:
        name: "bundesliga-podcast-compose"
        command: "invoke_compose"
      inputs:
        audio_url: "$.get('audio_path')"
        document_id: "$.get('document_id')"
        podcast_base_url: "$.get('podcast_base_url', 'https://podcast.machina.gg')"
        favorite_sport: "$.get('favorite_sport')"
        favorite_team: "$.get('favorite_team')"
        image_path: "$.get('image_path', '')"
        language: "$.get('language')"
        podcast_duration: "$.get('duration')"
        podcast_mood_tone: "$.get('podcast_mood_tone')"
        sports_knowledge: "$.get('sports_knowledge')"
        template_path: "$.get('temp_newsletter_template_path')"
        user_name: "$.get('user_name')"
      outputs:
        podcast-email-html-content: "$.get('html_content')"

    # send podcast email via Mailgun
    - type: connector
      name: send-podcast-email
      description: "Send HTML email with podcast using Mailgun"
      condition: "$.get('podcast-email-html-content') is not None and ($.get('email_address') is not None or $.get('profile_email_address') is not None)"
      connector:
        name: "api-mailgun"
        command: "post-{domain}/messages"
        command_attribute:
          domain: "$.get('mailgun_domain') or 'mg.machina.gg'"
      inputs:
        body: |
          {
            "from": $.get('from_email', 'noreply@mg.machina.gg'), 
            "to": $.get('email_address'),
            "subject": "Your Personalized Podcast is Ready!",
            "html": $.get('podcast-email-html-content'),
            "text": "Your personalized podcast is ready! Click the link in the email to listen."
          }
      outputs:
        email-sent: "$.get('message') is not None"
        email-status: "$.get('message')"
        email-id: "$.get('id')"
    
    # version-control-update
    - type: document
      name: version-control-update
      description: Update the user profile document version control.
      condition: $.get('document-exists') is True
      config:
        action: update
        embed-vector: false
        force-update: true
      filters:
        document_id: $.get('document_id')
      documents:
        user-profile: |
          {
            **$.get('document-value', {}),
            "html-content": $.get('podcast-email-html-content'),
          }