workflow:
  name: soccer-power-ranking-calculate-team-metrics
  title: Calculate Team Metrics
  description: |
    Calculate raw performance metrics for a single team based on their last N fixtures.
    Uses local fixture documents (requires sync first via sync-league-fixtures workflow).
  context-variables:
    debugger:
      enabled: true
  inputs:
    team_id: "$.get('team_id')"
    team_name: "$.get('team_name', '')"
    team_logo: "$.get('team_logo')"
    league_id: "$.get('league_id', '71')"
    season: "$.get('season') if $.get('season') else ($.get('date')[:4] if $.get('date') else None)"
    date: "$.get('date')"
    last_matches: "$.get('last_matches', 10)"
  outputs:
    team_metrics: "$.get('team_metrics', {})"
    workflow-status: "'executed'"
  tasks:

    # 1. Search fixtures for this team (home OR away), filtered by date, limited to last N
    - type: document
      name: search-team-fixtures
      description: Search team fixtures up to date, sorted desc, limited to last_matches
      config:
        action: search
        search-limit: "$.get('last_matches', 10)"
        search-sorters: ["metadata.date", -1]
      filters:
        name: "'league-fixture'"
        metadata.league_id: "str($.get('league_id'))"
        metadata.status: "'FT'"
        metadata.date: "{'$lte': $.get('date')} if $.get('date') else None"
        '$or': "[{'metadata.team_home_id': str($.get('team_id'))}, {'metadata.team_away_id': str($.get('team_id'))}]"
      outputs:
        fixtures: |
          [
            {
              'fixture': doc.get('value', {}).get('fixture', {}),
              'teams': doc.get('value', {}).get('teams', {}),
              'goals': doc.get('value', {}).get('goals', {}),
              'score': doc.get('value', {}).get('score', {}),
              'league': doc.get('value', {}).get('league', {})
            }
            for doc in $.get('documents', [])
          ]
        fixtures_count: "len($.get('documents', []))"

    # 2. Calculate metrics for this team
    - type: connector
      name: calculate-metrics
      description: Calculate raw metrics for this team (without normalization)
      condition: "$.get('fixtures_count', 0) > 0"
      connector:
        name: soccer-power-ranking-calculator
        command: calculate_team_metrics
      inputs:
        fixtures: "$.get('fixtures', [])"
        team_id: "$.get('team_id')"
        team_name: "$.get('team_name')"
        team_logo: "$.get('team_logo')"
        last_matches: "$.get('last_matches')"
      outputs:
        team_metrics: "$.get('team_metrics', {})"

    # 3. Save team metrics document
    - type: document
      name: save-team-metrics
      description: Save individual team metrics for later aggregation
      condition: "$.get('team_metrics') is not None and $.get('team_metrics', {}).get('games', 0) > 0"
      config:
        action: save
        embed-vector: false
      documents:
        team-progressive-metrics: |
          {
            "title": f"Team Metrics - {$.get('team_name', 'Unknown')} - Last {$.get('last_matches')} matches" + (f" (up to {$.get('date')})" if $.get('date') else ""),
            "team_metrics": $.get('team_metrics', {}),
            "league_id": $.get('league_id'),
            "season": $.get('season'),
            "date": $.get('date'),
            "last_matches": $.get('last_matches'),
            "updated_at": datetime.utcnow()
          }
      metadata:
        document_type: "'team-progressive-metrics'"
        team_id: "str($.get('team_id'))"
        team_name: "$.get('team_name', '')"
        league_id: "str($.get('league_id'))"
        season: "str($.get('season')) if $.get('season') else 'all'"
        date: "str($.get('date')) if $.get('date') else 'latest'"
        last_matches: "str($.get('last_matches'))"
