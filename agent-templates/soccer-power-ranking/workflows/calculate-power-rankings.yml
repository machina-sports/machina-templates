workflow:
  name: soccer-power-ranking-calculate-rankings
  title: Calculate Power Rankings
  description: Calculate team power rankings based on performance metrics
  inputs:
    league_id: "$.get('league_id', '71')"
    season: "$.get('season', '2025')"
  outputs:
    rankings: "$.get('rankings', [])"
    workflow-status: "'executed'"
  tasks:
    # 1. Load team statistics
    - type: document
      name: load-team-statistics
      config:
        action: search
        search-limit: 100
        search-vector: false
      filters:
        name: "'teams-statistics'"
        metadata.league_id: "str($.get('league_id'))"
        metadata.season: "str($.get('season'))"
      outputs:
        teams_stats: "$.get('documents', [])"
        teams_count: "len($.get('documents', []))"

    # 2. Load teams info (with logos)
    - type: document
      name: load-teams-info
      config:
        action: search
        search-limit: 1
        search-vector: false
      filters:
        name: "'teams-info'"
        metadata.league_id: "str($.get('league_id'))"
        metadata.season: "str($.get('season'))"
      outputs:
        teams_info: "$.get('documents', [{}])[0].get('value', {}).get('teams', []) if len($.get('documents', [])) > 0 else []"

    # 3. Calculate power rankings using Python
    - type: connector
      name: calculate-rankings
      condition: "$.get('teams_count', 0) > 0"
      connector:
        name: soccer-power-ranking-calculator
        command: calculate_power_rankings
      inputs:
        teams_stats: "$.get('teams_stats', [])"
        teams_info: "$.get('teams_info', [])"
        league_id: "$.get('league_id')"
        season: "$.get('season')"
      outputs:
        rankings: "$.get('rankings', [])"
        league_stats: "$.get('league_stats', {})"

    # 4. Store calculated rankings
    - type: document
      name: store-power-rankings
      condition: "len($.get('rankings', [])) > 0"
      config:
        action: save
        embed-vector: false
      documents:
        power-rankings: |
          {
            "title": f"Power Rankings - League {$.get('league_id')} - {$.get('season')}",
            "league_id": $.get('league_id'),
            "season": $.get('season'),
            "updated": datetime.utcnow(),
            "rankings": $.get('rankings', []),
            "stats": $.get('league_stats', {}),
            "status": "active"
          }
      metadata:
        league_id: "str($.get('league_id'))"
        season: "str($.get('season'))"
        document_type: "'power-rankings'"
        teams_count: "len($.get('rankings', []))"

