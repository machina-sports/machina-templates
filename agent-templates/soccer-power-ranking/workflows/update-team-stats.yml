workflow:
  name: soccer-power-ranking-update-stats
  title: Update Team Stats
  description: Update team statistics for power ranking calculation for a specific league
  context-variables:
    debugger:
      enabled: true
    api-football:
      x-apisports-key: "$TEMP_CONTEXT_VARIABLE_API_FOOTBALL_API_KEY"
  inputs:
    league_id: "$.get('league_id', '71')"
    season: "$.get('season', '2025')"
  outputs:
    workflow-status: "'executed'"
    status: "'updated'"
    total_teams_updated: "len($.get('team_ids', []))"
  tasks:

    # Get teams from API Football
    - type: connector
      name: api-football-get-teams
      description: Get all teams from the specified league
      connector:
        name: api-football
        command: get-teams
      inputs:
        league: "$.get('league_id')"
        season: "$.get('season')"
      outputs:
        team_ids: |
          [
            team.get('team', {}).get('id')
            for team in $.get('response', [])
            if team.get('team', {}).get('id')
          ]
        teams_info: |
          [
            {
              'team_id': str(team.get('team', {}).get('id')),
              'team_name': team.get('team', {}).get('name'),
              'team_logo': team.get('team', {}).get('logo'),
              'team_code': team.get('team', {}).get('code'),
              'team_country': team.get('team', {}).get('country'),
              'venue_name': team.get('venue', {}).get('name'),
              'venue_city': team.get('venue', {}).get('city')
            }
            for team in $.get('response', [])
            if team.get('team', {}).get('id')
          ]

    # Save teams info (with logos)
    - type: document
      name: save-teams-info
      description: Save teams info including logos for the league
      condition: "len($.get('teams_info', [])) > 0"
      config:
        action: save
        embed-vector: false
      documents:
        teams-info: |
          {
            'title': f"Teams Info - League {$.get('league_id')} - {$.get('season')}",
            'league_id': $.get('league_id'),
            'season': $.get('season'),
            'teams': $.get('teams_info', []),
            'updated': datetime.utcnow()
          }
      metadata:
        league_id: "str($.get('league_id'))"
        season: "str($.get('season'))"
        document_type: "'teams-info'"

    # Get statistics for all teams
    - type: connector
      name: get-team-statistics
      description: Get team statistics from API Football for each team
      condition: "len($.get('team_ids', [])) > 0"
      connector:
        name: api-football
        command: get-teams/statistics
      foreach:
        name: team_id
        expr: $
        value: $.get('team_ids', [])
      inputs:
        league: "$.get('league_id')"
        team: "$.get('team_id')"
        season: "$.get('season')"
      outputs:
        teams_stats_list: |
          [
            {
              'data': $.get('response', {}),
              'title': f"{$.get('response', {}).get('league', {}).get('name', 'Unknown')} - {$.get('response', {}).get('team', {}).get('name', 'Unknown')} - {$.get('response', {}).get('league', {}).get('season', 'Unknown')}",
              'execution': datetime.utcnow(),
              'status': 'active',
              'parameters': {
                'league': $.get('response', {}).get('league', {}).get('id'),
                'team': $.get('response', {}).get('team', {}).get('id'),
                'season': $.get('response', {}).get('league', {}).get('season')
              },
              'metadata': {
                'document_type': 'team-statistics',
                'team_id': str($.get('response', {}).get('team', {}).get('id', '')),
                'league_id': str($.get('response', {}).get('league', {}).get('id', '')),
                'season': str($.get('response', {}).get('league', {}).get('season', '')),
                'team_name': $.get('response', {}).get('team', {}).get('name', 'Unknown'),
                'league_name': $.get('response', {}).get('league', {}).get('name', 'Unknown')
              }
            }
          ]

    # Bulk save all team statistics
    - type: document
      name: bulk-save-team-statistics
      description: Save all team statistics in bulk
      condition: "len($.get('teams_stats_list', [])) > 0"
      config:
        action: bulk-update
        embed-vector: false
        force-update: true
      document_name: "'teams-statistics'"
      documents:
        items: "$.get('teams_stats_list', [])"

