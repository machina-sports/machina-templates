agent:
  name: soccer-power-ranking-progressive
  title: Soccer Power Ranking Progressive Calculator
  description: |
    Agent that calculates progressive power rankings for soccer teams.
    
    Requires: Sync fixtures first using soccer-power-ranking-sync-fixtures agent.
    
    Orchestrates:
    1. Get teams from the league
    2. Calculate metrics for each team (foreach on local fixtures)
    3. Aggregate and normalize rankings
    
    Parameters:
    - league_id: League ID (required)
    - season: Season year (optional)
    - date: Reference date "YYYY-MM-DD" (optional - filters fixtures up to this date)
    - last_matches: Number of last matches to consider (default: 10)
  context:
    status: "inactive"
  context-agent:
    league_id: $.get('league_id', '71')
    season: $.get('season')
    date: $.get('date')
    last_matches: $.get('last_matches', 10)
  workflows:

    # 1) Get all teams from the league
    - name: soccer-power-ranking-get-league-teams
      description: Fetch all teams from the specified league
      inputs:
        league: "$.get('league_id', '71')"
        season: "$.get('season') if $.get('season') else ($.get('date', '2025')[:4] if $.get('date') else '2025')"
      outputs:
        team_ids: "$.get('team_ids', [])"
        teams: "$.get('teams', [])"
        teams_info: |
          [
            {
              'team_id': str(team.get('team', {}).get('id')),
              'team_name': team.get('team', {}).get('name'),
              'team_logo': team.get('team', {}).get('logo')
            }
            for team in $.get('teams', [])
            if team.get('team', {}).get('id')
          ]

    # 2) Calculate metrics for each team (uses local fixtures)
    - name: soccer-power-ranking-calculate-team-metrics
      description: Calculate raw metrics for each team based on local fixtures
      foreach:
        name: team_info
        expr: $
        value: $.get('teams_info', [])
      inputs:
        team_id: "$.get('team_info', {}).get('team_id')"
        team_name: "$.get('team_info', {}).get('team_name')"
        team_logo: "$.get('team_info', {}).get('team_logo')"
        league_id: "$.get('league_id', '71')"
        season: "$.get('season')"
        date: "$.get('date')"
        last_matches: "$.get('last_matches', 10)"

    # 3) Aggregate and normalize rankings
    - name: soccer-power-ranking-aggregate-rankings
      description: Load all team metrics and calculate normalized power rankings
      inputs:
        league_id: "$.get('league_id', '71')"
        season: "$.get('season')"
        date: "$.get('date')"
        last_matches: "$.get('last_matches', 10)"
      outputs:
        rankings: "$.get('rankings', [])"
        league_stats: "$.get('league_stats', {})"
