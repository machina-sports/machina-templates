workflow:
  name: "analyze-market"
  title: "Analyze Market Series"
  description: "Fetches markets for a series and analyzes them using AI"
  
  context-variables:
    google-genai:
      credential: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL"
      project_id: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID"
      api_key: "$TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY"

  inputs:
    series_ticker: "$.get('series_ticker', 'KXHIGHNY')"
    limit: "$.get('limit', 10)"

  outputs:
    analysis: "$.get('analysis')"
    market_count: "len($.get('markets', []))"

  tasks:
    # 1. Fetch Market Data
    - type: "connector"
      name: "fetch-markets"
      description: "Get active markets for the series"
      condition: "$.get('series_ticker') is not None"
      connector:
        name: "kalshi"
        command: "get_markets"
      inputs:
        series_ticker: "$.get('series_ticker')"
        limit: "$.get('limit')"
        status: "open"
      outputs:
        markets: "$.get('data', {}).get('markets', []) if $.get('status') == True else ($.get('markets', []) if 'markets' in $ else [])"
        markets_json: "json.dumps($.get('data', {}).get('markets', []), indent=2) if $.get('status') == True else json.dumps($.get('markets', []), indent=2)"
        user_message: "'Analyze the following market data for the series \"' + str($.get('series_ticker')) + '\":\\n\\n' + (json.dumps($.get('data', {}).get('markets', []), indent=2) if $.get('status') == True else json.dumps($.get('markets', []), indent=2)) + '\\n\\nProvide a summary of the most significant opportunities or insights.'"

    # 2. Analyze with LLM
    - type: "prompt"
      name: "generate-analysis"
      description: "Analyze the market data using AI"
      condition: "$.get('markets') is not None and len($.get('markets', [])) > 0"
      connector:
        name: "google-genai"
        command: "invoke_prompt"
        model: "gemini-3-pro-preview"
        location: "global"
        provider: "vertex_ai"
      inputs:
        messages:
          - role: "system"
            content: "You are an expert prediction market analyst. Your goal is to analyze market data from Kalshi to provide clear, actionable insights. Focus on: 1. Implied Probabilities: Calculate the implied probability from the Yes and No prices. 2. Volume Analysis: Identify where the money is flowing. 3. Market Sentiment: Identify specific events that the market is favoring. 4. Anomalies: Any unusual pricing or volume patterns. Output your analysis in a concise markdown format."
          - role: "user"
            content: "$.get('user_message', '')"
      outputs:
        analysis: "$.get('content')"
