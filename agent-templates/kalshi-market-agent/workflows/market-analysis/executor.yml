workflow:
  name: kalshi-market-analysis-executor
  title: Kalshi - Market Analysis Executor
  description: Workflow to execute a market analysis.
  context-variables:
    debugger:
      enabled: true
    google-genai:
      credential: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL
      project_id: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID
      api_key: $TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY
    machina-ai:
      api_key: $TEMP_CONTEXT_VARIABLE_SDK_OPENAI_API_KEY
  inputs:
    document_id: $.get('document_id')
  outputs:
    workflow-status: $.get('document-exists') is not True and 'skipped' or 'executed'
  tasks:

    # load-event-by-code
    - type: document
      name: kalshi-prediction-load-by-id
      description: Load document by id
      condition: $.get('document_id') is not None
      config:
        action: search
        search-limit: 1
        search-vector: false
        search-sorters: ["value.start_time", 1]
      filters:
        document_id: $.get('document_id')
      outputs:
        document-document_id: $.get('documents')[0].get('_id', '') if $.get('documents') else None
        document-exists: len($.get('documents', [])) > 0
        document-selected: $.get('documents', [])[0] if len($.get('documents', [])) > 0 else None
        document-value: $.get('documents', [])[0].get('value', {}) if len($.get('documents', [])) > 0 else None
        event_code: $.get('documents')[0].get('metadata', {}).get('event_code') if $.get('documents') else None
        competition_name: $.get('documents')[0].get('value', {}).get('sport:competition', {}).get('name', 'Unknown Competition') if $.get('documents') else 'Unknown Competition'
        event_competititors: |
          [
            competitor.get('@id')
            for competitor in $.get('documents', [])[0].get('value', {}).get('sport:competitors', [])
          ]

    # load event filtering by competitor
    - type: document
      name: load-event-by-competitor
      description: Search for events by competitor in the same competition.
      condition: $.get('document-exists') is True
      config:
        action: search
        search-limit: 12
        search-vector: false
        search-sorters: ["value.schema:startDate", -1]
      filters:
        value.sport:competitors.@id: "{'$in': $.get('event_competititors')}"
        value.sport:status: "{'$in': ['closed', 'ended', 'FT']}"
      inputs:
        name: "{'$in': ['sport:Event']}"
      outputs:
        event_exists: len($.get('documents', [])) > 0
        event_list: $.get('documents', []) if $.get('documents') else None
        event_list_ids: |
          [
            event.get('value', {}).get('@id').replace('urn:sportradar:sport_event:', '')
            for event in $.get('documents', [])
          ]
        event_list_parsed: |
          [
            {
              **event.get('value', {}),
            }
            for event in $.get('documents', [])
          ]

    # iptc-mapping-past-events
    - type: mapping
      name: kalshi-past-events-formatter
      condition: $.get('document_id') is not None and $.get('document-exists') is True
      inputs:
        events: $.get('event_list_parsed')
      outputs:
        past_events_ids: $.get('events_ids')
        past_events_summary: $.get('events_summary')

    # load-kalshi-events-by-past-event-codes
    - type: document
      name: load-kalshi-events-by-event-codes
      description: Load kalshi-events that reference the past events by eventCode.
      condition: $.get('past_events_ids') is not None and len($.get('past_events_ids', [])) > 0
      config:
        action: search
        search-limit: 100
        search-vector: false
        search-sorters: ["updated", -1]
      filters:
        value.eventCode: "{'$in': [$.get('event_code')]}"
      inputs:
        name: "'kalshi-events'"
      outputs:
        kalshi_events: $.get('documents', [])
        kalshi_events_count: len($.get('documents', []))
        kalshi_events_exists: len($.get('documents', [])) > 0
        event_ticker: $.get('documents', [])[0].get('metadata', {}).get('id') if $.get('documents') else None

    # 1 load-markets
    - type: connector
      name: load-markets
      description: Get markets from Kalshi API
      condition: $.get('event_ticker') is not None
      connector:
        name: kalshi
        command: get-markets
      inputs:
        event_ticker: $.get('event_ticker')
      outputs:
        cursor: $.get('cursor', 0)
        markets: $.get('markets', [])

    # mapping-markets-summary
    - type: mapping
      name: kalshi-markets-summary
      description: Seleciona campos principais dos markets.
      condition: $.get('markets') is not None and len($.get('markets', [])) > 0
      inputs:
        markets: $.get('markets')
      outputs:
        markets_summary: $.get('markets_summary')
        markets_selected: $.get('markets_selected')
        markets_tickers: $.get('markets_tickers')
        markets_count: $.get('markets_count')

    ## CONTENT STORIES FROM PAST EVENTS

    # kalshi-market-analysis-prompt
    - type: prompt
      name: kalshi-market-analysis-prompt
      description: Kalshi Market Analysis Prompt
      condition: $.get('markets_count') is not None and $.get('markets_count') > 0
      connector:
        command: invoke_prompt
        name: google-genai
        model: gemini-3-pro-preview
        location: global
        provider: vertex_ai
      inputs:
        competition_name: $.get('competition_name')
        markets_summary: $.get('markets_summary')
        past_events_summary: $.get('past_events_summary')
      outputs:
        analysis: "$.get('analysis')"
        summary: "$.get('summary')"
        selected_market: "$.get('selected_market')"
        markets_ranked: "$.get('markets_ranked')"
        risk_flags: "$.get('risk_flags')"
        missing_data: "$.get('missing_data')"
        should_trade: "$.get('should_trade')"

    # kalshi-prediction-update
    - type: document
      name: kalshi-prediction-update
      description: Update the kalshi market analysis document.
      condition: $.get('analysis') is not None and $.get('summary') is not None
      config:
        action: update
        embed-vector: false
        force-update: true
      filters:
        metadata.eventCode: $.get('event_code')
      documents:
        kalshi-market-analysis: |
          {
            "title": f"Kalshi Market Analysis - {$.get('event_code') or $.get('event_ticker')}",
            "analysis": $.get('analysis'),
            "summary": $.get('summary'),
            "selected": $.get('selected_market'),
            "markets_ranked": $.get('markets_ranked'),
            "risk_flags": $.get('risk_flags'),
            "missing_data": $.get('missing_data'),
            "should_trade": $.get('should_trade')
          }
      metadata:
        eventCode: $.get('event_code')
        eventTicker: $.get('event_ticker')