workflow:
  name: "kalshi-sync-sports-markets"
  title: "Kalshi - Sync Sports Markets"
  description: "Workflow to synchronize sports-related market data from Kalshi API to Machina. Filters markets by sports keywords and category."
  context-variables:
    debugger:
      enabled: true
    machina-ai:
      api_key: "$TEMP_CONTEXT_VARIABLE_SDK_OPENAI_API_KEY"
  inputs:
    event_ticker: "$.get('event_ticker')"
    series_ticker: "$.get('series_ticker')"
    status: "$.get('status', 'open')"
    limit: "$.get('limit', 500)"
    cursor: "$.get('cursor')"
    force-update: "($.get('force-update') == 'true')"
  outputs:
    workflow-status: "$.get('workflow-status', 'skipped')"
    sports_markets_synced: "$.get('sports_markets_synced', 0)"
    total_markets_found: "$.get('total_markets_found', 0)"
  tasks:

    # 1 load-markets
    - type: "connector"
      name: "load-markets"
      description: "Get markets from Kalshi API"
      connector:
        name: "kalshi"
        command: "get_markets"
        command_attribute:
          limit: "$.get('limit')"
          cursor: "$.get('cursor')"
          event_ticker: "$.get('event_ticker')"
          series_ticker: "$.get('series_ticker')"
          status: "$.get('status')"
      outputs:
        market_data: "$.get('data', {}).get('markets', []) if $.get('status') == True else ($.get('markets', []) if 'markets' in $ else [])"
        next_cursor: "$.get('data', {}).get('cursor') if $.get('status') == True else $.get('cursor')"
        total_markets_found: "len($.get('data', {}).get('markets', [])) if $.get('status') == True else len($.get('markets', []))"
        workflow-status: "'executed'"

    # 2 filter-sports-markets
    - type: "mapping"
      name: "filter-sports-markets"
      title: "Filter Sports Markets"
      description: "Filter markets to only include sports-related ones based on keywords"
      condition: "$.get('market_data') is not None and len($.get('market_data', [])) > 0"
      inputs:
        markets: "$.get('market_data', [])"
      outputs:
        sports_markets: |
          [
            market
            for market in $.get('markets', [])
            if any(keyword in (market.get('title', '') + ' ' + market.get('subtitle', '')).lower()
              for keyword in ['sport', 'nfl', 'nba', 'mlb', 'nhl', 'soccer', 'football', 
                             'basketball', 'baseball', 'hockey', 'tennis', 'golf', 'boxing', 
                             'mma', 'ufc', 'nascar', 'f1', 'formula', 'racing', 'cricket', 
                             'rugby', 'olympics', 'olympic', 'game', 'match', 'team', 'player', 
                             'coach', 'draft', 'playoff', 'championship', 'super bowl', 
                             'world cup', 'stanley cup', 'world series', 'nba finals', 
                             'nfl playoffs', 'college football', 'college basketball', 'ncaa'])
            or market.get('category', '').lower() == 'sports'
          ]
        sports_markets_count: |
          len([
            market
            for market in $.get('markets', [])
            if any(keyword in (market.get('title', '') + ' ' + market.get('subtitle', '')).lower()
              for keyword in ['sport', 'nfl', 'nba', 'mlb', 'nhl', 'soccer', 'football', 
                             'basketball', 'baseball', 'hockey', 'tennis', 'golf', 'boxing', 
                             'mma', 'ufc', 'nascar', 'f1', 'formula', 'racing', 'cricket', 
                             'rugby', 'olympics', 'olympic', 'game', 'match', 'team', 'player', 
                             'coach', 'draft', 'playoff', 'championship', 'super bowl', 
                             'world cup', 'stanley cup', 'world series', 'nba finals', 
                             'nfl playoffs', 'college football', 'college basketball', 'ncaa'])
            or market.get('category', '').lower() == 'sports'
          ])

    # 3 kalshi-market-mapping
    - type: "mapping"
      name: "kalshi-market-mapping"
      title: "Kalshi - Market Data Mapping"
      description: "Mapping data from Kalshi market API responses"
      condition: "$.get('sports_markets') is not None and len($.get('sports_markets', [])) > 0"
      inputs:
        markets: "$.get('sports_markets', [])"
      outputs:
        bulk-markets: "$.get('mapped-markets', [])"

    # 4 bulk-save-sports-markets
    - type: "document"
      name: "bulk-save-sports-markets"
      description: "Bulk save the sports market data."
      condition: "$.get('sports_markets') is not None and len($.get('sports_markets', [])) > 0"
      config:
        action: "bulk-update"
        embed-selector: "$.get('title')"
        embed-vector: true
        force-update: "$.get('force-update')"
      connector:
        name: "machina-ai"
        command: "invoke_embedding"
        model: "text-embedding-3-small"
      document_name: "'kalshi-sports-market'"
      documents:
        items: "$.get('parsedItems', [])"
      inputs:
        parsedItems: "$.get('bulk-markets', [])"
      outputs:
        sports_markets_synced: "len($.get('bulk-markets', []))"

