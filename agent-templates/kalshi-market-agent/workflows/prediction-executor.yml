workflow:
  name: kalshi-prediction-executor
  title: Kalshi - Prediction Executor
  description: Workflow to execute a prediction.
  context-variables:
    debugger:
      enabled: true
    machina-ai:
      api_key: $TEMP_CONTEXT_VARIABLE_SDK_OPENAI_API_KEY
  inputs:
    document_id: $.get('document_id')
  outputs:
    workflow-status: $.get('document-exists') is not True and 'skipped' or 'executed'
  tasks:

    # load-event-by-code
    - type: document
      name: kalshi-prediction-load-by-id
      description: Load document by id
      condition: $.get('document_id') is not None
      config:
        action: search
        search-limit: 1
        search-vector: false
        search-sorters: ["value.start_time", 1]
      filters:
        document_id: $.get('document_id')
      outputs:
        document-document_id: $.get('documents')[0].get('_id', '') if $.get('documents') else None
        document-exists: len($.get('documents', [])) > 0
        document-selected: $.get('documents', [])[0] if len($.get('documents', [])) > 0 else None
        document-value: $.get('documents', [])[0].get('value', {}) if len($.get('documents', [])) > 0 else None
        event_code: $.get('documents', [])[0].get('metadata', {}).get('event_code') if $.get('documents') else None
        event_competititors: |
          [
            competitor.get('@id')
            for competitor in $.get('documents', [])[0].get('value', {}).get('sport:competitors', [])
          ]

    # load event filtering by competitor
    - type: document
      name: load-event-by-competitor
      description: Search for events by competitor in the same competition.
      condition: $.get('document-exists') is True
      config:
        action: search
        search-limit: 12
        search-vector: false
        search-sorters: ["value.schema:startDate", -1]
      filters:
        value.sport:competitors.@id: "{'$in': $.get('event_competititors')}"
        value.sport:status: "{'$in': ['closed', 'ended', 'FT']}"
      inputs:
        name: "{'$in': ['sport:Event']}"
      outputs:
        event_exists: len($.get('documents', [])) > 0
        event_list: $.get('documents', []) if $.get('documents') else None
        event_list_ids: |
          [
            event.get('value', {}).get('@id').replace('urn:sportradar:sport_event:', '')
            for event in $.get('documents', [])
          ]
        event_list_parsed: |
          [
            {
              **event.get('value', {}),
            }
            for event in $.get('documents', [])
          ]

    # iptc-mapping-past-events
    - type: mapping
      name: iptc-events-summary
      condition: $.get('document_id') is not None and $.get('document-exists') is True
      inputs:
        events: $.get('event_list_parsed')
      outputs:
        past_events_ids: $.get('events_ids')
        past_events_summary: $.get('events_summary')

    # load-kalshi-events-by-past-event-codes
    - type: document
      name: load-kalshi-events-by-event-codes
      description: Load kalshi-events that reference the past events by eventCode.
      condition: $.get('past_events_ids') is not None and len($.get('past_events_ids', [])) > 0
      config:
        action: search
        search-limit: 100
        search-vector: false
        search-sorters: ["updated", -1]
      filters:
        value.eventCode: "{'$in': [$.get('event_code')]}"
      inputs:
        name: "'kalshi-events'"
      outputs:
        kalshi_events: $.get('documents', [])
        kalshi_events_count: len($.get('documents', []))
        kalshi_events_exists: len($.get('documents', [])) > 0
        event_ticker: $.get('documents', [])[0].get('metadata', {}).get('id') if $.get('documents') else None

    # 1 load-markets
    - type: connector
      name: load-markets
      description: Get markets from Kalshi API
      condition: $.get('event_ticker') is not None
      connector:
        name: kalshi
        command: get-markets
      inputs:
        event_ticker: $.get('event_ticker')
      outputs:
        cursor: $.get('cursor', 0)
        markets: $.get('markets', [])

    # mapping-markets-summary
    - type: mapping
      name: kalshi-markets-summary
      description: Seleciona campos principais dos markets.
      condition: $.get('markets') is not None and len($.get('markets', [])) > 0
      inputs:
        markets: $.get('markets')
      outputs:
        markets_summary: $.get('markets_summary')
        markets_selected: $.get('markets_selected')
        markets_tickers: $.get('markets_tickers')
        markets_count: $.get('markets_count')

    ## CONTENT STORIES FROM PAST EVENTS

    # # coverage-event-stories-prompt
    # - type: prompt
    #   name: coverage-event-stories-prompt
    #   description: Coverage Event Stories Prompt
    #   condition: $.get('document_id') is not None and $.get('document-exists') is True
    #   connector:
    #     command: invoke_prompt
    #     name: google-genai
    #     model: gemini-2.5-flash
    #     location: global
    #     provider: vertex_ai
    #   inputs:
    #     event_summary: $.get('events_summary')
    #     past_events_objects: $.get('past_events_objects')
    #   outputs:
    #     event-stories-snippets: |
    #       [
    #         {
    #           **snippet,
    #           "metadata": {
    #             "content-group": "event-preview",
    #             "event_code": "$.(metadata_event_code)"
    #           }
    #         }
    #         for snippet in $.get('snippets', [])
    #       ]

    # # version-control-update
    # - type: document
    #   name: version-control-update
    #   description: Update the events document version control.
    #   condition: $.get('document-exists') is True
    #   config:
    #     action: update
    #     embed-vector: false
    #     force-update: true
    #   filters:
    #     document_id: $.get('document_id')
    #   documents:
    #     sport:Event: |
    #       {
    #         **$.get('document-value', {}),
    #         'version_control': {
    #           **$.get('document-value', {}).get('version_control', {}),
    #           'event-preview': $.get('is_prediction_finished'),
    #           'processing': False
    #         }
    #       }
      