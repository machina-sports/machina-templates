workflow:
  name: "voice-chat"
  title: "Voice Chat"
  description: "Workflow to execute a voice chat completion using Machina Knowledge."
  context-variables:
    debugger:
      enabled: true
    google-speech-to-text:
      api_key: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL"
    google-genai:
      api_key: "$TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY"
    machina-ai:
      api_key: "$TEMP_CONTEXT_VARIABLE_SDK_OPENAI_API_KEY"
  inputs:
    audio_path: "$.get('audio_path')"
    language_code: "$.get('language_code', 'pt-BR')"
  outputs:
    transcript: "$.get('transcript')"
    message: "$.get('message')"
    workflow-status: "$.get('message') is not None and 'executed' or 'skipped'"
  tasks:

    # Transcribe audio
    - type: "connector"
      name: "transcribe-voice"
      description: "Transcribe voice input to text"
      connector:
        name: "google-speech-to-text"
        command: "invoke_transcribe"
      inputs:
        audio_path: "$.get('audio_path')"
        language_code: "$.get('language_code')"
      outputs:
        transcript: "$.get('transcript')"

    # Search Machina Assistant Knowledge base
    - type: "document"
      name: "load-similar-documents"
      description: "Load relevant documentation from Machina Assistant"
      config:
        action: "search"
        threshold-docs: 5
        threshold-similarity: 0.01
        search-limit: 100
        search-vector: true
      connector:
        name: "machina-ai"
        command: "invoke_embedding"
        model: "text-embedding-3-small"
      inputs:
        name: "'machina-knowledge'"
        search-limit: "'100'"
        search-query: "$.get('transcript')"
      outputs:
        parsed_documents: |
          [
            {
              'title': d.get('value', {}).get('title', 'Untitled'),
              'content': d.get('value', {}).get('content', ''),
              'similarity': d.get('similarity_score', 0)
            }
            for d in $.get('documents', [])
          ]

    # Generate response using LLM
    - type: "prompt"
      name: "chat-completions-prompt"
      description: "Generate response based on transcript and knowledge docs."
      connector:
        name: "google-genai"
        command: "invoke_prompt"
        model: "gemini-2.5-pro"
      inputs:
        parsed_documents: "$.get('parsed_documents', [])"
        question: "$.get('transcript')"
      outputs:
        message: "$"
