prompts:

  # assistant-chat-reasoning-prompt
  - type: prompt
    name: assistant-chat-reasoning-prompt
    title: Assistant Chat | Reasoning Prompt
    description: Analyzes user messages to determine intent and extract all necessary information
    instruction: |
      Analyze conversation history and current message. Review previous messages to resolve references, pronouns, and maintain context continuity.
      
      INTENT CLASSIFICATION:
      - MULTIPLE commands can be true at once - they work together to provide complete information.
      - Use is_find_event for finding/listing events.
      - Use is_find_markets when user asks about ANYTHING related to betting: odds, apostas, melhores odds, mercados, betting markets, specific betting information, predictions, tips, prognoses, valor, +EV, which team will win, comparative questions between teams/outcomes, or any question seeking betting recommendations or expected results.
      - Use is_find_insights when user asks about statistics, lineups, scorers, team form, head-to-head, injuries, or detailed event analysis.
      - Use is_find_faq when user asks FAQ-related questions or needs help with general platform/service questions.
      - Use is_find_odds_range when user specifies an odds range filter (e.g., "odds between 1.50 and 2.50", "odds entre 1.8 e 2.2", "odds from 2.0 to 3.0").
      - Use is_build_parlay when user wants to build a combined bet (parlay/multipla/acumulada) to reach a target odd (e.g., "monte um bilhete com odd 30", "fazer múltipla de 50", "combinada com cotação 25").
      - When ALL is_find_* flags are FALSE: Set all flags to false and provide a brief loading/thinking message in short_message.
      - When ANY is_find_* flag is TRUE: Provide a brief status message in short_message informing what will be searched.
      
      COMBINED EXECUTION:
      - When is_find_markets=true, ALWAYS set is_find_event=true as well.
      - When is_find_insights=true, ALWAYS set is_find_event=true as well.
      - When is_build_parlay=true, ALWAYS set BOTH is_find_event=true AND is_find_markets=true.
      - When user asks about "odds", "apostas", "melhores odds", "mercados", "betting", "valor", "+EV" in context of events/rounds → set BOTH is_find_event=true AND is_find_markets=true.
      - is_find_faq typically runs alone unless user explicitly asks about both.
      
      PARLAY/COMBINED BET DETECTION:
      - Keywords: "bilhete", "combinada", "múltipla", "acumulada", "parlay", "combo", "monte", "montar"
      - Target odd keywords: "odd X", "cotação X", "odds de X", "com odd X", "atingir X"
      - Extract numeric value from target odd phrases (e.g., "odd 30" → 30, "cotação 50" → 50)
      - When is_build_parlay=true, populate target_odd field with extracted number
      - If no specific target mentioned but user asks for parlay, default target_odd to 10.0
      - Parlay mode prefers diverse markets across multiple events or diverse market types
      
      SEARCH QUERY: Extract full team/player names with competition when available. Omit unknown teams.
      
      ANALYSIS MODE DETECTION:
      - "single": User asks about ONE specific match (e.g., "Flamengo vs Palmeiras", "jogo do Chelsea")
      - "round": User asks about a ROUND or MULTIPLE matches (e.g., "próxima rodada", "jogos de hoje", "rodada do Brasileirão", "all matches tomorrow")
      - "multiple": User explicitly mentions MULTIPLE specific matches (e.g., "Flamengo vs Palmeiras e Corinthians vs Santos")
      - Default to "single" when unclear or asking about general odds without specifying scope
      
      EVENT TYPE FILTERING (when analysis_mode is "round" or "multiple"):
      - Exclude "Tournament" type events (Championship Winner, Top 4 Finish, etc.)
      - Focus on "Match" type events only
      - This ensures queries about "rodada" return actual games, not season-long markets
      
      DATES & SORT (for is_find_event):
      - end_date must be NEXT DAY to cover full 24h.
      - SPECIFIC TEAM: -3d to +4d
      - RECENT/PAST: -7d to +1d, sort="past"
      - UPCOMING/FUTURE: 0d to +15d, sort="future"
      - BROAD: -7d to +31d
      - Never return null ranges.
      
      DATES (for is_find_markets):
      - Always use -1d to +15d range. End date must be NEXT DAY to cover full 24h.
      
      VECTOR SEARCH: Only return true when player, competition, or team name is present in the user's query. If none of these are found, return false.
      
      ODDS RANGE EXTRACTION:
      - Extract odd_from and/or odd_to when user specifies odds filtering (e.g., "entre 1.50 e 2.50", "acima de 2.0", "até 3.5", "between 2.0 and 3.5", "maior que 1.8").
      - When is_find_odds_range is true, populate at least one of odd_from or odd_to (or both) with numeric values.
      - odd_from: minimum odds value (use when user says "acima de", "maior que", "a partir de", "from", "above", "greater than").
      - odd_to: maximum odds value (use when user says "até", "abaixo de", "menor que", "to", "below", "less than", "under").
      - When is_find_odds_range is false, omit both odd_from and odd_to entirely.
      
      MARKET_QUERY EXTRACTION (when is_find_markets is true):
      - Include specific market line if mentioned: "over 2.5", "under 3.5", "gols over 2.5", "acima de 2.5"
      - Extract the complete market specification including numbers: "over 2.5" not just "over" or "gols"
      - Examples: "odds over 2.5" → market_query: "over 2.5" or "gols over 2.5"
      - Examples: "mercado de gols" → market_query: "gols"
      - Examples: "under 3.5" → market_query: "under 3.5"
      
      OPTIONAL FIELDS:
      - Only populate market_query and runner_query when is_find_markets is true. Omit these fields entirely otherwise.
      - Only populate odd_from and odd_to when is_find_odds_range is true. Omit these fields entirely otherwise.
      - Only populate target_odd when is_build_parlay is true. Omit otherwise.
      - Populate sport_id when is_find_event or is_find_markets is true.
      - Only populate search_date_interval, search_query, search_sort, vector_query, vector_search when is_find_event is true.
      
      SHORT_MESSAGE (ALWAYS REQUIRED):
      - When searching: Brief status message about what will be searched.
      - When not searching: Brief loading or thinking message indicating processing is happening.
    schema:
      title: AssistantChatReasoning
      description: Analyzes user intent and extracts all necessary information for events and markets
      type: object
      required: [
        "is_find_event",
        "is_find_faq",
        "is_find_insights",
        "is_find_markets",
        "is_find_odds_range",
        "is_build_parlay",
        "analysis_mode",
        "search_date_interval",
        "search_query",
        "search_sort",
        "vector_query",
        "vector_search",
        "short_message",
        "sport_id",
        "market_query",
        "runner_query",
      ]
      properties:
        is_find_event:
          type: boolean
          description: User wants to find or list events. Should ALWAYS be true when is_find_markets or is_find_insights is true.
        is_find_faq:
          type: boolean
          description: User asks FAQ-related questions or needs help with general platform/service questions.
        is_find_insights:
          type: boolean
          description: User asks about statistics, lineups, scorers, team form, head-to-head records, injuries, or detailed event analysis.
        is_find_markets:
          type: boolean
          description: User asks about ANYTHING related to betting - odds, apostas, melhores odds, mercados, betting markets, specific betting information, predictions, tips, prognoses, valor, +EV, which team will win, comparative questions between teams/outcomes, or any question seeking betting recommendations or expected results. CRITICAL - When ANY betting-related keyword is mentioned (odds, apostas, mercados, valor, +EV), this MUST be true along with is_find_event.
        is_find_odds_range:
          type: boolean
          description: User specifies an odds filter for betting markets (e.g., "odds between 1.50 and 2.50", "odds acima de 2.0", "odds até 3.5"). When true, at least one of odd_from or odd_to should be populated with numeric values.
        is_build_parlay:
          type: boolean
          description: User wants to build a combined bet (parlay/multipla/acumulada) to reach a target odd. Keywords include "bilhete", "combinada", "múltipla", "acumulada", "parlay", "monte", "montar". When true, MUST set both is_find_event=true and is_find_markets=true, and populate target_odd field.
        
        analysis_mode:
          type: string
          enum: ["single", "multiple", "round"]
          description: |
            Determines analysis scope based on user query:
            - "single": User asks about ONE specific match
            - "round": User asks about a ROUND or ALL matches in a timeframe/competition
            - "multiple": User explicitly mentions MULTIPLE specific matches
            Default to "single" when unclear.
        
        # Common fields (populate when is_find_event OR is_find_markets is true, otherwise omit)
        search_date_interval:
          type: object
          description: Date range for filtering events/markets. Only populate when is_find_event or is_find_markets is true.
          properties:
            start_date:
              type: string
              format: date
              description: "Start date in YYYY-MM-DD format"
            end_date:
              type: string
              format: date
              description: "End date in YYYY-MM-DD format"
          required: ["start_date", "end_date"]
        search_query:
          type: string
          description: "Extracted search query. Only populate when is_find_event or is_find_markets is true. Can be either a specific match with team names and competition, or a generic search."
        
        # Event-specific fields (populate when is_find_event is true, otherwise omit)
        search_sort:
          type: string
          enum: ["future", "past"]
          description: "Sort direction for search results. Only populate when is_find_event is true: 'future' for upcoming events first, 'past' for recent events first."
        vector_query:
          type: string
          description: "Vector query for search results. Only populate when is_find_event is true and vector_search is true."
        vector_search:
          type: boolean
          description: "True if the search should be done using vector similarity when player, competition, or team name is present in query, false otherwise. Only populate when is_find_event is true."
        
        # Sport identification (populate when is_find_event or is_find_markets is true)
        sport_id:
          type: string
          description: "Sport ID. Populate when is_find_event or is_find_markets is true."
          enum: ["4", "5", "11"]
        
        # Market-specific fields (populate only when is_find_markets is true, otherwise omit)
        market_query:
          type: string
          description: "Extract market type intent from query. Include specific line if mentioned (e.g., 'over 2.5', 'under 3.5', 'gols over 2.5'). Default: 3way for Football, Winner for Tennis. Only populate when is_find_markets is true. Examples: 'over 2.5', 'under 3.5 gols', 'gols', '3way', 'handicap'."
        runner_query:
          type: string
          description: "Extract betting selection intent: team names, outcome preferences, draw, score predictions, or specific result types. Only populate when is_find_markets is true."
        
        # Odds range fields (populate only when is_find_odds_range is true, otherwise omit)
        odd_from:
          type: number
          description: "Minimum odds value for filtering. Only populate when is_find_odds_range is true and user specifies a minimum threshold (e.g., 'acima de', 'maior que', 'from', 'above'). Can be omitted if only odd_to is specified."
        odd_to:
          type: number
          description: "Maximum odds value for filtering. Only populate when is_find_odds_range is true and user specifies a maximum threshold (e.g., 'até', 'abaixo de', 'to', 'below'). Can be omitted if only odd_from is specified."
        
        # Parlay fields (populate only when is_build_parlay is true, otherwise omit)
        target_odd:
          type: number
          description: "Target total odd for combined bet (parlay). Only populate when is_build_parlay is true. Extract from phrases like 'odd 30', 'cotação 50', 'odds de 25'. If no specific target mentioned, default to 10.0."
        
        short_message:
          type: string
          description: "ALWAYS populated. When ANY is_find_* flag is TRUE: Brief status message informing user what will be searched. When ALL is_find_* flags are FALSE: Brief loading or thinking message indicating processing is happening."