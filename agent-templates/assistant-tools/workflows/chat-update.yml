workflow:

  # assistant-chat-update
  name: assistant-chat-update
  title: Assistant - Chat Update
  description: Workflow to consume a Assistant thread.
  context-variables:
    debugger:
      enabled: true
    google-genai:
      credential: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL
      project_id: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID
    machina-ai:
      api_key: $TEMP_CONTEXT_VARIABLE_SDK_OPENAI_API_KEY
    machina-ai-fast:
      api_key: $TEMP_CONTEXT_VARIABLE_SDK_GROQ_API_KEY
  inputs:
    document_id: $.get('document_id')
    document_content: $.get('document_content', {})
    output_status: $.get('output_status', 'idle')
    status_message: $.get('status_message', 'Informacion procesada...')
    thread_context: $.get('thread_context', '')
    thread_title: $.get('thread_title', '')
  outputs:
    workflow-status: $.get('document_id') is not None and 'executed' or 'skipped'
  tasks:

    # Load thread document
    - type: document
      name: load-thread-document
      description: Load thread document
      config:
        action: search
        search-limit: 1
        search-vector: false
      filters:
        name: "'thread'"
        document_id: $.get('document_id')
      outputs:
        document_id: $.get('documents')[0]['_id'] if len($.get('documents', [])) > 0 else None
        document_exists: len($.get('documents', [])) > 0 if $.get('documents') else False
        document_value: $.get('documents')[0].get('value', {}) if len($.get('documents', [])) > 0 else {}
        messages: $.get('documents')[0].get('value', {}).get('messages', []) if len($.get('documents', [])) > 0 else []

    # Update thread document
    - type: document
      name: update-thread-document
      config:
        action: update
        embed-vector: false
        force-update: true
      condition: $.get('document_exists') is True
      documents:
        thread: |
          {
            **$.get('document_value'),
            'messages': [
              *$.get('messages'),
              *$.get('document_content')
            ],
            'status': '$.(output_status)',
            'status-message': $.get('status_message'),
            'thread_context': $.get('thread_context'),
            'title': $.get('thread_title'),
          }
      filters:
        document_id: $.get('document_id')