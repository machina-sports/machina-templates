workflow:
  
  # assistant-tools-find-faq
  name: assistant-tools-find-faq
  title: Assistant - Tools Find FAQ
  description: Workflow to find and retrieve content snippets.
  context-variables:
    debugger:
      enabled: false
    google-genai:
      api_key: $TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY
    machina-ai:
      api_key: $TEMP_CONTEXT_VARIABLE_SDK_OPENAI_API_KEY
    machina-ai-fast:
      api_key: $TEMP_CONTEXT_VARIABLE_SDK_GROQ_API_KEY
  inputs:
    document_id: $.get('document_id')
    event_code: $.get('event_code')
  outputs:
    step_find_faq_docs: $.get('snippets-parsed', [])
    workflow-status: $.get('has_snippets') is True and 'executed' or 'skipped'
  tasks:

    # Load thread document
    - type: document
      name: load-thread-document
      description: Load thread document
      config:
        action: search
        search-limit: 1
        search-vector: false
      filters:
        name: "'thread'"
        document_id: $.get('document_id')
      outputs:
        document_id: $.get('documents')[0].get('_id') if len($.get('documents', [])) > 0 else None
        document_exists: len($.get('documents', [])) > 0 if $.get('documents') else False
        document_value: $.get('documents')[0].get('value', {}) if len($.get('documents', [])) > 0 else {}
        messages: $.get('documents')[0].get('value', {}).get('messages', []) if len($.get('documents', [])) > 0 else []
        search_query: $.get('documents')[0].get('value', {}).get('messages', [])[-1].get('content', '') if len($.get('documents', [])) > 0 else ''

    # SNIPPET SEARCH BY SIMILARITY

    # load-similar-snippets (content-snippet)
    - type: document
      name: load-similar-snippets
      description: Load similar snippets.
      condition: $.get('search_query') is not None
      config:
        action: search
        threshold-docs: 3
        threshold-similarity: 0.20
        search-limit: 100
        search-vector: true
      connector:
        name: machina-ai
        command: invoke_embedding
        model: text-embedding-3-small
      inputs:
        name: "'content-faq-snippets'"
        search-query: $.get('search_query')
      outputs:
        snippets-response: $.get('documents', [])
        snippets-parsed: |
          [
            d.get('value', {}).get('text', '')
            for d in $.get('documents', [])
          ]
        has_snippets: len($.get('documents', [])) > 0

    # update-thread-with-faq-docs
    - type: document
      name: update-thread-with-faq-docs
      description: Update thread document with FAQ docs in the last user message
      condition: $.get('document_id') is not None and $.get('has_snippets') is True
      config:
        action: update
      documents:
        thread: |
          {
            **$.get('document_value'),
            'messages': [
              *[
                (
                  {
                    **msg,
                    'faq-docs': $.get('snippets-parsed', [])
                  }
                  if msg.get('role') == 'user' and idx == len($.get('messages', [])) - 1
                  else msg
                )
                for idx, msg in enumerate($.get('messages', []))
              ]
            ]
          }
      filters:
        document_id: $.get('document_id')

