mappings:

  # coverage-mapping-search-date-interval
  - type: mapping
    title: Coverage - Mapping Search Date Interval
    name: coverage-mapping-search-date-interval
    description: Mapping data from search date interval to create search date interval summary
    outputs:
      search_date_interval: |
        {
          "start_date": (datetime.fromisoformat($.get('start_date').replace('Z', '+00:00')) - timedelta(days=1)).strftime('%Y-%m-%d'),
          "end_date": (datetime.fromisoformat($.get('start_date').replace('Z', '+00:00')) + timedelta(days=1)).strftime('%Y-%m-%d')
        }

  # coverage-iptc-events-summary
  - type: mapping
    name: coverage-iptc-events-summary
    title: Coverage - Events Summary with BRT timezone
    description: Convert event data to summary format with UTC to BRT (UTC-3) conversion
    outputs:
      events_summary: |
        [
          f"{event.get('name', '')} | "
          f"{event.get('schema:sportName', '')} | "
          f"{(datetime.fromisoformat(event.get('schema:startDate', '').replace('Z', '+00:00')) - timedelta(hours=3)).strftime('%d/%m/%y %H:%M (GMT-3)') if event.get('schema:startDate') else 'N/A'} | "
          f"{event.get('sport:competition', {}).get('name', '')} | "
          f"{event.get('sport:competition', {}).get('sport:season', {}).get('name', '')} | "
          f"{event.get('sport:round', {}).get('name') or ''} | "
          f"{event.get('sport:stage', {}).get('name') or event.get('sport:stage', {}).get('phase') or ''} | "
          f"{event.get('sport:status', '')} | "
          f"{str(event.get('sport:score', {}).get('sport:homeScore')) + ' x ' + str(event.get('sport:score', {}).get('sport:awayScore')) if event.get('sport:score', {}).get('sport:homeScore') is not None and event.get('sport:score', {}).get('sport:awayScore') is not None else ''} | "
          f"{event.get('sport:venue', {}).get('name', '')} | "
          f"{event.get('sport:venue', {}).get('schema:addressLocality', '')}"
          for event in $.get('events', [])
        ]

  # validate-and-deduplicate-story-indexes
  - type: mapping
    name: validate-and-deduplicate-story-indexes
    title: Coverage - Validate and Deduplicate Story Indexes
    description: Remove duplicate indexes and validate bounds for selected stories
    outputs:
      selected-stories: |
        sorted(list(set([
          int(float(i)) for i in $.get('raw_indexes', [])
          if (isinstance(i, (int, float)) or 
              (isinstance(i, str) and (str(i).replace('.', '', 1).replace('-', '', 1).isdigit()))) and 
             0 <= int(float(i)) < $.get('max_index', 0)
        ])))
      selected-stories-parsed: |
        [
          $.get('content-stories-parsed', [])[i]
          for i in sorted(list(set([
            int(float(idx)) for idx in $.get('raw_indexes', [])
            if (isinstance(idx, (int, float)) or 
                (isinstance(idx, str) and (str(idx).replace('.', '', 1).replace('-', '', 1).isdigit()))) and 
               0 <= int(float(idx)) < $.get('max_index', 0)
          ])))
        ]