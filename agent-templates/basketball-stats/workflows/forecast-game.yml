workflow:
  name: basketball-stats-forecast-game
  title: Basketball Stats Forecast Game
  description: Complete basketball game forecasting pipeline from data ingestion to final prediction
  context-variables:
    debugger:
      enabled: true
    google-genai:
      credential: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL"
      project_id: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID"
      api_key: "$TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY"
    api-basketball:
      x-apisports-key: "$TEMP_CONTEXT_VARIABLE_API_BASKETBALL_API_KEY"
    machina-ai:
      api_key: "$TEMP_CONTEXT_VARIABLE_SDK_OPENAI_API_KEY"
  inputs:
    game_id: "$.get('game_id')"
    league: "$.get('league')"
    season: "$.get('season')"
  outputs:
    workflow-status: "'executed'"
    final_prediction: "$.get('final_prediction')"
    home_win_probability: "$.get('home_win_probability')"
    away_win_probability: "$.get('away_win_probability')"
    fair_spread_home_minus: "$.get('fair_spread_home_minus')"
    fair_total_points: "$.get('fair_total_points')"
    confidence: "$.get('confidence')"
    risk_flags: "$.get('risk_flags')"
    abstain: "$.get('abstain')"
    rationale_compact: "$.get('rationale_compact')"
  tasks:

    # 1. Load game data
    - type: connector
      name: load-game-data
      description: Load basic game information from API-Basketball
      connector:
        name: api-basketball
        command: get-games
      inputs:
        id: "$.get('game_id')"
      outputs:
        game_data: "$.get('response', [{}])[0]"
        home_team: "$.get('game_data', {}).get('teams', {}).get('home', {}).get('name', 'Home Team')"
        away_team: "$.get('game_data', {}).get('teams', {}).get('away', {}).get('name', 'Away Team')"
        game_date: "$.get('game_data', {}).get('date', '')"

    # 2. Aggregate features
    - type: connector
      name: aggregate-game-features
      description: Aggregate statistical features for the game
      connector:
        name: basketball-aggregate-features
        command: aggregate_features
      inputs:
        game_id: "$.get('game_id')"
        league: "$.get('league')"
        season: "$.get('season')"
      outputs:
        feature_payload: "$.get('feature_payload')"

    # 3. Generate news queries
    - type: connector
      name: generate-news-queries
      description: Generate search queries for matchup news
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        league: "$.get('league')"
        season: "$.get('season')"
        matchup: "$.get('home_team') + ' vs ' + $.get('away_team')"
        game_date: "$.get('game_date')"
        recency_days: 3
        max_queries: 8
      outputs:
        news_queries: "$.get('news_queries', [])"

    # 4. Search news
    - type: connector
      name: search-news
      description: Execute web search for basketball news
      connector:
        name: google-genai
        command: invoke_search
        model: "gemini-3-pro-preview"
      foreach:
        concurrent: true
        name: search_query
        expr: $
        value: $.get('news_queries')
      inputs:
        search_query: $.get('search_query', '')
        recency_days: 3
        language: 'en'
        location: 'global'
      outputs:
        search_results: |
          [
            $.get('answer', '')
          ]

    # 5. Filter search results
    - type: connector
      name: filter-search-results
      description: Filter and deduplicate search results
      connector:
        name: basketball-aggregate-features
        command: filter_search_results
      inputs:
        search_results: "$.get('search_results', [])"
        recency_days: 3
      outputs:
        filtered_search_results: "$.get('filtered_search_results', [])"

    # 6. Extract news evidence
    - type: connector
      name: extract-news-evidence
      description: Extract structured evidence from search results
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        league: "$.get('league')"
        game_date: "$.get('game_date')"
        home_team: "$.get('home_team')"
        away_team: "$.get('away_team')"
        search_results: "$.get('filtered_search_results')"
      outputs:
        evidence_items: "$.get('evidence_items', [])"
        team_level_deltas: "$.get('team_level_deltas', {})"
        news_reliability: "$.get('news_reliability', 0.0)"
        missing_info_flags: "$.get('missing_info_flags', [])"

    # 7. Format evidence outputs
    - type: connector
      name: format-evidence-outputs
      description: Format evidence for downstream workflows
      connector:
        name: basketball-aggregate-features
        command: format_evidence_outputs
      inputs:
        evidence_items: "$.get('evidence_items', [])"
        team_level_deltas: "$.get('team_level_deltas', {})"
        news_reliability: "$.get('news_reliability', 0.0)"
        missing_info_flags: "$.get('missing_info_flags', [])"
      outputs:
        news_evidence: "$.get('news_evidence')"
        news_deltas: "$.get('news_deltas')"

    # 8. Update feature payload with news deltas
    - type: connector
      name: update-feature-payload
      description: Update feature payload with news evidence
      connector:
        name: basketball-aggregate-features
        command: aggregate_features
      inputs:
        feature_payload: "$.get('feature_payload')"
        news_deltas: "$.get('news_deltas')"
      outputs:
        updated_feature_payload: |
          {
            **$.get('feature_payload'),
            'news': $.get('news_deltas')
          }

    # 9. Stats analyst forecast
    - type: connector
      name: stats-analyst-forecast
      description: Generate statistical baseline forecast
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        feature_payload: "$.get('updated_feature_payload')"
      outputs:
        stats_component: "$"

    # 10. Evidence analyst forecast
    - type: connector
      name: evidence-analyst-forecast
      description: Adjust forecast based on news evidence
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        feature_payload: "$.get('updated_feature_payload')"
        news_evidence: "$.get('news_evidence')"
      outputs:
        evidence_component: "$"

    # 11. Matchup analyst forecast
    - type: connector
      name: matchup-analyst-forecast
      description: Analyze specific matchup dynamics
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        feature_payload: "$.get('updated_feature_payload')"
      outputs:
        matchup_component: "$"

    # 12. Risk officer assessment
    - type: connector
      name: risk-officer-assessment
      description: Assess overall risk and confidence
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        components: |
          {
            'stats': $.get('stats_component'),
            'evidence': $.get('evidence_component'),
            'matchup': $.get('matchup_component')
          }
        feature_payload: "$.get('updated_feature_payload')"
      outputs:
        risk_component: "$"

    # 13. Simulation parameterization
    - type: connector
      name: simulation-parameterization
      description: Generate Monte Carlo simulation parameters
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        feature_payload: "$.get('updated_feature_payload')"
        components: |
          {
            'stats': $.get('stats_component'),
            'evidence': $.get('evidence_component'),
            'matchup': $.get('matchup_component')
          }
        risk: "$.get('risk_component')"
      outputs:
        simulation_parameters: "$"

    # 14. Monte Carlo simulation
    - type: connector
      name: monte-carlo-simulation
      description: Run Monte Carlo simulations
      connector:
        name: basketball-monte-carlo
        command: run_monte_carlo_simulation
      inputs:
        simulation_parameters: "$.get('simulation_parameters')"
        num_simulations: 10000
      outputs:
        sim_results: "$.get('simulation_results')"

    # 15. Final pricing and prediction assembly
    - type: connector
      name: final-pricing-assembly
      description: Assemble final prediction from all components
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        feature_payload: "$.get('updated_feature_payload')"
        components: |
          {
            'stats': $.get('stats_component'),
            'evidence': $.get('evidence_component'),
            'matchup': $.get('matchup_component'),
            'risk': $.get('risk_component')
          }
        sim_results: "$.get('sim_results')"
      outputs:
        final_prediction: "$"

    # 16. Store final prediction
    - type: document
      name: store-final-prediction
      description: Store the complete game prediction
      condition: "$.get('final_prediction') is not None"
      config:
        action: "update"
        embed-vector: false
        force-update: true
      documents:
        game-prediction: |
          {
            'game_id': $.get('game_id'),
            'league': $.get('league'),
            'season': $.get('season'),
            'home_team': $.get('home_team'),
            'away_team': $.get('away_team'),
            'game_date': $.get('game_date'),
            'prediction': $.get('final_prediction'),
            'feature_payload': $.get('updated_feature_payload'),
            'components': {
              'stats': $.get('stats_component'),
              'evidence': $.get('evidence_component'),
              'matchup': $.get('matchup_component'),
              'risk': $.get('risk_component')
            },
            'simulation_results': $.get('sim_results'),
            'execution_timestamp': datetime.utcnow(),
            'title': f"Prediction - {$.get('home_team')} vs {$.get('away_team')}"
          }
      metadata:
        document_type: "'basketball-prediction'"