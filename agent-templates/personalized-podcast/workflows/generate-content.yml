workflow:
  name: personalized-podcast-generate-content
  title: Personalized Podcast Generate Content
  description: Workflow to generate personalized podcast content based on user profile stored in documents
  context-variables:
    debugger:
      enabled: true
    machina-ai:
      api_key: "$TEMP_CONTEXT_VARIABLE_SDK_OPENAI_API_KEY"
    google-genai:
      credential: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL"
      project_id: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID"
      api_key: "$TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY"
    elevenlabs:
      api_key: "$TEMP_CONTEXT_VARIABLE_ELEVENLABS_API_KEY"
    storage:
      api_key: "$TEMP_CONTEXT_VARIABLE_AZURE_BLOB_STRING"
    api-mailgun:
      username: "api"
      password: "$TEMP_CONTEXT_VARIABLE_MAILGUN_API_KEY"
  inputs:
    email_address: "$.get('email_address')"
    max_queries: "$.get('max_queries', 3)"
    voice_id: "$.get('voice_id')"
    model_id: "$.get('model_id', 'eleven_flash_v2_5')"
    duration: "$.get('duration', 120)"
    language: "$.get('language', 'en')"
    from_email: "$.get('from_email', 'noreply@mg.machina.gg')"
    mailgun_domain: "$.get('mailgun_domain', 'mg.machina.gg')"
    newsletter_template_path: "$.get('newsletter_template_path', 'https://storage.googleapis.com/machina-templates-bucket-default/static/newsletters-templates/template-podcast-email.html')"
  outputs:
    step_websearch_docs: $.get('search_response', [])
    audio_content: "$.get('audio_content')"
    audio_path: "$.get('audio_path')"
    user_profile: "$.get('user_profile')"
    favorite_sport: "$.get('favorite_sport')"
    favorite_team: "$.get('favorite_team')"
    user_name: "$.get('user_name')"
    podcast-email-html: "$.get('podcast-email-html')"
    podcast-email-html-path: "$.get('podcast-email-html-path')"
    podcast-email-html-content: "$.get('podcast-email-html-content')"
    email-sent: "$.get('email-sent')"
    email-status: "$.get('email-status')"
    email-id: "$.get('email-id')"
    workflow-status: "$.get('audio_path') is not None and 'executed' or 'skipped'"
  tasks:

    # Load user profile from documents
    - type: "document"
      name: "load-user-profile"
      description: "Load user profile from documents by email address"
      condition: "$.get('email_address') is not None"
      config:
        action: "search"
        search-limit: 1
        search-vector: false
      connector:
        name: "machina-ai"
        command: "invoke_embedding"
        model: "text-embedding-3-small"
      filters:
        "metadata.user_id": "$.get('email_address')"
        "metadata.profile_type": "'user_profile'"
      inputs:
        name: "'user-profile'"
      outputs:
        user_profile: "$.get('documents', [])[0] if len($.get('documents', [])) > 0 else {}"
        favorite_sport: "$.get('documents', [])[0].get('value', {}).get('favorite_sport') if len($.get('documents', [])) > 0 else None"
        favorite_team: "$.get('documents', [])[0].get('value', {}).get('favorite_team') if len($.get('documents', [])) > 0 else None"
        personality: "$.get('documents', [])[0].get('value', {}).get('podcast_mood_tone', 'friendly') if len($.get('documents', [])) > 0 else 'friendly'"
        user_name: "$.get('documents', [])[0].get('value', {}).get('name') if len($.get('documents', [])) > 0 else None"
        profile_email_address: "$.get('documents', [])[0].get('value', {}).get('email_address') if len($.get('documents', [])) > 0 else None"
  
    # personalized-podcast-generate-search-queries
    - type: prompt
      name: personalized-podcast-generate-search-queries
      description: Generate search queries based on user's favorite sport and team
      condition: "$.get('favorite_sport') is not None and $.get('favorite_team') is not None"
      connector:
        command: invoke_prompt
        name: google-genai
        model: gemini-2.5-flash
        location: global
        provider: vertex_ai
      inputs:
        favorite_sport: $.get('favorite_sport')
        favorite_team: $.get('favorite_team')    
        max_queries: $.get('max_queries')
      outputs:
        search_queries: "$.get('search_queries', [])"

    - type: connector
      name: search-google
      description: Search the Google Gemini using Google Search grounding.
      condition: "$.get('search_queries') is not None and len($.get('search_queries', [])) > 0"
      connector:
        name: google-genai
        command: invoke_search
        model: gemini-2.5-flash
      foreach:
        concurrent: true
        name: search_query
        expr: $
        value: $.get('search_queries')
      inputs:
        location: $.get('location', 'global')
        search_query: $.get('search_query', '')
      outputs:
        search_response: |
          [
            $.get('answer', '')
          ]

    # personalized-podcast-generate-podcast-prompt
    - type: "prompt"
      name: "personalized-podcast-generate-podcast-prompt"
      description: "Generate personalized podcast script from web search results about user's favorite team."
      connector:
        name: "google-genai"
        command: "invoke_prompt"
        model: "gemini-2.5-flash"
        location: "global"
        provider: "vertex_ai"
      inputs:
        favorite_sport: "$.get('favorite_sport')"
        favorite_team: "$.get('favorite_team')"
        search_response: "$.get('search_response', [])"
        personality: "$.get('personality')"
        language: "$.get('language')"
        duration: "$.get('duration')"
      outputs:
        audio_content: "$.get('content')"

    # get text to speech
    - type: "connector"
      name: "get text to speech"
      description: "Get a text to speech from ElevenLabs"
      connector:
        name: "elevenlabs"
        command: "get_text_to_speech"
        command_attribute:
          text: "$.get('audio_content')"
          voice_id: "$.get('voice_id')"
          model_id: "$.get('model_id', 'eleven_flash_v2_5')"
          optimize_streaming_latency: "$.get('optimize_streaming_latency', '0')"
          output_format: "$.get('output_format', 'mp3_22050_32')"
      inputs:
        api_key: "$.get('api_key')"
      outputs:
        final_filename: f"podcast-{datetime.now().strftime('%Y%m%d-%H%M%S')}.mp3"
        full_filepath: "$.get('file_path')"

    # store audio
    - type: "connector"
      name: "store audio"
      condition: "$.get('full_filepath') is not None"
      connector:
        name: "storage"
        command: "store_image"
      inputs:
        final_filename: "$.get('final_filename')"
        full_filepath: "$.get('full_filepath')"
      outputs:
        audio_path: "$.get('data')"

    # downlaod the newsletter template
    - type: connector
      name: downlaod the newsletter template
      description: Download the newsletter template.
      connector:
        name: temp-downloader
        command: invoke_download
      inputs:
        image_url: $.get('newsletter_template_path')
      outputs:
        temp_newsletter_template_path: $.get('temp_path')

    # compose podcast email HTML
    - type: "connector"
      name: "compose-podcast-email"
      description: "Compose HTML email template for podcast"
      condition: "$.get('audio_path') is not None"
      connector:
        name: "user-profile-podcast-compose"
        command: "invoke_compose"
      inputs:
        audio_url: "$.get('audio_path')"
        user_name: "$.get('user_name')"
        favorite_sport: "$.get('favorite_sport')"
        favorite_team: "$.get('favorite_team')"
        podcast_duration: "$.get('duration')"
        template_path: "$.get('temp_newsletter_template_path')"
      outputs:
        podcast-email-html-path: "$.get('output_path')"
        podcast-email-html: "$.get('html_content')"
        podcast-email-html-content: "$.get('html_content')"

    # send podcast email via Mailgun
    - type: "connector"
      name: "send-podcast-email"
      description: "Send HTML email with podcast using Mailgun"
      condition: "$.get('podcast-email-html-content') is not None and ($.get('email_address') is not None or $.get('profile_email_address') is not None)"
      connector:
        name: "api-mailgun"
        command: "post-{domain}/messages"
        command_attribute:
          domain: "$.get('mailgun_domain') or 'mg.machina.gg'"
      inputs:
        body: |
          {
            "from": $.get('from_email', 'noreply@mg.machina.gg'), 
            "to": $.get('profile_email_address'),
            "subject": "Your Personalized Podcast is Ready!",
            "html": $.get('podcast-email-html-content'),
            "text": "Your personalized podcast is ready! Click the link in the email to listen."
          }
      outputs:
        email-sent: "$.get('message') is not None"
        email-status: "$.get('message')"
        email-id: "$.get('id')"