workflow:
  name: roast-agent-generate-roast
  title: Roast Agent Generate Roast
  description: Workflow to generate hyper viral roast comparing two teams using real sports data, with source citations
  context-variables:
    debugger:
      enabled: true
    machina-ai:
      api_key: "$TEMP_CONTEXT_VARIABLE_SDK_OPENAI_API_KEY"
    google-genai:
      credential: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL"
      project_id: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID"
      api_key: "$TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY"
    grok:
      authorization: "$MACHINA_CONTEXT_VARIABLE_GROK_API_KEY"
  inputs:
    team_a: "$.get('team_a')"
    team_b: "$.get('team_b')"
    roast_intensity: "$.get('roast_intensity', 'medium')"
    language: "$.get('language', 'en')"
    max_queries: "$.get('max_queries', 8)"
  outputs:
    workflow-status: "$.get('roast_content') is not None and 'executed' or 'skipped'"
    roast_content: "$.get('roast_content')"
    roast_points: "$.get('roast_points')"
    headline: "$.get('headline')"
    sources: "$.get('sources')"
    metadata: |
      {
        'team_a': $.get('team_a'),
        'team_b': $.get('team_b'),
        'roast_intensity': $.get('roast_intensity', 'medium'),
        'language': $.get('language', 'en'),
        'generated_at': datetime.now().isoformat(),
        'version': '1.0.0'
      }
  tasks:

    # roast-agent-generate-search-queries-team-b
    - type: prompt
      name: roast-agent-generate-search-queries-team-b
      description: Generate search queries focused on Team B's negative content, failures, and embarrassing moments
      condition: "$.get('team_b') is not None"
      connector:
        command: invoke_prompt
        name: google-genai
        model: gemini-2.5-flash
        location: global
        provider: vertex_ai
      inputs:
        team_b: $.get('team_b')
        roast_intensity: $.get('roast_intensity', 'medium')
        language: $.get('language', 'en')
      outputs:
        search_queries_team_b: "$.get('search_queries', [])"

    # roast-agent-generate-search-queries-team-a
    - type: prompt
      name: roast-agent-generate-search-queries-team-a
      description: Generate search queries focused on Team A's wins, victories, and trash talk points against Team B
      condition: "$.get('team_a') is not None and $.get('team_b') is not None"
      connector:
        command: invoke_prompt
        name: google-genai
        model: gemini-2.5-flash
        location: global
        provider: vertex_ai
      inputs:
        team_a: $.get('team_a')
        team_b: $.get('team_b')
        roast_intensity: $.get('roast_intensity', 'medium')
        language: $.get('language', 'en')
      outputs:
        search_queries_team_a: "$.get('search_queries', [])"

    # combine-search-queries
    - type: transform
      name: combine-search-queries
      description: Combine search queries from Team B and Team A prompts
      condition: "$.get('search_queries_team_b') is not None and $.get('search_queries_team_a') is not None"
      inputs:
        search_queries_team_b: "$.get('search_queries_team_b', [])"
        search_queries_team_a: "$.get('search_queries_team_a', [])"
      outputs:
        search_queries: |
          ($.get('search_queries_team_b', []) or []) + ($.get('search_queries_team_a', []) or [])

    # search-google
    - type: connector
      name: search-google
      description: Search Google using Gemini search grounding for roast-worthy content
      condition: "$.get('search_queries') is not None and len($.get('search_queries', [])) > 0"
      connector:
        name: google-genai
        command: invoke_search
        model: gemini-2.5-flash
      foreach:
        concurrent: true
        name: search_query
        expr: $
        value: $.get('search_queries')
      inputs:
        location: $.get('location', 'global')
        search_query: $.get('search_query', '')
      outputs:
        search_response: |
          [
            $.get('answer', '')
          ]
        search_metadata: |
          [
            $.get('data', {}).get('grounding_metadata', {}) if $.get('data') else $.get('grounding_metadata', {})
          ]

    # search-xai-fan-roasts
    - type: connector
      name: search-xai-fan-roasts
      description: Search X (Twitter) for fan roasts, memes, and viral moments about team B using xAI Grok
      condition: "$.get('team_b') is not None"
      connector:
        name: "grok"
        command: "post-chat/completions"
      inputs:
        body: |
          {
            "messages": [
              {
                "role": "user",
                "content": "Search for recent fan roasts, memes, viral moments, embarrassing reactions, and brutal takes about " + str($.get('team_b', '')) + ". Find the most savage, funny, and shareable roasts from fans. Focus on recent failures, losses, bad performances, embarrassing moments, and viral memes. Include actual fan reactions and quotes if possible. Language: " + str($.get('language', 'en'))
              }
            ],
            "model": "grok-4-fast",
            "stream": False,
            "temperature": 0.7,
            "max_tokens": 2000,
            "search_parameters": {
              "mode": "on",
              "sources": [
                {
                  "type": "x"
                }
              ],
              "from_date": (datetime.utcnow() - timedelta(days=7)).strftime('%Y-%m-%d'),
              "to_date": datetime.utcnow().strftime('%Y-%m-%d')
            },
            "response_format": {
              "type": "json_schema",
              "json_schema": {
                "name": "xai_fan_roasts",
                "schema": {
                  "type": "object",
                  "properties": {
                    "fan_roasts": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      },
                      "description": "Array of actual fan roasts, memes, and brutal takes found on X about team B"
                    },
                    "viral_moments": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      },
                      "description": "Viral moments, embarrassing reactions, or memorable failures mentioned on X"
                    },
                    "fan_sentiment": {
                      "type": "string",
                      "description": "Overall fan sentiment and reactions about team B from X"
                    },
                    "key_topics": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      },
                      "description": "Key topics, failures, or issues fans are roasting team B about"
                    }
                  },
                  "required": ["fan_roasts", "viral_moments", "fan_sentiment", "key_topics"],
                  "additionalProperties": False
                }
              }
            }
          }
      outputs:
        xai_response: "$"
        xai_fan_roasts: "$.get('choices', [])[0].get('message', {}).get('content', '')"

    # roast-agent-generate-roast-prompt
    - type: prompt
      name: roast-agent-generate-roast-prompt
      description: Generate hyper viral roast comparing two teams with source citations
      condition: "$.get('search_response') is not None and len($.get('search_response', [])) > 0"
      connector:
        name: google-genai
        command: invoke_prompt
        model: gemini-2.5-flash
        location: global
        provider: vertex_ai
      inputs:
        team_a: "$.get('team_a')"
        team_b: "$.get('team_b')"
        roast_intensity: "$.get('roast_intensity', 'medium')"
        language: "$.get('language', 'en')"
        search_response: "$.get('search_response', [])"
        search_metadata: "$.get('search_metadata', [])"
        xai_fan_roasts: "$.get('xai_fan_roasts', '')"
      outputs:
        roast_content: "$.get('roast_content')"
        roast_points: "$.get('roast_points')"
        headline: "$.get('headline')"
        sources: "$.get('sources')"

