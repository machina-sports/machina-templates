workflow:
  name: soccer-aggregate-match-features
  title: Soccer Match Feature Engineering
  description: Phase 2 - Aggregate team statistics and news evidence into structured feature payload
  context-variables:
    debugger:
      enabled: true
  inputs:
    eventCode: "$.get('eventCode')"
    data_document_id: "$.get('data_document_id')"
  outputs:
    workflow-status: "$.get('workflow_executed_status', 'executed')"
    feature_document_id: "$.get('feature_document_id')"
  tasks:
    # 1. Load collected match data from previous phase
    - type: document
      name: load-match-data
      config:
        action: search
        search-limit: 1
      filters:
        document_id: $.get('data_document_id')
      inputs:
        name: "'soccer-match-data'"
      outputs:
        match_data: "$.get('documents')[0].get('value') if len($.get('documents', [])) > 0 else {}"
        event_doc: "$.get('documents')[0].get('value', {}).get('event_doc', {}) if len($.get('documents', [])) > 0 else {}"
        h_stats: "$.get('documents')[0].get('value', {}).get('h_stats', {}) if len($.get('documents', [])) > 0 else {}"
        a_stats: "$.get('documents')[0].get('value', {}).get('a_stats', {}) if len($.get('documents', [])) > 0 else {}"
        evidence: "$.get('documents')[0].get('value', {}).get('evidence', {}) if len($.get('documents', [])) > 0 else {}"
        h_name: "$.get('documents')[0].get('value', {}).get('home_team', '') if len($.get('documents', [])) > 0 else ''"
        a_name: "$.get('documents')[0].get('value', {}).get('away_team', '') if len($.get('documents', [])) > 0 else ''"
        league: "$.get('documents')[0].get('value', {}).get('league', '39') if len($.get('documents', [])) > 0 else '39'"
        season: "$.get('documents')[0].get('value', {}).get('season', '2025') if len($.get('documents', [])) > 0 else '2025'"
        workflow_executed_status: "'executed'"

    # 2. Build Final Feature Set
    - type: connector
      name: final-aggregation
      connector:
        name: soccer-aggregate-features
        command: aggregate_features
      inputs:
        event_doc: "$.get('event_doc')"
        home_stats: "$.get('h_stats')"
        away_stats: "$.get('a_stats')"
        news_deltas: "$.get('evidence')"
      outputs:
        feature_payload: "$.get('feature_payload')"

    # 3. Store feature payload for forecasting phase
    - type: document
      name: store-match-features
      config:
        action: save
      documents:
        soccer-match-features: |
          {
            'title': $.get('h_name', '') + ' vs ' + $.get('a_name', '') + ' - Feature Payload',
            'eventCode': str($.get('eventCode')),
            'matchup': $.get('h_name', '') + ' vs ' + $.get('a_name', ''),
            'home_team': $.get('h_name', ''),
            'away_team': $.get('a_name', ''),
            'league': $.get('league'),
            'season': $.get('season'),
            'feature_payload': $.get('feature_payload'),
            'evidence': $.get('evidence'),
            'match_date': $.get('event_doc', {}).get('schema:startDate'),
            'data_document_id': $.get('data_document_id'),
            'timestamp': datetime.utcnow().isoformat()
          }
      metadata:
        eventCode: "$.get('eventCode')"
        home_team: "$.get('h_name', '')"
        away_team: "$.get('a_name', '')"
        league: "$.get('league')"
        season: "$.get('season')"
        match_date: "$.get('event_doc', {}).get('schema:startDate')"
        document_type: "'match-features'"
        phase: "'feature-engineering'"
      outputs:
        feature_document_id: "$.get('documents')[0].get('_id')"

