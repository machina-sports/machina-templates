workflow:
  name: soccer-kalshi-analysis-update
  title: Soccer - Kalshi Analysis Update
  description: Updates the version control status of a soccer fixture after analysis attempt.
  inputs:
    eventCode: $.get('eventCode')
    is_finished: $.get('is_finished', False)
  outputs:
    workflow-status: "'executed'"
  tasks:
    # 1. Load the event document
    - type: document
      name: load-event
      config:
        action: search
        search-limit: 1
      filters:
        metadata.event_code: $.get('eventCode')
      inputs:
        name: "'sport:Event'"
      outputs:
        event_doc_id: $.get('documents')[0].get('_id') if $.get('documents') else None
        event_value: $.get('documents')[0].get('value', {}) if $.get('documents') else None

    # 2. Update version control
    - type: document
      name: update-status
      condition: $.get('event_doc_id') is not None
      config:
        action: update
        force-update: true
      filters:
        document_id: $.get('event_doc_id')
      documents:
        sport:Event: |
          {
            **$.get('event_value', {}),
            'version_control': {
              **$.get('event_value', {}).get('version_control', {}),
              'processing': False,
              'forecasted': $.get('is_finished'),
              'last_forecast_attempt': datetime.utcnow().isoformat()
            }
          }

