workflow:
  name: soccer-post-match-auditor
  title: Soccer Post-Match Prediction Auditor
  description: Compares predictions to actual match results for validation and Brier score tracking.
  context-variables:
    debugger:
      enabled: true
  inputs:
    fixture_id: "$.get('fixture_id')"
    prediction_document_id: "$.get('prediction_document_id')"
  outputs:
    workflow-status: "$.get('workflow_status', 'executed')"
    audit_document_id: "$.get('audit_document_id')"
  tasks:
    # 1. Load the event to get actual match result
    - type: document
      name: load-event
      config:
        action: search
        search-limit: 1
      filters:
        metadata.event_code: str($.get('fixture_id'))
      inputs:
        name: "'sport:Event'"
      outputs:
        event_doc_id: $.get('documents')[0].get('_id') if $.get('documents') else None
        event_value: $.get('documents')[0].get('value', {}) if $.get('documents') else None
        event_score: $.get('documents')[0].get('value', {}).get('sport:score', {}) if $.get('documents') else {}
        event_status: $.get('documents')[0].get('value', {}).get('sport:status', '') if $.get('documents') else ''
        actual_result: |
          {
            'home_goals': $.get('documents')[0].get('value', {}).get('sport:score', {}).get('sport:homeScore', 0) if $.get('documents') else 0,
            'away_goals': $.get('documents')[0].get('value', {}).get('sport:score', {}).get('sport:awayScore', 0) if $.get('documents') else 0,
            'match_status': $.get('documents')[0].get('value', {}).get('sport:status', 'NS') if $.get('documents') else 'NS'
          }

    # 2. Load the prediction document
    - type: document
      name: load-prediction
      config:
        action: search
        search-limit: 1
      filters:
        document_id: $.get('prediction_document_id')
      inputs:
        name: "'soccer-prediction'"
      outputs:
        prediction: "$.get('documents')[0].get('value') if len($.get('documents', [])) > 0 else {}"
        fixture_id: "$.get('documents')[0].get('value', {}).get('fixture_id') if len($.get('documents', [])) > 0 else $.get('fixture_id')"

    # 3. Load the edge analysis if exists
    - type: document
      name: load-edge-analysis
      config:
        action: search
        search-limit: 1
      filters:
        value.eventCode: $.get('fixture_id')
      inputs:
        name: "'soccer-kalshi-analysis'"
      outputs:
        edge_analysis: "$.get('documents')[0].get('value') if len($.get('documents', [])) > 0 else {}"

    # 4. Calculate audit metrics
    - type: connector
      name: calculate-audit
      condition: "$.get('actual_result', {}).get('match_status') in ['FT', 'AET', 'PEN', 'PLAYED', 'CLOSED', 'FINISHED']"
      connector:
        name: soccer-audit-calculator
        command: calculate_audit_metrics
      inputs:
        prediction: "$.get('prediction')"
        actual_result: "$.get('actual_result')"
        edge_analysis: "$.get('edge_analysis')"
      outputs:
        audit_result: "$.get('audit_result')"

    # 5. Store audit result
    - type: document
      name: store-audit
      condition: "$.get('audit_result') is not None"
      config:
        action: save
      documents:
        soccer-prediction-audit: |
          {
            **$.get('audit_result', {}),
            'prediction_document_id': $.get('prediction_document_id'),
            'edge_analysis_summary': {
              'should_trade': $.get('edge_analysis', {}).get('should_trade', False),
              'selected_tier': $.get('edge_analysis', {}).get('selected', {}).get('tier', 'PASS'),
              'selected_ticker': $.get('edge_analysis', {}).get('selected', {}).get('ticker', '')
            }
          }
      metadata:
        fixture_id: "$.get('fixture_id')"
        document_type: "'audit'"
      outputs:
        audit_document_id: "$.get('documents')[0].get('_id') if $.get('documents') else None"

    # 6. Mark event as audited in version_control
    - type: document
      name: mark-event-audited
      condition: "$.get('audit_document_id') is not None"
      config:
        action: update
        force-update: true
      filters:
        document_id: $.get('event_doc_id')
      documents:
        sport:Event: |
          {
            **$.get('event_value', {}),
            'version_control': {
              **$.get('event_value', {}).get('version_control', {}),
              'audited': True,
              'audit_in_progress': False,
              'audit_completed_at': datetime.utcnow().isoformat(),
              'audit_document_id': $.get('audit_document_id')
            }
          }

