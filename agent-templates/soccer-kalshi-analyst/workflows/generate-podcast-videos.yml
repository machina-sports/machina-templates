workflow:
  name: soccer-generate-podcast-videos
  title: Soccer Generate Podcast Videos from Transcript
  description: Generate AI character images and videos for each segment of the podcast transcript, consolidate into a single video
  context-variables:
    debugger:
      enabled: true
    google-genai:
      credential: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL
      project_id: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID
      api_key: $TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY
    google-storage:
      api_key: $TEMP_CONTEXT_VARIABLE_GOOGLE_STORAGE_API_KEY
      bucket_name: $TEMP_CONTEXT_VARIABLE_GOOGLE_STORAGE_BUCKET_NAME
  inputs:
    eventCode: $.get('eventCode')
    poll_interval: $.get('poll_interval') or 15
  outputs:
    workflow-status: $.get('workflow_executed_status', 'executed')
    podcast_videos_document_id: $.get('podcast_videos_document_id')
    final_video_url: $.get('final_video_url')
    home_podcast_frame_url: $.get('home_podcast_frame_url')
    away_podcast_frame_url: $.get('away_podcast_frame_url')
  tasks:

    # 1. Load podcast transcript document
    - type: document
      name: load-podcast-transcript
      config:
        action: search
        search-limit: 1
        sorters: [["_id", -1]]
      filters:
        metadata.eventCode: $.get('eventCode')
      inputs:
        name: "'soccer-podcast-script'"
      outputs:
        transcript_exists: len($.get('documents', [])) > 0
        podcast_doc: $.get('documents')[0].get('value') if len($.get('documents', [])) > 0 else None
        script: $.get('documents')[0].get('value', {}).get('script', {}) if len($.get('documents', [])) > 0 else {}
        greetings_intro_home: $.get('documents')[0].get('value', {}).get('script', {}).get('greetings_intro_home', '') if len($.get('documents', [])) > 0 else ''
        closing_cta: $.get('documents')[0].get('value', {}).get('script', {}).get('closing_cta', '') if len($.get('documents', [])) > 0 else ''
        turns: $.get('documents')[0].get('value', {}).get('script', {}).get('turns', []) if len($.get('documents', [])) > 0 else []
        home_team: $.get('documents')[0].get('value', {}).get('home_team', '') if len($.get('documents', [])) > 0 else ''
        away_team: $.get('documents')[0].get('value', {}).get('away_team', '') if len($.get('documents', [])) > 0 else ''
        workflow_executed_status: "'executed'"

    # 2. Generate HOME team character image (jacked animal representing the team)
    - type: connector
      name: generate-home-character
      description: Generate AI image of HOME team character - a jacked, realistic animal in podcast studio
      condition: $.get('transcript_exists') and $.get('home_team') != ''
      connector:
        name: google-genai
        command: invoke_image
      inputs:
        aspect_ratio: "'9:16'"
        home_team: $.get('home_team')
        model_name: "'gemini-3-pro-image-preview'"
        home_team: $.get('home_team')
        prompt: |
          "Generate a PHOTOREALISTIC image of a JACKED, MUSCULAR animal character representing {{home_team}} football club in a podcast studio.\n\nCHARACTER DESIGN - CRITICAL:\n- Choose an animal that symbolically represents {{home_team}} (lion, eagle, wolf, bear, bull, tiger, etc. based on the team's identity/colors/region)\n- The animal must be ANTHROPOMORPHIC: JACKED MUSCULAR build like a professional bodybuilder\n- Photorealistic rendering: real fur/skin texture, detailed musculature, veins visible on arms\n- Expressive human-like face capable of speech and emotions - NOT a mask or costume\n- Intelligent, sentient eyes with depth and personality\n- The animal has BECOME a real being that can speak and express like humans\n\nCHARACTER POSE:\n- Sitting at a simple podcast desk wearing a fitted team jersey that shows off muscular physique\n- Black over-ear headphones\n- Confident, charismatic expression - mouth slightly open as if speaking enthusiastically\n- Positioned LEFT side of frame, body oriented toward someone across the table\n- Looking strictly toward the right side of the frame (PROFILE or 3/4 VIEW) at the other host\n- NEVER looking at the camera/lens\n- Upper body shot\n\nSTUDIO SETUP:\n- Dark charcoal acoustic foam panels (#2D2D2D) background\n- Warm key light from front-left\n- Blue/purple RGB accent lighting on back wall\n- Only a silver podcast microphone visible on the clean desk\n- Minimalist podcast setup - just the desk and microphone\n- Slight background bokeh for depth\n\nCOMPOSITION:\n- 9:16 portrait orientation\n- Character on LEFT, looking RIGHT (Side profile or 3/4 view)\n- EYES AVERTED from camera\n- Medium close-up framing\n- Eye-level camera angle\n- Shallow depth of field\n\nPROHIBITED: NO generic animals - must look like THE SPECIFIC MASCOT. NO mascot costumes or humans in suits. NO costume seams/zippers/fabric texture. NO text/logos/watermarks. NO EYE CONTACT with camera. Must look RIGHT."
      outputs:
        home_character_path: $.get('image_path')

    # 3. Generate AWAY team character image (jacked animal representing the team)
    - type: connector
      name: generate-away-character
      description: Generate AI image of AWAY team character - a jacked, realistic animal in podcast studio
      condition: $.get('transcript_exists') and $.get('away_team') != ''
      connector:
        name: google-genai
        command: invoke_image
      inputs:
        aspect_ratio: "'9:16'"
        away_team: $.get('away_team')
        model_name: "'gemini-3-pro-image-preview'"
        away_team: $.get('away_team')
        prompt: |
          "Generate a PHOTOREALISTIC image of a JACKED, MUSCULAR animal character representing {{away_team}} football club in a podcast studio.\n\nCHARACTER DESIGN - CRITICAL:\n- Choose an animal that symbolically represents {{away_team}} (lion, eagle, wolf, bear, bull, tiger, etc. based on the team's identity/colors/region)\n- MUST BE A DIFFERENT ANIMAL than typical choices - be creative and match the team's spirit\n- The animal must be ANTHROPOMORPHIC: JACKED MUSCULAR build like a professional bodybuilder\n- Photorealistic rendering: real fur/skin texture, detailed musculature, veins visible on arms\n- Expressive human-like face capable of speech and emotions - NOT a mask or costume\n- Intelligent, sentient eyes with depth and personality\n- The animal has BECOME a real being that can speak and express like humans\nCHARACTER POSE:\n- Sitting at a simple podcast desk wearing team colors or fitted jersey that shows off muscular physique\n- Black over-ear headphones\n- Skeptical or competitive expression - slight smirk, one eyebrow raised\n- Positioned RIGHT side of frame, body oriented toward someone across the table\n- Looking strictly toward the left side of the frame (PROFILE or 3/4 VIEW) at the other host\n- NEVER looking at the camera/lens\n- Upper body shot\n\nSTUDIO SETUP:\n- Dark charcoal acoustic foam panels (#2D2D2D) background\n- Warm key light from front-right\n- Blue/purple RGB accent lighting on back wall\n- Only a silver podcast microphone visible on the clean desk\n- Minimalist podcast setup - just the desk and microphone\n- Slight background bokeh for depth\n\nCOMPOSITION:\n- 9:16 portrait orientation\n- Character on RIGHT, looking LEFT (Side profile or 3/4 view)\n- EYES AVERTED from camera\n- Medium close-up framing\n- Eye-level camera angle\n- Shallow depth of field\n\nPROHIBITED: NO generic animals - must look like THE SPECIFIC MASCOT. NO mascot costumes or humans in suits. NO costume seams/zippers/fabric texture. NO text/logos/watermarks. NO EYE CONTACT with camera. Must look LEFT.
      outputs:
        away_character_path: $.get('image_path')

    # 4. Upload HOME character image to Google Storage
    - type: connector
      name: upload-home-character
      description: Upload generated HOME character image to Google Storage
      condition: $.get('home_character_path') is not None
      connector:
        name: google-storage
        command: invoke_upload
      inputs:
        image_path: $.get('home_character_path')
      outputs:
        home_podcast_frame_url: $.get('url')

    # 5. Upload AWAY character image to Google Storage
    - type: connector
      name: upload-away-character
      description: Upload generated AWAY character image to Google Storage
      condition: $.get('away_character_path') is not None
      connector:
        name: google-storage
        command: invoke_upload
      inputs:
        image_path: $.get('away_character_path')
      outputs:
        away_podcast_frame_url: $.get('url')

    # 6. Generate INTRO video (HOME speaker - greetings_intro_home)
    - type: connector
      name: generate-intro-video
      description: Generate video for the intro segment using HOME character
      condition: $.get('transcript_exists') and $.get('home_podcast_frame_url') is not None and $.get('greetings_intro_home') != ''
      connector:
        name: google-genai
        command: invoke_video
      inputs:
        model_name: "'veo-3.1-fast-generate-preview'"
        poll_interval: $.get('poll_interval')
        aspect_ratio: "'9:16'"
        negative_prompt: "'looking at camera, eye contact, other person in scene, second speaker, background people, other voices, multiple voices, background music, sound effects, ambient sounds, laughter, laughing, chuckling, giggling, background laughter, audience laughter, laugh track, whoosh, swoosh, ding, beep, pop, click, thud, explosion, jingle, notification sound, scene transition, cut, camera pan, camera zoom, camera shake, cartoon, animated, unrealistic, exaggerated expressions, cartoonish expressions, over-the-top reactions, anime style, caricature, rubbery face, stretchy movements, squash and stretch'"
        image_path: $.get('home_podcast_frame_url')
        dialogue: $.get('greetings_intro_home')
        speaker_team: $.get('home_team')
        prompt: |
          "You are a podcast video producer. Generate a video clip for a sports podcast using the provided inputs.\n\nINPUTS:\n- Reference Image: Use the provided image_path as the exact visual reference - an athletic anthropomorphic animal character\n- Speaker Team: {{speaker_team}}\n- Dialogue Script: '{{dialogue}}'\n\nVIDEO SPECIFICATIONS:\n- Aspect Ratio: Vertical 9:16\n- Style: Photorealistic - NO animation, NO cartoon effects\n- Reference: Preserve the character image EXACTLY - all facial features, athletic build, fur/skin texture, proportions, and scene as shown\n\nCAMERA:\n- Static camera, same frame as reference image throughout\n- NO transitions, NO fades, NO zooms\n- Start dry, end dry\n\nAUDIO:\n- The ONLY audio is the character speaking the dialogue script word-for-word\n- NO music, NO sound effects, NO additional words\n- Voice: Confident, charismatic voice matching the animal character - natural, realistic, conversational\n\nCHARACTER DIRECTION:\n- This is the {{speaker_team}} representative - a sentient, intelligent animal opening the podcast\n- Match reference image EXACTLY - maintain the athletic physique and animal features\n- The animal speaks naturally like a human would - expressive, emotional, engaging\n- Realistic natural lip sync to the exact dialogue script\n- Subtle facial micro-expressions: eyebrow raises, eye movements, slight head tilts\n- Natural hand/paw gestures emphasizing points\n\nENDING:\n- Look toward the right awaiting response\n- Brief pause, eyebrows raised"
      outputs:
        intro_video_path: $.get('video_path')
        intro_raw_api_response: $.get('raw_api_response') or $.get('data', {}).get('raw_api_response')

    # 7. Generate TURN videos (foreach over turns array with inline context enrichment)
    - type: connector
      name: generate-turn-videos
      description: Generate video for each turn in the podcast dialogue with conversation context
      condition: $.get('transcript_exists') and $.get('home_podcast_frame_url') is not None and $.get('away_podcast_frame_url') is not None and len($.get('turns', [])) > 0
      connector:
        name: google-genai
        command: invoke_video
      foreach:
        concurrent: false
        name: turn_item
        expr: $
        value: "[{**t, 'idx': i, 'previous_text': $.get('greetings_intro_home') if i == 0 else $.get('turns')[i-1].get('text', '')} for i, t in enumerate($.get('turns', []))]"
      inputs:
        model_name: "'veo-3.1-fast-generate-preview'"
        poll_interval: $.get('poll_interval')
        aspect_ratio: "'9:16'"
        negative_prompt: "'looking at camera, eye contact, other person in scene, second speaker, background people, other voices, multiple voices, background music, sound effects, ambient sounds, laughter, laughing, chuckling, giggling, background laughter, audience laughter, laugh track, whoosh, swoosh, ding, beep, pop, click, thud, explosion, jingle, notification sound, scene transition, cut, camera pan, camera zoom, camera shake, cartoon, animated, unrealistic, exaggerated expressions, cartoonish expressions, over-the-top reactions, anime style, caricature, rubbery face, stretchy movements, squash and stretch'"
        image_path: $.get('home_podcast_frame_url') if $.get('turn_item', {}).get('speaker', 'HOME') == 'HOME' else $.get('away_podcast_frame_url')
        dialogue: $.get('turn_item', {}).get('text', '')
        previous_dialogue: $.get('turn_item', {}).get('previous_text', '')
        speaker_team: $.get('home_team') if $.get('turn_item', {}).get('speaker', 'HOME') == 'HOME' else $.get('away_team')
        prompt: |
          "You are a podcast video producer. Generate a video clip for a sports podcast dialogue turn using the provided inputs.\n\nINPUTS:\n- Reference Image: Use the provided image_path as the exact visual reference - an athletic anthropomorphic animal character\n- Speaker Team: {{speaker_team}}\n- Dialogue Script: '{{dialogue}}'\n- Previous Dialogue (for reaction context): '{{previous_dialogue}}'\n\nVIDEO SPECIFICATIONS:\n- Aspect Ratio: Vertical 9:16\n- Style: Photorealistic - NO animation, NO cartoon effects\n- Reference: Preserve the character image EXACTLY - all facial features, athletic build, fur/skin texture, proportions, and scene as shown\n\nCAMERA:\n- Static camera, same frame as reference image throughout\n- NO transitions, NO fades, NO zooms\n- Start dry, end dry\n\nAUDIO:\n- The ONLY audio is the character speaking the dialogue script word-for-word\n- NO music, NO sound effects, NO additional words\n- Voice: Confident voice matching the animal character - natural, realistic, conversational\n\nCHARACTER DIRECTION:\n- This is the {{speaker_team}} representative - a sentient, intelligent animal responding in the conversation\n- REACTION: Start with brief natural reaction (0.5-1 sec) to the previous dialogue before speaking - skeptical if challenged, nod if good point, smirk if outrageous\n- Match reference image EXACTLY - maintain the athletic physique and animal features\n- The animal speaks naturally like a human would - expressive, emotional, engaging\n- Realistic natural lip sync to the exact dialogue script\n- Genuine expressions: confident smirk, skeptical eyebrow, excited lean-in\n- Natural body language and paw/hand gestures\n- Micro-expressions: eye shifts, ear movements, breathing, subtle nods\n\nENDING:\n- Look toward other host position passing conversation back\n- Brief pause, expectant expression"
      outputs:
        turn_video_paths: |
          [
            $.get('video_path')
          ]

    # 8. Generate CLOSING video (HOME speaker - closing_cta)
    - type: connector
      name: generate-closing-video
      description: Generate video for the closing CTA segment using HOME character
      condition: $.get('transcript_exists') and $.get('home_podcast_frame_url') is not None and $.get('closing_cta') != ''
      connector:
        name: google-genai
        command: invoke_video
      inputs:
        model_name: "'veo-3.1-fast-generate-preview'"
        poll_interval: $.get('poll_interval')
        aspect_ratio: "'9:16'"
        negative_prompt: "'looking at camera, eye contact, other person in scene, second speaker, background people, other voices, multiple voices, background music, sound effects, ambient sounds, laughter, laughing, chuckling, giggling, background laughter, audience laughter, laugh track, whoosh, swoosh, ding, beep, pop, click, thud, explosion, jingle, notification sound, scene transition, cut, camera pan, camera zoom, camera shake, cartoon, animated, unrealistic, exaggerated expressions, cartoonish expressions, over-the-top reactions, anime style, caricature, rubbery face, stretchy movements, squash and stretch'"
        image_path: $.get('home_podcast_frame_url')
        dialogue: $.get('closing_cta')
        previous_dialogue: $.get('turns', [])[-1].get('text', '') if len($.get('turns', [])) > 0 else ''
        speaker_team: $.get('home_team')
        prompt: |
          "You are a podcast video producer. Generate the closing video clip for a sports podcast using the provided inputs.\n\nINPUTS:\n- Reference Image: Use the provided image_path as the exact visual reference - an athletic anthropomorphic animal character\n- Speaker Team: {{speaker_team}}\n- Dialogue Script: '{{dialogue}}'\n- Previous Dialogue (for reaction context): '{{previous_dialogue}}'\n\nVIDEO SPECIFICATIONS:\n- Aspect Ratio: Vertical 9:16\n- Style: Photorealistic - NO animation, NO cartoon effects\n- Reference: Preserve the character image EXACTLY - all facial features, athletic build, fur/skin texture, proportions, and scene as shown\n\nCAMERA:\n- Static camera, same frame as reference image throughout\n- NO transitions, NO fades, NO zooms\n- Start dry, end dry\n\nAUDIO:\n- The ONLY audio is the character speaking the dialogue script word-for-word\n- NO music, NO sound effects, NO additional words\n- Voice: Charismatic voice matching the animal character - natural, realistic, conversational but with energy\n\nCHARACTER DIRECTION:\n- This is the {{speaker_team}} representative - a sentient, intelligent animal closing the podcast\n- START: Quick acknowledging nod to other speaker, then speak enthusiastically to them\n- Match reference image EXACTLY - maintain the athletic physique and animal features\n- The animal speaks naturally like a human would - expressive, emotional, engaging\n- Realistic natural lip sync to the exact dialogue script\n- High energy but NATURAL: genuine smile, raised eyebrows\n- Looking toward other host (profile/3/4 view) - NEVER at camera\n- Enthusiastic paw/hand gestures - pointing, open palms"
      outputs:
        closing_video_path: $.get('video_path')

    # 9. Consolidate all videos into a single MP4
    - type: connector
      name: consolidate-videos
      description: Merge all generated video segments into one final video
      condition: $.get('intro_video_path') is not None or len($.get('turn_video_paths', [])) > 0 or $.get('closing_video_path') is not None
      connector:
        name: soccer-video-consolidator
        command: consolidate_videos
      inputs:
        video_paths: |
          [p for p in [$.get('intro_video_path')] + $.get('turn_video_paths', []) + [$.get('closing_video_path')] if p is not None]
        output_filename: $.get('home_team', 'home').replace(' ', '_') + '_vs_' + $.get('away_team', 'away').replace(' ', '_') + '_podcast.mp4'
      outputs:
        consolidated_video_path: $.get('video_path')
        consolidated_filename: $.get('filename')
        consolidation_status: $.get('status')

    # 10. Upload FINAL consolidated video to Google Storage
    - type: connector
      name: upload-final-video
      description: Upload the consolidated podcast video to Google Storage
      condition: $.get('consolidated_video_path') is not None
      connector:
        name: google-storage
        command: invoke_upload
      inputs:
        file_path: $.get('consolidated_video_path')
        filename: $.get('consolidated_filename')
      outputs:
        final_video_url: $.get('url')

    # 11. Store video metadata in a document
    - type: document
      name: store-podcast-videos
      condition: $.get('final_video_url') is not None
      config:
        action: save
      documents:
        soccer-podcast-videos: |
          {
            'title': $.get('home_team', '') + ' vs ' + $.get('away_team', '') + ' - Podcast Video',
            'eventCode': $.get('eventCode'),
            'matchup': $.get('home_team', '') + ' vs ' + $.get('away_team', ''),
            'home_team': $.get('home_team', ''),
            'away_team': $.get('away_team', ''),
            'model_name': 'veo-3.1-generate-preview',
            'final_video_url': $.get('final_video_url'),
            'consolidated_filename': $.get('consolidated_filename'),
            'segments': {
              'intro_video_path': $.get('intro_video_path'),
              'turn_video_paths': $.get('turn_video_paths', []),
              'closing_video_path': $.get('closing_video_path')
            },
            'total_segments': 2 + len($.get('turn_video_paths', [])),
            'timestamp': datetime.utcnow().isoformat()
          }
      metadata:
        eventCode: $.get('eventCode')
        document_type: "'podcast-videos'"
      outputs:
        podcast_videos_document_id: $.get('documents')[0].get('_id')
