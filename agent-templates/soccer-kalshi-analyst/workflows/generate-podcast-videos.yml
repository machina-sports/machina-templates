workflow:
  name: soccer-generate-podcast-videos
  title: Soccer Generate Podcast Videos from Transcript
  description: Generate AI character images and videos for each segment of the podcast transcript, consolidate into a single video (v2)
  context-variables:
    debugger:
      enabled: true
    google-genai:
      credential: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL
      project_id: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID
      api_key: $TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY
    google-storage:
      api_key: $TEMP_CONTEXT_VARIABLE_GOOGLE_STORAGE_API_KEY
      bucket_name: $TEMP_CONTEXT_VARIABLE_GOOGLE_STORAGE_BUCKET_NAME
  inputs:
    eventCode: $.get('eventCode')
    poll_interval: $.get('poll_interval') or 15
  outputs:
    workflow-status: $.get('workflow_executed_status', 'executed')
    podcast_videos_document_id: $.get('podcast_videos_document_id')
    final_video_url: $.get('final_video_url')
    home_podcast_frame_url: $.get('home_podcast_frame_url_uploaded') or $.get('home_podcast_frame_url_cached') or ''
    away_podcast_frame_url: $.get('away_podcast_frame_url_uploaded') or $.get('away_podcast_frame_url_cached') or ''
  tasks:

    # 1. Load podcast transcript document
    - type: document
      name: load-podcast-transcript
      config:
        action: search
        search-limit: 1
        sorters: [["_id", -1]]
      filters:
        metadata.eventCode: $.get('eventCode')
      inputs:
        name: "'soccer-podcast-script'"
      outputs:
        transcript_exists: len($.get('documents', [])) > 0
        podcast_doc: $.get('documents')[0].get('value') if len($.get('documents', [])) > 0 else None
        script: $.get('documents')[0].get('value', {}).get('script', {}) if len($.get('documents', [])) > 0 else {}
        greetings_intro_home: $.get('documents')[0].get('value', {}).get('script', {}).get('greetings_intro_home', '') if len($.get('documents', [])) > 0 else ''
        greetings_intro_home_text: ($.get('greetings_intro_home', {}).get('text', '') if isinstance($.get('greetings_intro_home', {}), dict) else $.get('greetings_intro_home', ''))
        greetings_intro_home_emotion: ($.get('greetings_intro_home', {}).get('emotion', 'Confident, chest out') if isinstance($.get('greetings_intro_home', {}), dict) else 'Confident, chest out')
        closing_cta: $.get('documents')[0].get('value', {}).get('script', {}).get('closing_cta', '') if len($.get('documents', [])) > 0 else ''
        closing_cta_text: ($.get('closing_cta', {}).get('text', '') if isinstance($.get('closing_cta', {}), dict) else $.get('closing_cta', ''))
        closing_cta_emotion: ($.get('closing_cta', {}).get('emotion', 'Confident, pointing at camera') if isinstance($.get('closing_cta', {}), dict) else 'Confident, pointing at camera')
        closing_cta_speaker: $.get('documents')[0].get('value', {}).get('script', {}).get('closing_cta_speaker', 'HOME') if len($.get('documents', [])) > 0 else 'HOME'
        turns: $.get('documents')[0].get('value', {}).get('script', {}).get('turns', []) if len($.get('documents', [])) > 0 else []
        home_team: $.get('documents')[0].get('value', {}).get('home_team', '') if len($.get('documents', [])) > 0 else ''
        away_team: $.get('documents')[0].get('value', {}).get('away_team', '') if len($.get('documents', [])) > 0 else ''
        workflow_executed_status: "'executed'"

    # 1.5. Check for existing HOME team character info
    - type: document
      name: check-home-character
      description: Check if HOME team character info already exists
      condition: $.get('transcript_exists') and $.get('home_team') != ''
      config:
        action: search
        search-limit: 1
        sorters: [["_id", -1]]
      filters:
        metadata.team_name: $.get('home_team')
        metadata.document_type: "'team-character'"
      inputs:
        name: "'soccer-team-character'"
      outputs:
        home_character_exists: len($.get('documents', [])) > 0
        home_character_doc_id: $.get('documents')[0].get('_id') if len($.get('documents', [])) > 0 else None
        home_character_doc: $.get('documents')[0].get('value') if len($.get('documents', [])) > 0 else {}
        home_animal_cached: $.get('documents')[0].get('value', {}).get('animal', '') if len($.get('documents', [])) > 0 else ''
        home_voice_description_cached: $.get('documents')[0].get('value', {}).get('voice_description', '') if len($.get('documents', [])) > 0 else ''
        home_personality_description_cached: $.get('documents')[0].get('value', {}).get('personality_description', '') if len($.get('documents', [])) > 0 else ''
        home_podcast_frame_url_cached: $.get('documents')[0].get('value', {}).get('podcast_frame_url', '') if len($.get('documents', [])) > 0 else ''

    # 1.6. Check for existing AWAY team character info
    - type: document
      name: check-away-character
      description: Check if AWAY team character info already exists
      condition: $.get('transcript_exists') and $.get('away_team') != ''
      config:
        action: search
        search-limit: 1
        sorters: [["_id", -1]]
      filters:
        metadata.team_name: $.get('away_team')
        metadata.document_type: "'team-character'"
      inputs:
        name: "'soccer-team-character'"
      outputs:
        away_character_exists: len($.get('documents', [])) > 0
        away_character_doc_id: $.get('documents')[0].get('_id') if len($.get('documents', [])) > 0 else None
        away_character_doc: $.get('documents')[0].get('value') if len($.get('documents', [])) > 0 else {}
        away_animal_cached: $.get('documents')[0].get('value', {}).get('animal', '') if len($.get('documents', [])) > 0 else ''
        away_voice_description_cached: $.get('documents')[0].get('value', {}).get('voice_description', '') if len($.get('documents', [])) > 0 else ''
        away_personality_description_cached: $.get('documents')[0].get('value', {}).get('personality_description', '') if len($.get('documents', [])) > 0 else ''
        away_podcast_frame_url_cached: $.get('documents')[0].get('value', {}).get('podcast_frame_url', '') if len($.get('documents', [])) > 0 else ''

    # 2. Search for HOME team animal representation (skip if cached)
    - type: connector
      name: search-home-animal
      description: Search for which animal represents the HOME team
      condition: $.get('transcript_exists') and $.get('home_team') != '' and not $.get('home_character_exists', False)
      connector:
        name: google-genai
        command: invoke_search
        model: "gemini-3-flash-preview"
      inputs:
        search_query: |
          (
            "Which animal represents " + str($.get('home_team', '')) + " football club? Search for the team's mascot, symbol, or animal representation."
          )
      outputs:
        home_search_answer: $.get('answer', '')

    # 3. Extract HOME team animal from search results using structured output (skip if cached)
    - type: prompt
      name: extract_team_animal
      description: Extract the animal name from search results using structured output
      condition: $.get('home_search_answer') != '' and not $.get('home_character_exists', False)
      connector:
        name: google-genai
        command: invoke_prompt
        model: gemini-3-flash-preview
        location: global
        provider: vertex_ai
      inputs:
        search_answer: $.get('home_search_answer')
        team_name: $.get('home_team')
      outputs:
        home_animal_response: "$"

    # 4. Search for AWAY team animal representation (skip if cached)
    - type: connector
      name: search-away-animal
      description: Search for which animal represents the AWAY team
      condition: $.get('transcript_exists') and $.get('away_team') != '' and not $.get('away_character_exists', False)
      connector:
        name: google-genai
        command: invoke_search
        model: "gemini-3-flash-preview"
      inputs:
        search_query: |
          (
            "Which animal represents " + str($.get('away_team', '')) + " football club? Search for the team's mascot, symbol, or animal representation."
          )
      outputs:
        away_search_answer: $.get('answer', '')

    # 5. Extract AWAY team animal from search results using structured output (skip if cached)
    - type: prompt
      name: extract_team_animal
      description: Extract the animal name from search results using structured output
      condition: $.get('away_search_answer') != '' and not $.get('away_character_exists', False)
      connector:
        name: google-genai
        command: invoke_prompt
        model: gemini-3-flash-preview
        location: global
        provider: vertex_ai
      inputs:
        search_answer: $.get('away_search_answer')
        team_name: $.get('away_team')
      outputs:
        away_animal_response: "$"

    # 6. Generate HOME team character image (jacked animal representing the team) - skip if cached
    - type: connector
      name: generate-home-character
      description: Generate AI image of HOME team character - a jacked, realistic animal in podcast studio
      condition: $.get('transcript_exists') and $.get('home_team') != '' and not $.get('home_character_exists', False) and ($.get('home_animal_response', {}).get('animal', '') != '' or $.get('home_animal_cached', '') != '')
      connector:
        name: google-genai
        command: invoke_image
      inputs:
        aspect_ratio: "'9:16'"
        model_name: "'gemini-3-pro-image-preview'"
        home_team: $.get('home_team')
        home_animal: $.get('home_animal_response', {}).get('animal', '') if $.get('home_animal_response', {}).get('animal', '') != '' else $.get('home_animal_cached', '')
        prompt: |
          "Generate an ULTRA-PHOTOREALISTIC image of a JACKED, MUSCULAR {{home_animal}} character representing {{home_team}} football club in a podcast studio.\n\nPHOTOGRAPHY STYLE - CRITICAL:\n- This MUST be photographed with a REAL CAMERA - NOT rendered, NOT 3D generated, NOT computer graphics\n- Photographed with a professional DSLR or mirrorless camera - Canon EOS R5, Sony A7R IV, or equivalent\n- Real camera sensor characteristics: natural grain, realistic color science, authentic depth of field, lens imperfections\n- This is a REAL PHOTOGRAPH of a REAL ANIMAL - documentary photography style, National Geographic quality\n- Natural camera noise and sensor characteristics - NOT clean/perfect like CGI\n- Realistic lens distortion and optical properties - slight chromatic aberration, natural vignetting\n- Authentic photographic compression and color grading - NOT flat or overly saturated like 3D renders\n- The image should look like it was shot on location with professional photography equipment\n\nLIGHTING & SHADOWS - CRITICAL:\n- REALISTIC PHYSICAL LIGHTING: Natural light behavior as captured by a real camera sensor\n- Shadows must be PHYSICALLY ACCURATE: cast shadows follow real physics, soft edges where appropriate, hard edges where light is direct\n- Shadow direction must be CONSISTENT: all shadows cast from the same light source direction\n- Realistic shadow falloff: shadows get softer and lighter as they extend from the object\n- Natural shadow color: shadows have subtle color temperature shifts (cooler in shadows, warmer in highlights)\n- Realistic contact shadows: where character touches desk, shadows are darker and more defined\n- Natural rim lighting: edge lighting from accent lights creates realistic separation\n- Realistic bounce light: subtle fill light from desk surface and environment\n- NO flat lighting, NO evenly lit surfaces, NO unrealistic shadow placement\n- Shadows must have DEPTH and DIMENSION - NOT flat or painted-on appearance\n- Realistic shadow density: shadows are semi-transparent, not pure black\n- Natural shadow edges: soft penumbra transitions, NOT hard cutoffs like 3D renders\n\nCHARACTER DESIGN - CRITICAL:\n- The animal MUST be a {{home_animal}} - this is the specific animal that represents {{home_team}}\n- CRITICAL: This MUST be clearly recognizable as a SPECIFIC {{home_animal}} - unmistakable animal features are REQUIRED\n- The animal must be ANTHROPOMORPHIC: JACKED MUSCULAR build like a professional bodybuilder, but with DISTINCT ANIMAL CHARACTERISTICS\n- ANIMAL HEAD/FACE REQUIREMENTS: Must have a REALISTIC animal head with species-specific features:\n  * If lion: prominent mane, feline snout, whiskers, golden eyes, feline ears\n  * If eagle: hooked beak, sharp eyes, feathered head, talons visible\n  * If wolf: canine snout, pointed ears, fur-covered face, amber/yellow eyes\n  * If bear: rounded ears, broad snout, thick fur, small eyes\n  * If bull: horns, bovine snout, large nostrils, bovine ears\n  * If tiger: striped fur pattern, feline features, whiskers, amber eyes\n- The head MUST be clearly animal - NOT human-like, NOT masked, NOT costumed\n- ULTRA-PHOTOREALISTIC rendering: real fur/skin texture with individual hair follicles visible, detailed musculature with realistic muscle definition, veins visible on arms, natural skin imperfections, realistic lighting on fur/skin\n- This is a REAL LIVING ANIMAL photographed with a REAL CAMERA - NOT a cartoon, NOT a 3D render, NOT Pixar-style, NOT animated, NOT CGI\n- Expressive animal face capable of speech and emotions - the animal's natural features express human-like emotions\n- Intelligent, sentient animal eyes with depth, personality, and realistic reflections - but clearly animal eyes (not human)\n- Natural animal features combined with human-like expressions - the animal genuinely understands and communicates like a human, but maintains its animal identity\n- Realistic proportions: DISTINCTLY ANIMAL head/face with human-like body structure (bipedal, human-like torso and arms)\n- Natural fur/skin texture that responds to light realistically - the animal's natural coat/covering must be visible and realistic\n- Animal ears, snout/muzzle, and other species-specific features must be prominent and clearly visible\n- The animal has BECOME a real being that can speak and express like humans - this is documentary-style realism, but it MUST still look like the actual animal species\n\nCHARACTER POSE:\n- Sitting at a simple podcast desk wearing a fitted team jersey that shows off muscular physique\n- Black over-ear headphones\n- Confident, charismatic expression - mouth slightly open as if speaking enthusiastically\n- Positioned LEFT side of frame, body oriented toward someone across the table\n- Looking strictly toward the right side of the frame (PROFILE or 3/4 VIEW) at the other host\n- NEVER looking at the camera/lens\n- Upper body shot\n\nSTUDIO SETUP:\n- Dark charcoal acoustic foam panels (#2D2D2D) background\n- Warm key light from front-left\n- Blue/purple RGB accent lighting on back wall\n- Walnut wood desk - rich brown wood grain visible\n- Only a silver podcast microphone visible on the clean desk\n- Minimalist podcast setup - just the desk and microphone\n- Slight background bokeh for depth\n\nCOMPOSITION:\n- 9:16 portrait orientation\n- Character on LEFT, looking RIGHT (Side profile or 3/4 view)\n- EYES AVERTED from camera\n- Medium close-up framing\n- Eye-level camera angle\n- Shallow depth of field\n\nPROHIBITED: NO generic animals - must look like THE SPECIFIC MASCOT. NO mascot costumes or humans in suits. NO costume seams/zippers/fabric texture. NO text/logos/watermarks. NO EYE CONTACT with camera. Must look RIGHT. NO cartoon style, NO Pixar style, NO 3D rendered look, NO animated appearance, NO stylized rendering, NO exaggerated features, NO rubbery textures, NO plastic appearance, NO CGI appearance, NO computer graphics look, NO rendered shadows, NO flat lighting, NO unrealistic shadows. NO human-like faces - must have clear animal features. NO masks or human faces with animal ears - must be a real animal head. NO losing animal characteristics - the species must be unmistakably identifiable. This MUST look like a REAL PHOTOGRAPH taken with a REAL CAMERA."
      outputs:
        home_character_path: $.get('image_path')

    # 7. Generate AWAY team character image (jacked animal representing the team) - skip if cached
    - type: connector
      name: generate-away-character
      description: Generate AI image of AWAY team character - a jacked, realistic animal in podcast studio
      condition: $.get('transcript_exists') and $.get('away_team') != '' and not $.get('away_character_exists', False) and ($.get('away_animal_response', {}).get('animal', '') != '' or $.get('away_animal_cached', '') != '')
      connector:
        name: google-genai
        command: invoke_image
      inputs:
        aspect_ratio: "'9:16'"
        model_name: "'gemini-3-pro-image-preview'"
        away_team: $.get('away_team')
        away_animal: $.get('away_animal_response', {}).get('animal', '') if $.get('away_animal_response', {}).get('animal', '') != '' else $.get('away_animal_cached', '')
        prompt: |
          "Generate an ULTRA-PHOTOREALISTIC image of a JACKED, MUSCULAR {{away_animal}} character representing {{away_team}} football club in a podcast studio.\n\nPHOTOGRAPHY STYLE - CRITICAL:\n- This MUST be photographed with a REAL CAMERA - NOT rendered, NOT 3D generated, NOT computer graphics\n- Photographed with a professional DSLR or mirrorless camera - Canon EOS R5, Sony A7R IV, or equivalent\n- Real camera sensor characteristics: natural grain, realistic color science, authentic depth of field, lens imperfections\n- This is a REAL PHOTOGRAPH of a REAL ANIMAL - documentary photography style, National Geographic quality\n- Natural camera noise and sensor characteristics - NOT clean/perfect like CGI\n- Realistic lens distortion and optical properties - slight chromatic aberration, natural vignetting\n- Authentic photographic compression and color grading - NOT flat or overly saturated like 3D renders\n- The image should look like it was shot on location with professional photography equipment\n\nLIGHTING & SHADOWS - CRITICAL:\n- REALISTIC PHYSICAL LIGHTING: Natural light behavior as captured by a real camera sensor\n- Shadows must be PHYSICALLY ACCURATE: cast shadows follow real physics, soft edges where appropriate, hard edges where light is direct\n- Shadow direction must be CONSISTENT: all shadows cast from the same light source direction\n- Realistic shadow falloff: shadows get softer and lighter as they extend from the object\n- Natural shadow color: shadows have subtle color temperature shifts (cooler in shadows, warmer in highlights)\n- Realistic contact shadows: where character touches desk, shadows are darker and more defined\n- Natural rim lighting: edge lighting from accent lights creates realistic separation\n- Realistic bounce light: subtle fill light from desk surface and environment\n- NO flat lighting, NO evenly lit surfaces, NO unrealistic shadow placement\n- Shadows must have DEPTH and DIMENSION - NOT flat or painted-on appearance\n- Realistic shadow density: shadows are semi-transparent, not pure black\n- Natural shadow edges: soft penumbra transitions, NOT hard cutoffs like 3D renders\n\nCHARACTER DESIGN - CRITICAL:\n- The animal MUST be a {{away_animal}} - this is the specific animal that represents {{away_team}}\n- CRITICAL: This MUST be clearly recognizable as a SPECIFIC {{away_animal}} - unmistakable animal features are REQUIRED\n- The animal must be ANTHROPOMORPHIC: JACKED MUSCULAR build like a professional bodybuilder, but with DISTINCT ANIMAL CHARACTERISTICS\n- ANIMAL HEAD/FACE REQUIREMENTS: Must have a REALISTIC animal head with species-specific features:\n  * If lion: prominent mane, feline snout, whiskers, golden eyes, feline ears\n  * If eagle: hooked beak, sharp eyes, feathered head, talons visible\n  * If wolf: canine snout, pointed ears, fur-covered face, amber/yellow eyes\n  * If bear: rounded ears, broad snout, thick fur, small eyes\n  * If bull: horns, bovine snout, large nostrils, bovine ears\n  * If tiger: striped fur pattern, feline features, whiskers, amber eyes\n- The head MUST be clearly animal - NOT human-like, NOT masked, NOT costumed\n- ULTRA-PHOTOREALISTIC rendering: real fur/skin texture with individual hair follicles visible, detailed musculature with realistic muscle definition, veins visible on arms, natural skin imperfections, realistic lighting on fur/skin\n- This is a REAL LIVING ANIMAL photographed with a REAL CAMERA - NOT a cartoon, NOT a 3D render, NOT Pixar-style, NOT animated, NOT CGI\n- Expressive animal face capable of speech and emotions - the animal's natural features express human-like emotions\n- Intelligent, sentient animal eyes with depth, personality, and realistic reflections - but clearly animal eyes (not human)\n- Natural animal features combined with human-like expressions - the animal genuinely understands and communicates like a human, but maintains its animal identity\n- Realistic proportions: DISTINCTLY ANIMAL head/face with human-like body structure (bipedal, human-like torso and arms)\n- Natural fur/skin texture that responds to light realistically - the animal's natural coat/covering must be visible and realistic\n- Animal ears, snout/muzzle, and other species-specific features must be prominent and clearly visible\n- The animal has BECOME a real being that can speak and express like humans - this is documentary-style realism, but it MUST still look like the actual animal species\n\nCHARACTER POSE:\n- Sitting at a simple podcast desk wearing team colors or fitted jersey that shows off muscular physique\n- Black over-ear headphones\n- Skeptical or competitive expression - slight smirk, one eyebrow raised\n- Positioned RIGHT side of frame, body oriented toward someone across the table\n- Looking strictly toward the left side of the frame (PROFILE or 3/4 VIEW) at the other host\n- NEVER looking at the camera/lens\n- Upper body shot\n\nSTUDIO SETUP:\n- Dark charcoal acoustic foam panels (#2D2D2D) background\n- Warm key light from front-right\n- Blue/purple RGB accent lighting on back wall\n- Walnut wood desk - rich brown wood grain visible\n- Only a silver podcast microphone visible on the clean desk\n- Minimalist podcast setup - just the desk and microphone\n- Slight background bokeh for depth\n\nCOMPOSITION:\n- 9:16 portrait orientation\n- Character on RIGHT, looking LEFT (Side profile or 3/4 view)\n- EYES AVERTED from camera\n- Medium close-up framing\n- Eye-level camera angle\n- Shallow depth of field\n\nPROHIBITED: NO generic animals - must look like THE SPECIFIC MASCOT. NO mascot costumes or humans in suits. NO costume seams/zippers/fabric texture. NO text/logos/watermarks. NO EYE CONTACT with camera. Must look LEFT. NO cartoon style, NO Pixar style, NO 3D rendered look, NO animated appearance, NO stylized rendering, NO exaggerated features, NO rubbery textures, NO plastic appearance, NO CGI appearance, NO computer graphics look, NO rendered shadows, NO flat lighting, NO unrealistic shadows. NO human-like faces - must have clear animal features. NO masks or human faces with animal ears - must be a real animal head. NO losing animal characteristics - the species must be unmistakably identifiable. This MUST look like a REAL PHOTOGRAPH taken with a REAL CAMERA."
      outputs:
        away_character_path: $.get('image_path')

    # 8. Upload HOME character image to Google Storage (skip if cached)
    - type: connector
      name: upload-home-character
      description: Upload generated HOME character image to Google Storage
      condition: $.get('home_character_path') is not None and not $.get('home_character_exists', False)
      connector:
        name: google-storage
        command: invoke_upload
      inputs:
        image_path: $.get('home_character_path')
      outputs:
        home_podcast_frame_url_uploaded: $.get('url')

    # 9. Upload AWAY character image to Google Storage (skip if cached)
    - type: connector
      name: upload-away-character
      description: Upload generated AWAY character image to Google Storage
      condition: $.get('away_character_path') is not None and not $.get('away_character_exists', False)
      connector:
        name: google-storage
        command: invoke_upload
      inputs:
        image_path: $.get('away_character_path')
      outputs:
        away_podcast_frame_url_uploaded: $.get('url')

    # 9.6. Update HOME team character info (if document exists and new data was generated)
    - type: document
      name: update-home-character
      description: Update existing HOME team character information (animal, voice, image URL) to document
      condition: $.get('transcript_exists') and $.get('home_team') != '' and $.get('home_podcast_frame_url_uploaded', '') != '' and $.get('home_character_doc_id') is not None
      config:
        action: update
        embed-vector: false
        force-update: true
      filters:
        document_id: $.get('home_character_doc_id')
      documents:
        soccer-team-character: |
          {
            'team_name': $.get('home_team', ''),
            'animal': $.get('home_animal_response', {}).get('animal', '') if $.get('home_animal_response', {}).get('animal', '') != '' else $.get('home_animal_cached', ''),
            'voice_description': $.get('home_animal_response', {}).get('voice_description', '') if $.get('home_animal_response', {}).get('voice_description', '') != '' else $.get('home_voice_description_cached', ''),
            'personality_description': $.get('home_animal_response', {}).get('personality_description', '') if $.get('home_animal_response', {}).get('personality_description', '') != '' else $.get('home_personality_description_cached', ''),
            'podcast_frame_url': $.get('home_podcast_frame_url_uploaded', ''),
            'timestamp': datetime.utcnow().isoformat()
          }
      metadata:
        team_name: $.get('home_team')
        document_type: "'team-character'"
      outputs:
        home_character_document_id: $.get('documents')[0].get('_id') if len($.get('documents', [])) > 0 else $.get('home_character_doc_id')

    # 9.6.5. Save HOME team character info (if document doesn't exist and new data was generated)
    - type: document
      name: save-home-character
      description: Save new HOME team character information (animal, voice, image URL) to document
      condition: $.get('transcript_exists') and $.get('home_team') != '' and $.get('home_podcast_frame_url_uploaded', '') != '' and $.get('home_character_doc_id') is None
      config:
        action: save
        embed-vector: false
      documents:
        soccer-team-character: |
          {
            'team_name': $.get('home_team', ''),
            'animal': $.get('home_animal_response', {}).get('animal', ''),
            'voice_description': $.get('home_animal_response', {}).get('voice_description', ''),
            'personality_description': $.get('home_animal_response', {}).get('personality_description', ''),
            'podcast_frame_url': $.get('home_podcast_frame_url_uploaded', ''),
            'timestamp': datetime.utcnow().isoformat()
          }
      metadata:
        team_name: $.get('home_team')
        document_type: "'team-character'"
      outputs:
        home_character_document_id: $.get('documents')[0].get('_id') if len($.get('documents', [])) > 0 else None

    # 9.7. Update AWAY team character info (if document exists and new data was generated)
    - type: document
      name: update-away-character
      description: Update existing AWAY team character information (animal, voice, image URL) to document
      condition: $.get('transcript_exists') and $.get('away_team') != '' and $.get('away_podcast_frame_url_uploaded', '') != '' and $.get('away_character_doc_id') is not None
      config:
        action: update
        embed-vector: false
        force-update: true
      filters:
        document_id: $.get('away_character_doc_id')
      documents:
        soccer-team-character: |
          {
            'team_name': $.get('away_team', ''),
            'animal': $.get('away_animal_response', {}).get('animal', '') if $.get('away_animal_response', {}).get('animal', '') != '' else $.get('away_animal_cached', ''),
            'voice_description': $.get('away_animal_response', {}).get('voice_description', '') if $.get('away_animal_response', {}).get('voice_description', '') != '' else $.get('away_voice_description_cached', ''),
            'personality_description': $.get('away_animal_response', {}).get('personality_description', '') if $.get('away_animal_response', {}).get('personality_description', '') != '' else $.get('away_personality_description_cached', ''),
            'podcast_frame_url': $.get('away_podcast_frame_url_uploaded', ''),
            'timestamp': datetime.utcnow().isoformat()
          }
      metadata:
        team_name: $.get('away_team')
        document_type: "'team-character'"
      outputs:
        away_character_document_id: $.get('documents')[0].get('_id') if len($.get('documents', [])) > 0 else $.get('away_character_doc_id')

    # 9.7.5. Save AWAY team character info (if document doesn't exist and new data was generated)
    - type: document
      name: save-away-character
      description: Save new AWAY team character information (animal, voice, image URL) to document
      condition: $.get('transcript_exists') and $.get('away_team') != '' and $.get('away_podcast_frame_url_uploaded', '') != '' and $.get('away_character_doc_id') is None
      config:
        action: save
        embed-vector: false
      documents:
        soccer-team-character: |
          {
            'team_name': $.get('away_team', ''),
            'animal': $.get('away_animal_response', {}).get('animal', ''),
            'voice_description': $.get('away_animal_response', {}).get('voice_description', ''),
            'personality_description': $.get('away_animal_response', {}).get('personality_description', ''),
            'podcast_frame_url': $.get('away_podcast_frame_url_uploaded', ''),
            'timestamp': datetime.utcnow().isoformat()
          }
      metadata:
        team_name: $.get('away_team')
        document_type: "'team-character'"
      outputs:
        away_character_document_id: $.get('documents')[0].get('_id') if len($.get('documents', [])) > 0 else None

    # 10. Generate INTRO video (HOME speaker - greetings_intro_home)
    - type: connector
      name: generate-intro-video
      description: Generate video for the intro segment using HOME character
      condition: $.get('transcript_exists') and ($.get('home_podcast_frame_url_uploaded') or $.get('home_podcast_frame_url_cached')) and $.get('greetings_intro_home_text') != ''
      connector:
        name: google-genai
        command: invoke_video
      inputs:
        model_name: "'veo-3.1-fast-generate-preview'"
        poll_interval: $.get('poll_interval')
        aspect_ratio: "'9:16'"
        negative_prompt: "'multiple people, second character, extra hands, background music, ambient sound, room tone, echo, reverb, sound effects, music, jingle, noise, hiss, static, breathing sounds, additional voices, laugh tracks, laughter tracks, audience laughter, crowd laughter, cartoon, 3D render, CGI, Pixar, animated, text overlay, watermark, captions'"
        image_path: $.get('home_podcast_frame_url_uploaded') or $.get('home_podcast_frame_url_cached') or ''
        dialogue: $.get('greetings_intro_home_text')
        emotion: $.get('greetings_intro_home_emotion')
        home_team: $.get('home_team')
        home_animal: ($.get('home_animal_response') or {}).get('animal') or $.get('home_animal_cached') or ''
        home_voice_description: ($.get('home_animal_response') or {}).get('voice_description') or $.get('home_voice_description_cached') or ''
        home_personality_description: ($.get('home_animal_response') or {}).get('personality_description') or $.get('home_personality_description_cached') or ''
        prompt: |
          "Generate a podcast video clip. SINGLE CHARACTER ONLY.\n\nCHARACTER: {{home_animal}} representing {{home_team}}. Match reference image EXACTLY. Ultra-photorealistic, NOT cartoon/CGI.\n\nDIALOGUE (speak word-for-word): '{{dialogue}}'\n\nEMOTION/DELIVERY: '{{emotion}}' - THIS IS THE PRIMARY DIRECTION. Embody in face, body, voice.\n- Confident/chest out = assertive tone, chest out, direct energy\n- Frustrated/leaning in = leaning forward, raised voice, intense\n- Resigned/head shake = slow shake, dropped shoulders, softer voice\n\nVOICE: '{{home_voice_description}}' - Match accent, tone, cadence. Layer '{{emotion}}' on top.\n\nPERSONALITY: '{{home_personality_description}}' - Filter through current emotion.\n\nAUDIO RULES (CRITICAL - ENFORCE STRICTLY):\n- OUTPUT AUDIO = ONLY the character speaking the dialogue. NOTHING ELSE.\n- ZERO background audio: no music, no ambient sound, no room tone, no echo, no reverb\n- ZERO sound effects: no breathing, no rustling, no clicks, no pops, no hiss\n- ZERO additional voices: no second speaker, no background voices, no whispers\n- ZERO laugh tracks: no audience laughter, no crowd laughter, no laugh tracks, no background laughter\n- COMPLETE SILENCE when character is not speaking\n- Voice delivery must match '{{emotion}}' - assertive if confident, softer if resigned\n- Audio quality: Clean podcast mic (Shure SM7B style) - crisp, warm, no artifacts\n\nVISUAL RULES:\n- Single character in frame, speaking to off-camera host (looking RIGHT)\n- Static camera, 9:16 vertical, no zooms/transitions\n- Natural lip sync, gestures match emotion intensity\n- Expressions MUST match emotion - embody '{{emotion}}' in face and body\n- Speak immediately, no pauses at end - continuous conversation flow\n\nPROHIBITED: Multiple characters, background audio, music, sound effects, laugh tracks, CGI style, text overlays"
      outputs:
        intro_video_path: $.get('video_path')
        intro_raw_api_response: $.get('raw_api_response') or $.get('data', {}).get('raw_api_response')

    # 11. Generate TURN videos (foreach over turns array with inline context enrichment)
    - type: connector
      name: generate-turn-videos
      description: Generate video for each turn in the podcast dialogue with conversation context
      condition: $.get('transcript_exists') and ($.get('home_podcast_frame_url_uploaded') or $.get('home_podcast_frame_url_cached')) and ($.get('away_podcast_frame_url_uploaded') or $.get('away_podcast_frame_url_cached')) and len($.get('turns', [])) > 0
      connector:
        name: google-genai
        command: invoke_video
      foreach:
        concurrent: false
        name: turn_item
        expr: $
        value: "[{**t, 'idx': i, 'previous_text': $.get('greetings_intro_home_text') if i == 0 else $.get('turns')[i-1].get('text', ''), 'emotion': t.get('emotion', 'Neutral delivery'), 'speaker_team_name': $.get('home_team') if t.get('speaker') == 'HOME' else $.get('away_team'), 'speaker_animal': (($.get('home_animal_response') or {}).get('animal') or $.get('home_animal_cached') or '') if t.get('speaker') == 'HOME' else (($.get('away_animal_response') or {}).get('animal') or $.get('away_animal_cached') or ''), 'speaker_voice_description': (($.get('home_animal_response') or {}).get('voice_description') or $.get('home_voice_description_cached') or '') if t.get('speaker') == 'HOME' else (($.get('away_animal_response') or {}).get('voice_description') or $.get('away_voice_description_cached') or ''), 'speaker_personality_description': (($.get('home_animal_response') or {}).get('personality_description') or $.get('home_personality_description_cached') or '') if t.get('speaker') == 'HOME' else (($.get('away_animal_response') or {}).get('personality_description') or $.get('away_personality_description_cached') or '')} for i, t in enumerate($.get('turns', []))]"
      inputs:
        model_name: "'veo-3.1-fast-generate-preview'"
        poll_interval: $.get('poll_interval')
        aspect_ratio: "'9:16'"
        negative_prompt: "'multiple people, second character, extra hands, background music, ambient sound, room tone, echo, reverb, sound effects, music, jingle, noise, hiss, static, breathing sounds, additional voices, laugh tracks, laughter tracks, audience laughter, crowd laughter, cartoon, 3D render, CGI, Pixar, animated, text overlay, watermark, captions'"
        image_path: ($.get('home_podcast_frame_url_uploaded') or $.get('home_podcast_frame_url_cached') or '') if $.get('turn_item', {}).get('speaker', 'HOME') == 'HOME' else ($.get('away_podcast_frame_url_uploaded') or $.get('away_podcast_frame_url_cached') or '')
        dialogue: $.get('turn_item', {}).get('text', '')
        previous_dialogue: $.get('turn_item', {}).get('previous_text', '')
        emotion: $.get('turn_item', {}).get('emotion', 'Neutral delivery')
        speaker_team_name: $.get('turn_item', {}).get('speaker_team_name', '')
        speaker_animal: $.get('turn_item', {}).get('speaker_animal', '')
        speaker_voice_description: $.get('turn_item', {}).get('speaker_voice_description', '')
        speaker_personality_description: $.get('turn_item', {}).get('speaker_personality_description', '')
        prompt: |
          "Generate a podcast video clip. SINGLE CHARACTER ONLY.\n\nCHARACTER: {{speaker_animal}} representing {{speaker_team_name}}. Match reference image EXACTLY. Ultra-photorealistic, NOT cartoon/CGI.\n\nDIALOGUE (speak word-for-word): '{{dialogue}}'\nPREVIOUS LINE (for reaction): '{{previous_dialogue}}'\n\nEMOTION/DELIVERY: '{{emotion}}' - THIS IS THE PRIMARY DIRECTION. Embody in face, body, voice.\n- Confident/leaning forward = assertive tone, chest out\n- Laughing/disbelief = genuine laugh, head shake, incredulous\n- Defensive/jabbing finger = pointing, furrowed brow, raised voice\n- Resigned/head shake = slow shake, dropped shoulders, softer voice\n- Savage grin = smirk, eyebrow raised, cutting tone\n\nVOICE: '{{speaker_voice_description}}' - Match accent, tone, cadence. Layer '{{emotion}}' on top.\n\nPERSONALITY: '{{speaker_personality_description}}' - Filter through current emotion.\n\nAUDIO RULES (CRITICAL - ENFORCE STRICTLY):\n- OUTPUT AUDIO = ONLY the character speaking the dialogue. NOTHING ELSE.\n- ZERO background audio: no music, no ambient sound, no room tone, no echo, no reverb\n- ZERO sound effects: no breathing, no rustling, no clicks, no pops, no hiss\n- ZERO additional voices: no second speaker, no background voices, no whispers\n- ZERO laugh tracks: no audience laughter, no crowd laughter, no laugh tracks, no background laughter\n- COMPLETE SILENCE when character is not speaking\n- Voice delivery must match '{{emotion}}' - assertive if confident, softer if resigned, include laugh if laughing (character's own laugh ONLY, no background laughter)\n\nVISUAL RULES:\n- Single character in frame, speaking to off-camera host\n- Static camera, 9:16 vertical, no zooms/transitions\n- Natural lip sync, gestures match emotion intensity\n- React to previous dialogue while speaking - match emotion cue\n- Speak immediately, no pauses at end - continuous conversation flow\n\nPROHIBITED: Multiple characters, background audio, music, sound effects, laugh tracks, CGI style, text overlays"
      outputs:
        turn_video_paths: |
          [
            $.get('video_path')
          ]

    # 12. Generate CLOSING video (using closing_cta_speaker from script)
    - type: connector
      name: generate-closing-video
      description: Generate video for the closing CTA segment using closing_cta_speaker from script
      condition: $.get('transcript_exists') and ($.get('home_podcast_frame_url_uploaded') or $.get('home_podcast_frame_url_cached')) and ($.get('away_podcast_frame_url_uploaded') or $.get('away_podcast_frame_url_cached')) and $.get('closing_cta_text') != '' and $.get('closing_cta_speaker') != ''
      connector:
        name: google-genai
        command: invoke_video
      inputs:
        model_name: "'veo-3.1-fast-generate-preview'"
        poll_interval: $.get('poll_interval')
        aspect_ratio: "'9:16'"
        negative_prompt: "'multiple people, second character, extra hands, background music, ambient sound, room tone, echo, reverb, sound effects, music, jingle, noise, hiss, static, breathing sounds, additional voices, laugh tracks, laughter tracks, audience laughter, crowd laughter, cartoon, 3D render, CGI, Pixar, animated, text overlay, watermark, captions'"
        image_path: ($.get('home_podcast_frame_url_uploaded') or $.get('home_podcast_frame_url_cached') or '') if $.get('closing_cta_speaker', 'HOME') == 'HOME' else ($.get('away_podcast_frame_url_uploaded') or $.get('away_podcast_frame_url_cached') or '')
        dialogue: $.get('closing_cta_text')
        emotion: $.get('closing_cta_emotion')
        previous_dialogue: $.get('turns', [])[-1].get('text', '') if len($.get('turns', [])) > 0 else ''
        speaker_team_name: $.get('home_team') if $.get('closing_cta_speaker', 'HOME') == 'HOME' else $.get('away_team')
        speaker_animal: (($.get('home_animal_response') or {}).get('animal') or $.get('home_animal_cached') or '') if $.get('closing_cta_speaker', 'HOME') == 'HOME' else (($.get('away_animal_response') or {}).get('animal') or $.get('away_animal_cached') or '')
        speaker_voice_description: (($.get('home_animal_response') or {}).get('voice_description') or $.get('home_voice_description_cached') or '') if $.get('closing_cta_speaker', 'HOME') == 'HOME' else (($.get('away_animal_response') or {}).get('voice_description') or $.get('away_voice_description_cached') or '')
        speaker_personality_description: (($.get('home_animal_response') or {}).get('personality_description') or $.get('home_personality_description_cached') or '') if $.get('closing_cta_speaker', 'HOME') == 'HOME' else (($.get('away_animal_response') or {}).get('personality_description') or $.get('away_personality_description_cached') or '')
        prompt: |
          "Generate the CLOSING podcast video clip. SINGLE CHARACTER ONLY.\n\nCHARACTER: {{speaker_animal}} representing {{speaker_team_name}}. Match reference image EXACTLY. Ultra-photorealistic, NOT cartoon/CGI.\n\nDIALOGUE (speak word-for-word): '{{dialogue}}'\nPREVIOUS LINE (for reaction): '{{previous_dialogue}}'\n\nEMOTION/DELIVERY: '{{emotion}}' - THIS IS THE PRIMARY DIRECTION. Embody in face, body, voice.\n- Confident/pointing at camera = assertive tone, direct eye contact, pointing gesture\n- Resigned/head shake = slow shake, dropped shoulders, softer voice, defeated\n- Mutual defeat/shaking heads = both teams acknowledge failure, resigned tone\n\nVOICE: '{{speaker_voice_description}}' - Match accent, tone, cadence. Layer '{{emotion}}' on top.\n\nPERSONALITY: '{{speaker_personality_description}}' - Filter through current emotion.\n\nAUDIO RULES (CRITICAL - ENFORCE STRICTLY):\n- OUTPUT AUDIO = ONLY the character speaking the dialogue. NOTHING ELSE.\n- ZERO background audio: no music, no ambient sound, no room tone, no echo, no reverb\n- ZERO sound effects: no breathing, no rustling, no clicks, no pops, no hiss\n- ZERO additional voices: no second speaker, no background voices, no whispers\n- ZERO laugh tracks: no audience laughter, no crowd laughter, no laugh tracks, no background laughter\n- COMPLETE SILENCE when character is not speaking\n- Voice delivery must match '{{emotion}}' - assertive if confident, softer if resigned\n- Audio quality: Clean podcast mic (Shure SM7B style) - crisp, warm, no artifacts\n\nVISUAL RULES:\n- Single character in frame\n- START: Quick nod to off-camera speaker, then transition to DIRECT EYE CONTACT with camera/audience\n- Static camera, 9:16 vertical, no zooms/transitions\n- Natural lip sync, gestures match emotion intensity\n- Expressions MUST match emotion - embody '{{emotion}}' in face and body\n- High energy CTA delivery if confident, resigned if defeated\n- Speak immediately, no pauses - maintain natural flow\n\nPROHIBITED: Multiple characters, background audio, music, sound effects, laugh tracks, CGI style, text overlays"
      outputs:
        closing_video_path: $.get('video_path')

    # 13. Consolidate all videos into a single MP4
    - type: connector
      name: consolidate-videos
      description: Merge all generated video segments into one final video
      condition: $.get('intro_video_path') is not None or len($.get('turn_video_paths', [])) > 0 or $.get('closing_video_path') is not None
      connector:
        name: soccer-video-consolidator
        command: consolidate_videos
      inputs:
        video_paths: |
          [p for p in [$.get('intro_video_path')] + $.get('turn_video_paths', []) + [$.get('closing_video_path')] if p is not None]
        output_filename: $.get('home_team', 'home').replace(' ', '_') + '_vs_' + $.get('away_team', 'away').replace(' ', '_') + '_podcast.mp4'
      outputs:
        consolidated_video_path: $.get('video_path')
        consolidated_filename: $.get('filename')
        consolidation_status: $.get('status')

    # 14. Upload FINAL consolidated video to Google Storage
    - type: connector
      name: upload-final-video
      description: Upload the consolidated podcast video to Google Storage
      condition: $.get('consolidated_video_path') is not None
      connector:
        name: google-storage
        command: invoke_upload
      inputs:
        file_path: $.get('consolidated_video_path')
        filename: ($.get('consolidated_filename', '').replace('.mp4', '') + '_' + str(int(datetime.utcnow().timestamp())) + '.mp4') if $.get('consolidated_filename', '') != '' else ''
      outputs:
        final_video_url: $.get('url')

    # 15. Store video metadata in a document
    - type: document
      name: store-podcast-videos
      condition: $.get('final_video_url') is not None
      config:
        action: save
      documents:
        soccer-podcast-videos: |
          {
            'title': $.get('home_team', '') + ' vs ' + $.get('away_team', '') + ' - Podcast Video',
            'eventCode': $.get('eventCode'),
            'matchup': $.get('home_team', '') + ' vs ' + $.get('away_team', ''),
            'home_team': $.get('home_team', ''),
            'away_team': $.get('away_team', ''),
            'model_name': 'veo-3.1-generate-preview',
            'final_video_url': $.get('final_video_url'),
            'consolidated_filename': $.get('consolidated_filename'),
            'segments': {
              'intro_video_path': $.get('intro_video_path'),
              'turn_video_paths': $.get('turn_video_paths', []),
              'closing_video_path': $.get('closing_video_path')
            },
            'total_segments': 2 + len($.get('turn_video_paths', [])),
            'timestamp': datetime.utcnow().isoformat()
          }
      metadata:
        eventCode: $.get('eventCode')
        document_type: "'podcast-videos'"
      outputs:
        podcast_videos_document_id: $.get('documents')[0].get('_id')
