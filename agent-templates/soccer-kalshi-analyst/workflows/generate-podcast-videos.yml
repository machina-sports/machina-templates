workflow:
  name: soccer-generate-podcast-videos
  title: Soccer Generate Podcast Videos from Transcript
  description: Generate AI videos for each segment of the podcast transcript using mascot images, consolidate into a single video
  context-variables:
    debugger:
      enabled: true
    google-genai:
      credential: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL
      project_id: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID
      api_key: $TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY
    google-storage:
      api_key: $TEMP_CONTEXT_VARIABLE_GOOGLE_STORAGE_API_KEY
      bucket_name: $TEMP_CONTEXT_VARIABLE_GOOGLE_STORAGE_BUCKET_NAME
  inputs:
    eventCode: $.get('eventCode')
    poll_interval: $.get('poll_interval') or 15
  outputs:
    workflow-status: $.get('workflow_executed_status', 'executed')
    podcast_videos_document_id: $.get('podcast_videos_document_id')
    final_video_url: $.get('final_video_url')
  tasks:

    # 1. Load podcast transcript document
    - type: document
      name: load-podcast-transcript
      config:
        action: search
        search-limit: 1
        sorters: [["_id", -1]]
      filters:
        metadata.eventCode: $.get('eventCode')
      inputs:
        name: "'soccer-podcast-script'"
      outputs:
        transcript_exists: len($.get('documents', [])) > 0
        podcast_doc: $.get('documents')[0].get('value') if len($.get('documents', [])) > 0 else None
        script: $.get('documents')[0].get('value', {}).get('script', {}) if len($.get('documents', [])) > 0 else {}
        greetings_intro_home: $.get('documents')[0].get('value', {}).get('script', {}).get('greetings_intro_home', '') if len($.get('documents', [])) > 0 else ''
        closing_cta: $.get('documents')[0].get('value', {}).get('script', {}).get('closing_cta', '') if len($.get('documents', [])) > 0 else ''
        turns: $.get('documents')[0].get('value', {}).get('script', {}).get('turns', []) if len($.get('documents', [])) > 0 else []
        home_team: $.get('documents')[0].get('value', {}).get('home_team', '') if len($.get('documents', [])) > 0 else ''
        away_team: $.get('documents')[0].get('value', {}).get('away_team', '') if len($.get('documents', [])) > 0 else ''
        workflow_executed_status: "'executed'"

    # 2. Load mascot images document
    - type: document
      name: load-mascot-images
      condition: $.get('transcript_exists')
      config:
        action: search
        search-limit: 1
        sorters: [["_id", -1]]
      filters:
        metadata.eventCode: $.get('eventCode')
      inputs:
        name: "'soccer-mascot-images'"
      outputs:
        mascots_exist: len($.get('documents', [])) > 0
        home_podcast_frame_url: $.get('documents')[0].get('value', {}).get('home_podcast_frame_url', '') if len($.get('documents', [])) > 0 else ''
        away_podcast_frame_url: $.get('documents')[0].get('value', {}).get('away_podcast_frame_url', '') if len($.get('documents', [])) > 0 else ''

    # 3. Generate INTRO video (HOME speaker - greetings_intro_home)
    - type: connector
      name: generate-intro-video
      description: Generate video for the intro segment using HOME mascot
      condition: $.get('transcript_exists') and $.get('mascots_exist') and $.get('greetings_intro_home') != ''
      connector:
        name: google-genai
        command: invoke_video
      inputs:
        model_name: "'veo-3.1-fast-generate-preview'"
        poll_interval: $.get('poll_interval')
        aspect_ratio: "'9:16'"
        negative_prompt: "'other person in scene, second speaker, background people, other voices, multiple voices, background music, sound effects, ambient sounds, scene transition, cut, camera pan, camera zoom, camera shake, cartoon, animated, unrealistic'"
        image_path: $.get('home_podcast_frame_url')
        dialogue: $.get('greetings_intro_home')
        speaker_team: $.get('home_team')
        prompt: |
          "You are a podcast video producer. Generate a video clip for a sports podcast using the provided inputs.\n\nINPUTS:\n- Reference Image: Use the provided image_path as the exact visual reference\n- Speaker Team: {{speaker_team}}\n- Dialogue Script: '{{dialogue}}'\n\nVIDEO SPECIFICATIONS:\n- Aspect Ratio: Vertical 9:16\n- Style: Photorealistic - NO animation, NO cartoon effects\n- Reference: Preserve the image EXACTLY - all facial features, skin texture, proportions, and scene as shown\n\nCAMERA:\n- Static camera, same frame as reference image throughout\n- NO transitions, NO fades, NO zooms\n- Start dry, end dry\n\nAUDIO:\n- The ONLY audio is the character speaking the dialogue script word-for-word\n- NO music, NO sound effects, NO additional words\n- Voice: Professional podcast host tone - natural, realistic, conversational\n\nCHARACTER DIRECTION:\n- This is the {{speaker_team}} fan/host opening the podcast\n- Match reference image EXACTLY - do not stylize or alter\n- Realistic natural lip sync to the exact dialogue script\n- Subtle facial micro-expressions: eyebrow raises, eye movements, slight head tilts\n- Natural hand gestures\n\nENDING:\n- Look toward the right awaiting response\n- Brief pause, eyebrows raised"
      outputs:
        intro_video_path: $.get('video_path')
        intro_raw_api_response: $.get('raw_api_response') or $.get('data', {}).get('raw_api_response')

    # 4. Generate TURN videos (foreach over turns array with inline context enrichment)
    - type: connector
      name: generate-turn-videos
      description: Generate video for each turn in the podcast dialogue with conversation context
      condition: $.get('transcript_exists') and $.get('mascots_exist') and len($.get('turns', [])) > 0
      connector:
        name: google-genai
        command: invoke_video
      foreach:
        concurrent: false
        name: turn_item
        expr: $
        value: "[{**t, 'idx': i, 'previous_text': $.get('greetings_intro_home') if i == 0 else $.get('turns')[i-1].get('text', '')} for i, t in enumerate($.get('turns', []))]"
      inputs:
        model_name: "'veo-3.1-fast-generate-preview'"
        poll_interval: $.get('poll_interval')
        aspect_ratio: "'9:16'"
        negative_prompt: "'other person in scene, second speaker, background people, other voices, multiple voices, background music, sound effects, ambient sounds, scene transition, cut, camera pan, camera zoom, camera shake, cartoon, animated, unrealistic'"
        image_path: $.get('home_podcast_frame_url') if $.get('turn_item', {}).get('speaker', 'HOME') == 'HOME' else $.get('away_podcast_frame_url')
        dialogue: $.get('turn_item', {}).get('text', '')
        previous_dialogue: $.get('turn_item', {}).get('previous_text', '')
        speaker_team: $.get('home_team') if $.get('turn_item', {}).get('speaker', 'HOME') == 'HOME' else $.get('away_team')
        prompt: |
          "You are a podcast video producer. Generate a video clip for a sports podcast dialogue turn using the provided inputs.\n\nINPUTS:\n- Reference Image: Use the provided image_path as the exact visual reference\n- Speaker Team: {{speaker_team}}\n- Dialogue Script: '{{dialogue}}'\n- Previous Dialogue (for reaction context): '{{previous_dialogue}}'\n\nVIDEO SPECIFICATIONS:\n- Aspect Ratio: Vertical 9:16\n- Style: Photorealistic - NO animation, NO cartoon effects\n- Reference: Preserve the image EXACTLY - all facial features, skin texture, proportions, and scene as shown\n\nCAMERA:\n- Static camera, same frame as reference image throughout\n- NO transitions, NO fades, NO zooms\n- Start dry, end dry\n\nAUDIO:\n- The ONLY audio is the character speaking the dialogue script word-for-word\n- NO music, NO sound effects, NO additional words\n- Voice: Professional podcast host tone - natural, realistic, conversational\n\nCHARACTER DIRECTION:\n- This is the {{speaker_team}} fan/host responding in the conversation\n- REACTION: Start with brief natural reaction (0.5-1 sec) to the previous dialogue before speaking - skeptical if challenged, nod if good point, smirk if outrageous\n- Match reference image EXACTLY - do not stylize or alter\n- Realistic natural lip sync to the exact dialogue script\n- Genuine expressions: confident smirk, skeptical eyebrow, excited lean-in\n- Natural body language and gestures\n- Micro-expressions: eye shifts, breathing, subtle nods\n\nENDING:\n- Look toward other host position passing conversation back\n- Brief pause, expectant expression"
      outputs:
        turn_video_paths: |
          [
            $.get('video_path')
          ]

    # 5. Generate CLOSING video (HOME speaker - closing_cta)
    - type: connector
      name: generate-closing-video
      description: Generate video for the closing CTA segment using HOME mascot
      condition: $.get('transcript_exists') and $.get('mascots_exist') and $.get('closing_cta') != ''
      connector:
        name: google-genai
        command: invoke_video
      inputs:
        model_name: "'veo-3.1-fast-generate-preview'"
        poll_interval: $.get('poll_interval')
        aspect_ratio: "'9:16'"
        negative_prompt: "'other person in scene, second speaker, background people, other voices, multiple voices, background music, sound effects, ambient sounds, scene transition, cut, camera pan, camera zoom, camera shake, cartoon, animated, unrealistic'"
        image_path: $.get('home_podcast_frame_url')
        dialogue: $.get('closing_cta')
        previous_dialogue: $.get('turns', [])[-1].get('text', '') if len($.get('turns', [])) > 0 else ''
        speaker_team: $.get('home_team')
        prompt: |
          "You are a podcast video producer. Generate the closing video clip for a sports podcast using the provided inputs.\n\nINPUTS:\n- Reference Image: Use the provided image_path as the exact visual reference\n- Speaker Team: {{speaker_team}}\n- Dialogue Script: '{{dialogue}}'\n- Previous Dialogue (for reaction context): '{{previous_dialogue}}'\n\nVIDEO SPECIFICATIONS:\n- Aspect Ratio: Vertical 9:16\n- Style: Photorealistic - NO animation, NO cartoon effects\n- Reference: Preserve the image EXACTLY - all facial features, skin texture, proportions, and scene as shown\n\nCAMERA:\n- Static camera, same frame as reference image throughout\n- NO transitions, NO fades, NO zooms\n- Start dry, end dry\n\nAUDIO:\n- The ONLY audio is the character speaking the dialogue script word-for-word\n- NO music, NO sound effects, NO additional words\n- Voice: Professional podcast host tone - natural, realistic, conversational but with energy\n\nCHARACTER DIRECTION:\n- This is the {{speaker_team}} fan/host closing the podcast\n- START: Quick acknowledging nod to other speaker, then address camera directly\n- Match reference image EXACTLY - do not stylize or alter\n- Realistic natural lip sync to the exact dialogue script\n- High energy but NATURAL: genuine smile, raised eyebrows\n- Direct eye contact with viewer\n- Enthusiastic hand gestures - pointing, open palms"
      outputs:
        closing_video_path: $.get('video_path')

    # 6. Consolidate all videos into a single MP4
    - type: connector
      name: consolidate-videos
      description: Merge all generated video segments into one final video
      condition: $.get('intro_video_path') is not None or len($.get('turn_video_paths', [])) > 0 or $.get('closing_video_path') is not None
      connector:
        name: soccer-video-consolidator
        command: consolidate_videos
      inputs:
        video_paths: |
          [p for p in [$.get('intro_video_path')] + $.get('turn_video_paths', []) + [$.get('closing_video_path')] if p is not None]
        output_filename: $.get('home_team', 'home').replace(' ', '_') + '_vs_' + $.get('away_team', 'away').replace(' ', '_') + '_podcast.mp4'
      outputs:
        consolidated_video_path: $.get('video_path')
        consolidated_filename: $.get('filename')
        consolidation_status: $.get('status')

    # 7. Upload FINAL consolidated video to Google Storage
    - type: connector
      name: upload-final-video
      description: Upload the consolidated podcast video to Google Storage
      condition: $.get('consolidated_video_path') is not None
      connector:
        name: google-storage
        command: invoke_upload
      inputs:
        file_path: $.get('consolidated_video_path')
        filename: $.get('consolidated_filename')
      outputs:
        final_video_url: $.get('url')

    # 8. Store video metadata in a document
    - type: document
      name: store-podcast-videos
      condition: $.get('final_video_url') is not None
      config:
        action: save
      documents:
        soccer-podcast-videos: |
          {
            'title': $.get('home_team', '') + ' vs ' + $.get('away_team', '') + ' - Podcast Video',
            'eventCode': $.get('eventCode'),
            'matchup': $.get('home_team', '') + ' vs ' + $.get('away_team', ''),
            'home_team': $.get('home_team', ''),
            'away_team': $.get('away_team', ''),
            'model_name': 'veo-3.1-generate-preview',
            'final_video_url': $.get('final_video_url'),
            'consolidated_filename': $.get('consolidated_filename'),
            'segments': {
              'intro_video_path': $.get('intro_video_path'),
              'turn_video_paths': $.get('turn_video_paths', []),
              'closing_video_path': $.get('closing_video_path')
            },
            'total_segments': 2 + len($.get('turn_video_paths', [])),
            'timestamp': datetime.utcnow().isoformat()
          }
      metadata:
        eventCode: $.get('eventCode')
        document_type: "'podcast-videos'"
      outputs:
        podcast_videos_document_id: $.get('documents')[0].get('_id')
