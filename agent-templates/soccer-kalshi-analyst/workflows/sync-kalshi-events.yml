workflow:
  name: soccer-kalshi-sync-events-by-series
  title: Soccer - Sync Kalshi Soccer Events
  description: Syncs Kalshi soccer GAME events from all leagues and matches them with sport:Event fixtures using fuzzy matching.
  context-variables:
    debugger:
      enabled: true
    machina-ai:
      api_key: $TEMP_CONTEXT_VARIABLE_SDK_OPENAI_API_KEY
  inputs:
    force_update: $.get('force_update', False)
    # Kalshi API /events enforces max=200 per request. For >200, use the paginated workflow
    # `soccer-kalshi-sync-events-single-series` (invoked by the `soccer-kalshi-sync` agent).
    kalshi_events_limit: $.get('kalshi_events_limit', 200)
  outputs:
    events_synced: $.get('total_events_synced', 0)
    events_matched: $.get('match_count', 0)
    workflow-status: "'executed'"
  tasks:

    # Load leagues configuration
    - type: document
      name: load-kalshi-leagues-config
      config:
        action: search
        search-limit: 1
        search-vector: false
      inputs:
        name: "'kalshi-leagues-config'"
      outputs:
        leagues_config: "$.get('documents')[0].get('value', {}).get('leagues', []) if len($.get('documents', [])) > 0 else []"

    # Load coverage configuration (used to scope competitions/leagues consistently across the stack)
    - type: document
      name: load-coverage-soccer-preview-config
      config:
        action: search
        search-limit: 1
        search-vector: false
      filters:
        name: "'coverage-soccer-preview-config'"
      outputs:
        coverage_config_exists: len($.get('documents', [])) > 0 if $.get('documents') else False
        coverage_events_live: $.get('documents', [])[0].get('value', {}).get('coverage-events-live', []) if len($.get('documents', [])) > 0 else []
        coverage_events_prelive: $.get('documents', [])[0].get('value', {}).get('coverage-events-prelive', []) if len($.get('documents', [])) > 0 else []
        coverage_competitions: |
          (
            $.get('documents', [])[0].get('value', {}).get('coverage-events-live', [])
            + $.get('documents', [])[0].get('value', {}).get('coverage-events-prelive', [])
          ) if len($.get('documents', [])) > 0 else []

    # Load events dynamically for all enabled leagues
    - type: connector
      name: load-league-events
      condition: "len($.get('leagues_config', [])) > 0"
      connector:
        name: kalshi
        command: get-events
      foreach:
        name: league
        expr: $
        value: $.get('leagues_config', [])
      inputs:
        series_ticker: "$.get('league').get('series_ticker')"
        limit: (200 if int($.get('kalshi_events_limit', 200)) > 200 else int($.get('kalshi_events_limit', 200)))
      outputs:
        all_events: $.get('events', [])

    # Load sport:Event fixtures for matching
    - type: document
      name: load-fixtures
      condition: len($.get('all_events', [])) > 0
      config:
        action: search
        # Wide enough to cover full seasons across multiple leagues when including past fixtures
        search-limit: 2500
        search-vector: false
      filters:
        # Include past + upcoming fixtures (so fuzzy matching can bind closed/finished Kalshi events too)
        value.sport:status: "{'$in': ['NS', 'not_started', 'LIVE', '1H', 'HT', '2H', 'ET', 'P', 'FT', 'AET', 'PEN']}"
        # Restrict to competitions from coverage-soccer-preview-config when present; otherwise fall back to the template defaults
        value.sport:competition.@id: |
          (
            $.get('coverage_config_exists')
            and len($.get('coverage_competitions', [])) > 0
            and {'$in': $.get('coverage_competitions')}
          ) or {'$in': ['urn:apifootball:league:39', 'urn:apifootball:league:78', 'urn:apifootball:league:140', 'urn:apifootball:league:135', 'urn:apifootball:league:94']}
        # Expand date window to cover a full season worth of fixtures (+ some buffer)
        value.schema:startDate: "{'$gt': (datetime.utcnow() - timedelta(days=365)).isoformat(), '$lt': (datetime.utcnow() + timedelta(days=30)).isoformat()}"
      inputs:
        name: "'sport:Event'"
      outputs:
        sport_events: $.get('documents', [])
        sport_events_count: len($.get('documents', []))

    # Fuzzy match Kalshi events to fixtures
    - type: connector
      name: fuzzy-match-events
      condition: $.get('sport_events_count', 0) > 0 and len($.get('all_events', [])) > 0
      connector:
        name: soccer-market-event-matcher
        command: match_markets_to_events
      inputs:
        markets: $.get('all_events', [])
        events: $.get('sport_events', [])
        name_threshold: 0.4
        date_tolerance_hours: 24
      outputs:
        matches: $.get('matches', [])
        match_count: $.get('match_count', 0)

    # Build enriched events from matches
    - type: connector
      name: enrich-matched-events
      condition: len($.get('matches', [])) > 0
      connector:
        name: enrich-matched-events
        command: enrich_matched_events
      inputs:
        matches: $.get('matches', [])
      outputs:
        enriched_events: $.get('enriched_events', [])

    # Save enriched Kalshi events
    - type: document
      name: save-enriched-kalshi-events
      condition: len($.get('enriched_events', [])) > 0
      config:
        action: bulk-update
        embed-selector: $.get('originalTitle')
        embed-vector: true
        force-update: true
      connector:
        name: machina-ai
        command: invoke_embedding
        model: text-embedding-3-small
      document_name: "'kalshi-events'"
      documents:
        items: "$.get('enriched_events', [])"
