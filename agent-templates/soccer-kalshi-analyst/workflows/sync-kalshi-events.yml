workflow:
  name: soccer-kalshi-sync-events-by-series
  title: Soccer - Sync Kalshi Soccer Events
  description: Syncs Kalshi soccer GAME events from all leagues and matches them with sport:Event fixtures using fuzzy matching.
  context-variables:
    debugger:
      enabled: true
    machina-ai:
      api_key: $TEMP_CONTEXT_VARIABLE_SDK_OPENAI_API_KEY
  inputs:
    force_update: $.get('force_update', False)
  outputs:
    events_synced: $.get('total_events_synced', 0)
    events_matched: $.get('match_count', 0)
    workflow-status: "'executed'"
  tasks:

    # Load leagues configuration
    - type: document
      name: load-kalshi-leagues-config
      config:
        action: search
        search-limit: 1
        search-vector: false
      inputs:
        name: "'kalshi-leagues-config'"
      outputs:
        leagues_config: "$.get('documents')[0].get('value', {}).get('leagues', []) if len($.get('documents', [])) > 0 else []"

    # Load events dynamically for all enabled leagues
    - type: connector
      name: load-league-events
      condition: "len($.get('leagues_config', [])) > 0"
      connector:
        name: kalshi
        command: get-events
      foreach:
        name: league
        expr: $
        value: $.get('leagues_config', [])
      inputs:
        series_ticker: "$.get('league').get('series_ticker')"
      outputs:
        all_events: $.get('events', [])

    # Load sport:Event fixtures for matching
    - type: document
      name: load-fixtures
      condition: len($.get('all_events', [])) > 0
      config:
        action: search
        search-limit: 500
        search-vector: false
      filters:
        value.sport:status: "{'$in': ['NS', 'not_started']}"
        value.schema:startDate: "{'$gt': (datetime.utcnow() - timedelta(hours=24)).isoformat(), '$lt': (datetime.utcnow() + timedelta(days=14)).isoformat()}"
      inputs:
        name: "'sport:Event'"
      outputs:
        sport_events: $.get('documents', [])
        sport_events_count: len($.get('documents', []))

    # Fuzzy match Kalshi events to fixtures
    - type: connector
      name: fuzzy-match-events
      condition: $.get('sport_events_count', 0) > 0 and len($.get('all_events', [])) > 0
      connector:
        name: soccer-market-event-matcher
        command: match_markets_to_events
      inputs:
        markets: $.get('all_events', [])
        events: $.get('sport_events', [])
        name_threshold: 0.4
        date_tolerance_hours: 24
      outputs:
        matches: $.get('matches', [])
        match_count: $.get('match_count', 0)

    # Build enriched events from matches
    - type: connector
      name: enrich-matched-events
      condition: len($.get('matches', [])) > 0
      connector:
        name: enrich-matched-events
        command: enrich_matched_events
      inputs:
        matches: $.get('matches', [])
      outputs:
        enriched_events: $.get('enriched_events', [])

    # Save enriched Kalshi events
    - type: document
      name: save-enriched-kalshi-events
      condition: len($.get('enriched_events', [])) > 0
      config:
        action: bulk-update
        embed-selector: $.get('originalTitle')
        embed-vector: true
        force-update: true
      connector:
        name: machina-ai
        command: invoke_embedding
        model: text-embedding-3-small
      document_name: "'kalshi-events'"
      documents:
        items: "$.get('enriched_events', [])"
