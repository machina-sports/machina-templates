workflow:
  name: soccer-kalshi-sync
  title: Soccer - Sync Kalshi Soccer Events
  description: Syncs Kalshi soccer events from all leagues and matches them with sport:Event fixtures using fuzzy matching.
  context-variables:
    debugger:
      enabled: true
    machina-ai:
      api_key: $TEMP_CONTEXT_VARIABLE_SDK_OPENAI_API_KEY
  inputs:
    force_update: $.get('force_update', False)
  outputs:
    events_synced: $.get('total_events_synced', 0)
    events_matched: $.get('match_count', 0)
    workflow-status: "'executed'"
  tasks:

    # EPL BTTS
    - type: connector
      name: load-epl-btts
      connector:
        name: kalshi
        command: get-events
      inputs:
        series_ticker: "'KXEPLBTTS'"
      outputs:
        epl_btts_events: $.get('events', [])

    # Serie A BTTS
    - type: connector
      name: load-seriea-btts
      connector:
        name: kalshi
        command: get-events
      inputs:
        series_ticker: "'KXSERIEABTTS'"
      outputs:
        seriea_btts_events: $.get('events', [])

    # Bundesliga BTTS
    - type: connector
      name: load-bundesliga-btts
      connector:
        name: kalshi
        command: get-events
      inputs:
        series_ticker: "'KXBUNDESLIGABTTS'"
      outputs:
        bundesliga_btts_events: $.get('events', [])

    # La Liga BTTS
    - type: connector
      name: load-laliga-btts
      connector:
        name: kalshi
        command: get-events
      inputs:
        series_ticker: "'KXLALIGABTTS'"
      outputs:
        laliga_btts_events: $.get('events', [])

    # Liga Portugal BTTS
    - type: connector
      name: load-ligaportugal-btts
      connector:
        name: kalshi
        command: get-events
      inputs:
        series_ticker: "'KXLIGAPORTUGALBTTS'"
      outputs:
        ligaportugal_btts_events: $.get('events', [])

    # Combine and map all events
    - type: mapping
      name: kalshi-soccer-event-mapping
      inputs:
        events: |
          list($.get('epl_btts_events', [])) + 
          list($.get('seriea_btts_events', [])) + 
          list($.get('bundesliga_btts_events', [])) + 
          list($.get('laliga_btts_events', [])) + 
          list($.get('ligaportugal_btts_events', []))
      outputs:
        mapped_events: $.get('mapped-events', [])
        total_events_synced: |
          len(list($.get('epl_btts_events', []))) + 
          len(list($.get('seriea_btts_events', []))) + 
          len(list($.get('bundesliga_btts_events', []))) + 
          len(list($.get('laliga_btts_events', []))) + 
          len(list($.get('ligaportugal_btts_events', [])))

    # Load sport:Event fixtures for matching
    - type: document
      name: load-fixtures
      condition: len($.get('mapped_events', [])) > 0
      config:
        action: search
        search-limit: 500
        search-vector: false
      filters:
        value.sport:status: "{'$in': ['NS', 'not_started']}"
        value.schema:startDate: "{'$gt': (datetime.utcnow() - timedelta(hours=24)).isoformat(), '$lt': (datetime.utcnow() + timedelta(days=14)).isoformat()}"
      inputs:
        name: "'sport:Event'"
      outputs:
        sport_events: $.get('documents', [])
        sport_events_count: len($.get('documents', []))

    # Fuzzy match Kalshi events to fixtures
    - type: connector
      name: fuzzy-match-events
      condition: $.get('sport_events_count', 0) > 0 and len($.get('mapped_events', [])) > 0
      connector:
        name: soccer-market-event-matcher
        command: match_markets_to_events
      inputs:
        markets: $.get('mapped_events', [])
        events: $.get('sport_events', [])
        name_threshold: 0.4
        date_tolerance_hours: 24
      outputs:
        matches: $.get('matches', [])
        match_count: $.get('match_count', 0)

    # Build enriched events from matches
    - type: context
      name: enrich-matched-events
      condition: len($.get('matches', [])) > 0
      outputs:
        enriched_events: |
          [
            {
              **match.get('market', {}),
              'eventCode': match.get('event_code'),
              'match_confidence': match.get('confidence', 0.0),
              'matched_fixture': match.get('event', {}).get('value', {}).get('title', ''),
              'metadata': {
                **match.get('market', {}).get('metadata', {}),
                'eventCode': match.get('event_code'),
                'fixture_id': match.get('event', {}).get('metadata', {}).get('fixture_id')
              }
            }
            for match in $.get('matches', [])
          ]

    # Save enriched Kalshi events
    - type: document
      name: save-enriched-kalshi-events
      condition: len($.get('enriched_events', [])) > 0
      config:
        action: bulk-update
        embed-selector: $.get('originalTitle')
        embed-vector: true
        force-update: true
      connector:
        name: machina-ai
        command: invoke_embedding
        model: text-embedding-3-small
      document_name: "'kalshi-events'"
      documents:
        items: |
          [
            {
              **event,
              'title': event.get('id', '') + ' - ' + event.get('originalTitle', ''),
              'metadata': {
                'id': event.get('id'),
                'seriesId': event.get('seriesId'),
                'eventCode': event.get('eventCode'),
                'fixture_id': event.get('metadata', {}).get('fixture_id'),
                'match_confidence': event.get('match_confidence', 0.0)
              }
            }
            for event in $.get('enriched_events', [])
          ]
