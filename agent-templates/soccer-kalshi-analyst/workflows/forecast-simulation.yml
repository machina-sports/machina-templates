workflow:
  name: soccer-forecast-simulation
  title: Soccer Match Simulation & Pricing
  description: Phase 3B - Run Monte Carlo simulation and generate final prediction
  context-variables:
    debugger:
      enabled: true
    google-genai:
      credential: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL"
      project_id: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID"
      api_key: "$TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY"
  inputs:
    eventCode: "$.get('eventCode')"
    analyst_document_id: "$.get('analyst_document_id')"
  outputs:
    workflow-status: "$.get('workflow_executed_status', 'executed')"
    prediction_document_id: "$.get('prediction_document_id')"
  tasks:
    # 1. Load analyst report from previous phase
    - type: document
      name: load-analyst-report
      config:
        action: search
        search-limit: 1
      filters:
        document_id: $.get('analyst_document_id')
      inputs:
        name: "'soccer-analyst-report'"
      outputs:
        h_name: "$.get('documents')[0].get('value', {}).get('home_team', '') if len($.get('documents', [])) > 0 else ''"
        a_name: "$.get('documents')[0].get('value', {}).get('away_team', '') if len($.get('documents', [])) > 0 else ''"
        league: "$.get('documents')[0].get('value', {}).get('league', '39') if len($.get('documents', [])) > 0 else '39'"
        season: "$.get('documents')[0].get('value', {}).get('season', '2025') if len($.get('documents', [])) > 0 else '2025'"
        match_date: "$.get('documents')[0].get('value', {}).get('match_date', '') if len($.get('documents', [])) > 0 else ''"
        feature_payload: "$.get('documents')[0].get('value', {}).get('feature_payload', {}) if len($.get('documents', [])) > 0 else {}"
        evidence: "$.get('documents')[0].get('value', {}).get('evidence', {}) if len($.get('documents', [])) > 0 else {}"
        stats_out: "$.get('documents')[0].get('value', {}).get('analyst_outputs', {}).get('stats', {}) if len($.get('documents', [])) > 0 else {}"
        evidence_out: "$.get('documents')[0].get('value', {}).get('analyst_outputs', {}).get('evidence', {}) if len($.get('documents', [])) > 0 else {}"
        matchup_out: "$.get('documents')[0].get('value', {}).get('analyst_outputs', {}).get('matchup', {}) if len($.get('documents', [])) > 0 else {}"
        risk_out: "$.get('documents')[0].get('value', {}).get('analyst_outputs', {}).get('risk', {}) if len($.get('documents', [])) > 0 else {}"
        feature_document_id: "$.get('documents')[0].get('value', {}).get('feature_document_id', '') if len($.get('documents', [])) > 0 else ''"
        competition_context: "{'league': $.get('documents')[0].get('value', {}).get('feature_payload', {}).get('meta', {}).get('league', $.get('league', '39')) if len($.get('documents', [])) > 0 else $.get('league', '39'), 'season': $.get('documents')[0].get('value', {}).get('feature_payload', {}).get('meta', {}).get('season', $.get('season', '2025')) if len($.get('documents', [])) > 0 else $.get('season', '2025')}"
        pricing_context: "{'home_name': $.get('h_name', ''), 'away_name': $.get('a_name', '')}"
        workflow_executed_status: "'executed'"

    # 2. Simulation Parameterizer - Convert analysis to simulation parameters (optimized: uses competition_context instead of full feature_payload)
    - type: prompt
      name: simulation_parameterizer
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        feature_payload: "$.get('competition_context', {})"
        components: "{'stats': $.get('stats_out'), 'evidence': $.get('evidence_out'), 'matchup': $.get('matchup_out')}"
        risk: "$.get('risk_out')"
      outputs:
        sim_params: "$"

    # 3. Monte Carlo Simulation - Run 10k iterations
    - type: connector
      name: monte-carlo
      connector:
        name: soccer-monte-carlo
        command: run_monte_carlo_simulation
      inputs:
        simulation_parameters: "$.get('sim_params')"
        num_simulations: 10000
      outputs:
        sim_results: "$.get('simulation_results')"

    # 4. Final Pricing - Generate calibrated prediction (optimized: uses minimal pricing_context instead of full feature_payload)
    - type: prompt
      name: final_pricing
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        feature_payload: "$.get('pricing_context', {})"
        components: "{'stats': $.get('stats_out'), 'evidence': $.get('evidence_out'), 'matchup': $.get('matchup_out'), 'risk': $.get('risk_out')}"
        sim_results: "$.get('sim_results')"
      outputs:
        final_prediction: "$"

    # 5. Store final prediction (optimized: prediction output + simulation summary + references)
    - type: document
      name: store-prediction
      config:
        action: save
      documents:
        soccer-prediction: |
          {
            'title': $.get('h_name', '') + ' vs ' + $.get('a_name', '') + ' - AI Forecast',
            'fixture_id': str($.get('eventCode')),
            'matchup': $.get('h_name', '') + ' vs ' + $.get('a_name', ''),
            'home_team': $.get('h_name', ''),
            'away_team': $.get('a_name', ''),
            'league': $.get('league'),
            'season': $.get('season'),
            'match_date': $.get('match_date'),
            'prediction': $.get('final_prediction'),
            'simulation_summary': {
              'params': $.get('sim_params'),
              'simulations_run': $.get('sim_results', {}).get('simulations_run', 10000),
              'method': $.get('sim_results', {}).get('method', 'dixon_coles_poisson')
            },
            'confidence': $.get('risk_out', {}).get('confidence', 0.5),
            'abstain_recommended': $.get('risk_out', {}).get('abstain', False),
            'analyst_document_id': $.get('analyst_document_id'),
            'feature_document_id': $.get('feature_document_id'),
            'timestamp': datetime.utcnow().isoformat()
          }
      metadata:
        eventCode: "$.get('eventCode')"
        home_team: "$.get('h_name', '')"
        away_team: "$.get('a_name', '')"
        league: "$.get('league')"
        season: "$.get('season')"
        match_date: "$.get('match_date')"
        confidence: "$.get('risk_out', {}).get('confidence', 0.5)"
        abstain: "$.get('risk_out', {}).get('abstain', False)"
        document_type: "'prediction'"
        phase: "'forecasting'"
      outputs:
        prediction_document_id: "$.get('documents')[0].get('_id')"

