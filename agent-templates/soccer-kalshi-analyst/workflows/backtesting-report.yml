workflow:
  name: soccer-backtesting-report
  title: Soccer Backtesting Report Generator
  description: Aggregates audit metrics from multiple predictions to generate a comprehensive backtesting report with Brier scores, calibration curves, and ROI by tier.
  inputs:
    league: "$.get('league')"
    season: "$.get('season')"
    report_name: "$.get('report_name', 'backtesting-report')"
  outputs:
    workflow-status: "$.get('workflow_status', 'executed')"
    report_document_id: "$.get('report_document_id')"
    total_predictions: "$.get('total_predictions', 0)"
  tasks:
    # 1. Search all audit documents (optionally filtered by league/season)
    - type: document
      name: load-audits
      config:
        action: search
        search-limit: 500
      filters:
        metadata.document_type: "'audit'"
      inputs:
        name: "'soccer-prediction-audit'"
      outputs:
        audit_documents: "$.get('documents', [])"
        audit_count: "len($.get('documents', []))"

    # 2. Filter by league/season if provided
    - type: connector
      name: filter-audits
      condition: "$.get('audit_count', 0) > 0"
      connector:
        name: soccer-audit-calculator
        command: aggregate_audit_metrics
      inputs:
        audit_results: |
          [
            doc.get('value', doc) for doc in $.get('audit_documents', [])
            if (not $.get('league') or doc.get('metadata', {}).get('league') == $.get('league'))
            and (not $.get('season') or doc.get('metadata', {}).get('season') == $.get('season'))
          ]
      outputs:
        backtesting_report: "$.get('backtesting_report')"
        total_predictions: "$.get('backtesting_report', {}).get('total_predictions', 0)"

    # 3. Store backtesting report
    - type: document
      name: store-report
      condition: "$.get('backtesting_report') is not None"
      config:
        action: save
      documents:
        soccer-backtesting-report: |
          {
            'title': $.get('report_name', 'Backtesting Report') + ' - ' + ($.get('league') or 'All Leagues'),
            'league': $.get('league'),
            'season': $.get('season'),
            **$.get('backtesting_report', {})
          }
      metadata:
        report_name: "$.get('report_name', 'backtesting-report')"
        league: "$.get('league')"
        season: "$.get('season')"
        total_predictions: "$.get('total_predictions', 0)"
        brier_score: "$.get('backtesting_report', {}).get('brier_scores', {}).get('avg_1x2')"
        document_type: "'report'"
      outputs:
        report_document_id: "$.get('document_id')"
        workflow_status: "'report_generated'"

