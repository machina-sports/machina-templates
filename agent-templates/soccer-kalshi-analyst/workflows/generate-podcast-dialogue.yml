workflow:
  name: soccer-generate-podcast-dialogue
  title: Soccer Podcast Dialogue Generator (Home vs Away)
  description: Generate a clip-ready two-actor podcast dialogue from AI forecasts and optional Kalshi edge analysis
  context-variables:
    debugger:
      enabled: true
    google-genai:
      credential: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL"
      project_id: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID"
      api_key: "$TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY"
  inputs:
    eventCode: "$.get('eventCode')"
  outputs:
    workflow-status: "$.get('workflow_executed_status', 'executed')"
    podcast_script_document_id: "$.get('podcast_script_document_id')"
  tasks:
    # 1. Load latest AI prediction
    - type: document
      name: load-prediction
      config:
        action: search
        search-limit: 1
        sorters: [["_id", -1]]
      filters:
        metadata.eventCode: $.get('eventCode')
      inputs:
        name: "'soccer-prediction'"
      outputs:
        prediction_doc: "$.get('documents')[0].get('value') if len($.get('documents', [])) > 0 else None"
        h_name: "$.get('documents')[0].get('value', {}).get('home_team', '') if len($.get('documents', [])) > 0 else ''"
        a_name: "$.get('documents')[0].get('value', {}).get('away_team', '') if len($.get('documents', [])) > 0 else ''"
        workflow_executed_status: "'executed'"

    # 2. Load latest Kalshi analysis (optional)
    - type: document
      name: load-kalshi-analysis
      config:
        action: search
        search-limit: 1
        sorters: [["_id", -1]]
      filters:
        metadata.eventCode: $.get('eventCode')
      inputs:
        name: "'soccer-kalshi-analysis'"
      outputs:
        kalshi_doc: "$.get('documents')[0].get('value') if len($.get('documents', [])) > 0 else None"

    # 3. Generate podcast dialogue
    - type: prompt
      name: podcast_dialogue_generator
      condition: "$.get('prediction_doc') is not None"
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        prediction_doc: "$.get('prediction_doc')"
        kalshi_analysis_doc: "$.get('kalshi_doc')"
      outputs:
        podcast_script: "$"

    # 4. Store podcast script
    - type: document
      name: store-podcast-script
      condition: "$.get('podcast_script') is not None"
      config:
        action: save
      documents:
        soccer-podcast-script: |
          {
            'title': $.get('h_name', '') + ' vs ' + $.get('a_name', '') + ' - Podcast Dialogue',
            'eventCode': $.get('eventCode'),
            'matchup': $.get('h_name', '') + ' vs ' + $.get('a_name', ''),
            'home_team': $.get('h_name', ''),
            'away_team': $.get('a_name', ''),
            'script': $.get('podcast_script'),
            'timestamp': datetime.utcnow().isoformat()
          }
      metadata:
        eventCode: "$.get('eventCode')"
        document_type: "'podcast-dialogue'"
      outputs:
        podcast_script_document_id: "$.get('documents')[0].get('_id')"

