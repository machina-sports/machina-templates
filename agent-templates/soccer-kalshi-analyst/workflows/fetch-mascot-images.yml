workflow:
  name: soccer-fetch-mascot-images
  title: Soccer Fetch Mascot Images & Generate Podcast Frames
  description: Fetch mascot images for home and away teams, then generate podcast studio frames for video production
  context-variables:
    debugger:
      enabled: true
    google-genai:
      credential: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL
      project_id: $TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID
      api_key: $TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY
    google-storage:
      api_key: $TEMP_CONTEXT_VARIABLE_GOOGLE_STORAGE_API_KEY
      bucket_name: $TEMP_CONTEXT_VARIABLE_GOOGLE_STORAGE_BUCKET_NAME
    oxylabs:
      username: $TEMP_CONTEXT_VARIABLE_OXYLABS_USERNAME
      password: $TEMP_CONTEXT_VARIABLE_OXYLABS_PASSWORD
  inputs:
    eventCode: "$.get('eventCode')"
    geo_location: $.get('geo_location', 'United States')
    limit: $.get('limit', 1)
    parser: ($.get('parser', 'true') == 'true') and True or False
    source: $.get('source', 'google_search')
    udm: int($.get('udm', 2))
  outputs:
    workflow-status: "$.get('workflow_executed_status', 'executed')"
    mascot_document_id: "$.get('mascot_document_id')"
    home_mascot_url: "$.get('home_mascot_url')"
    away_mascot_url: "$.get('away_mascot_url')"
    home_podcast_frame_url: "$.get('home_podcast_frame_url')"
    away_podcast_frame_url: "$.get('away_podcast_frame_url')"
  tasks:

    # 1. Load latest AI prediction to get team names
    - type: document
      name: load-prediction
      config:
        action: search
        search-limit: 1
        sorters: [["_id", -1]]
      filters:
        metadata.eventCode: $.get('eventCode')
      inputs:
        name: "'soccer-prediction'"
      outputs:
        prediction_exists: len($.get('documents', [])) > 0
        home_team: "$.get('documents')[0].get('value', {}).get('home_team', '') if len($.get('documents', [])) > 0 else ''"
        away_team: "$.get('documents')[0].get('value', {}).get('away_team', '') if len($.get('documents', [])) > 0 else ''"
        workflow_executed_status: "'executed'"

    # 2. Search for HOME team mascot image
    - type: connector
      name: search-home-mascot
      description: Search Google Images for home team mascot
      condition: "$.get('prediction_exists') and $.get('home_team') != ''"
      connector:
        name: oxylabs
        command: post-queries
      continue_on_error: true
      inputs:
        body: |
          {
            "context": [
              {
                "key": "udm",
                "value": $.get('udm')
              },
              {
                "key": "limit_per_page",
                "value": [
                  {
                    "page": 1,
                    "limit": $.get('limit')
                  }
                ]
              }
            ],
            "geo_location": $.get('geo_location'),
            "parse": $.get('parser'),
            "query": $.get('home_team') + " football club mascot official",
            "source": $.get('source')
          }
      outputs:
        home_image_results: "$.get('results', [])[0].get('content').get('results', {}).get('organic', [])[:1] if $.get('results', []) and $.get('results', [])[0].get('content') else []"

    # 3. Search for AWAY team mascot image
    - type: connector
      name: search-away-mascot
      description: Search Google Images for away team mascot
      condition: "$.get('prediction_exists') and $.get('away_team') != ''"
      connector:
        name: oxylabs
        command: post-queries
      continue_on_error: true
      inputs:
        body: |
          {
            "context": [
              {
                "key": "udm",
                "value": $.get('udm')
              },
              {
                "key": "limit_per_page",
                "value": [
                  {
                    "page": 1,
                    "limit": $.get('limit')
                  }
                ]
              }
            ],
            "geo_location": $.get('geo_location'),
            "parse": $.get('parser'),
            "query": $.get('away_team') + " football club mascot official",
            "source": $.get('source')
          }
      outputs:
        away_image_results: "$.get('results', [])[0].get('content').get('results', {}).get('organic', [])[:1] if $.get('results', []) and $.get('results', [])[0].get('content') else []"

    # 4. Download HOME mascot image to tmp
    - type: connector
      name: download-home-mascot
      description: Save the home mascot image to tmp
      condition: "len($.get('home_image_results', [])) > 0"
      connector:
        name: temp-downloader
        command: invoke_save_to_tmp
      inputs:
        image_base64: "$.get('home_image_results', [])[0].get('image', '') if len($.get('home_image_results', [])) > 0 else ''"
      outputs:
        home_mascot_tmp_path: "$.get('image_path')"
        reference_images: |
          [
            $.get('image_path')
          ]

    # 5. Download AWAY mascot image to tmp
    - type: connector
      name: download-away-mascot
      description: Save the away mascot image to tmp
      condition: "len($.get('away_image_results', [])) > 0"
      connector:
        name: temp-downloader
        command: invoke_save_to_tmp
      inputs:
        image_base64: "$.get('away_image_results', [])[0].get('image', '') if len($.get('away_image_results', [])) > 0 else ''"
      outputs:
        away_mascot_tmp_path: "$.get('image_path')"
        away_reference_images: |
          [
            $.get('image_path')
          ]

    # 6. Upload HOME mascot reference to Google Storage
    - type: connector
      name: upload-home-mascot
      description: Upload home mascot reference image to Google Storage
      condition: "$.get('home_mascot_tmp_path') is not None"
      connector:
        name: google-storage
        command: invoke_upload
      inputs:
        image_path: "$.get('home_mascot_tmp_path')"
      outputs:
        home_mascot_url: "$.get('url')"

    # 7. Upload AWAY mascot reference to Google Storage
    - type: connector
      name: upload-away-mascot
      description: Upload away mascot reference image to Google Storage
      condition: "$.get('away_mascot_tmp_path') is not None"
      connector:
        name: google-storage
        command: invoke_upload
      inputs:
        image_path: "$.get('away_mascot_tmp_path')"
      outputs:
        away_mascot_url: "$.get('url')"

    # 8. Generate HOME mascot podcast frame (looking RIGHT, positioned LEFT)
    - type: connector
      name: generate-home-podcast-frame
      description: Generate AI image of HOME mascot in podcast studio, looking right
      condition: "$.get('home_mascot_tmp_path') is not None"
      connector:
        name: google-genai
        command: invoke_image
      inputs:
        aspect_ratio: "'9:16'"
        image_paths: "$.get('reference_images', [])"
        model_name: "'gemini-3-pro-image-preview'"
        prompt: |
          "Generate a PHOTOREALISTIC image of the {{home_team}} official team mascot as a REAL LIVING VERSION of that exact character in a podcast studio.\n\nMASCOT IDENTITY - CRITICAL: Study the reference image carefully. PRESERVE the mascot's EXACT distinctive features: specific colors, unique markings, facial characteristics, expression style, and personality. This must be RECOGNIZABLE as the team's actual mascot character - not a generic animal. If the mascot is green with specific spots, keep those. If it has a particular friendly face shape, keep that. The character design must match the reference.\n\nREALISM: Render this specific mascot character as if it were a REAL LIVING CREATURE - with real skin/fur/scale texture, real eyes with depth and life, natural lighting on the body. Imagine the mascot character came to life as a real being, maintaining all its unique design features but with photorealistic rendering. NOT a costume, NOT a human in a suit - a living breathing version of that exact mascot character.\n\nCHARACTER POSE: Wearing casual clothing or team jersey. Black over-ear headphones. Expressive face matching the mascot's personality, mouth slightly open as if speaking enthusiastically. Positioned LEFT side of frame, body oriented toward someone across the table. Looking strictly toward the right side of the frame (PROFILE or 3/4 VIEW) at the other host. NEVER looking at the camera/lens. Upper body shot.\n\nSTUDIO: Dark charcoal acoustic foam panels (#2D2D2D). Warm key light front-left, blue/purple RGB accent on back wall. Silver podcast mic bottom-right. Slight background bokeh.\n\nCOMPOSITION: 9:16 portrait. Character LEFT, looking RIGHT (Side profile or 3/4 view). EYES AVERTED from camera. Medium close-up. Eye-level. Shallow depth of field.\n\nPROHIBITED: NO generic animals - must look like THE SPECIFIC MASCOT. NO mascot costumes or humans in suits. NO costume seams/zippers/fabric texture. NO text/logos/watermarks. NO EYE CONTACT with camera. Must look RIGHT."
      outputs:
        home_podcast_frame_path: "$.get('image_path')"

    # 9. Generate AWAY mascot podcast frame (looking LEFT, positioned RIGHT)
    - type: connector
      name: generate-away-podcast-frame
      description: Generate AI image of AWAY mascot in podcast studio, looking left
      condition: "$.get('away_mascot_tmp_path') is not None"
      connector:
        name: google-genai
        command: invoke_image
      inputs:
        aspect_ratio: "'9:16'"
        image_paths: "$.get('away_reference_images', [])"
        model_name: "'gemini-3-pro-image-preview'"
        prompt: |
          "Generate a PHOTOREALISTIC image of the {{away_team}} official team mascot as a REAL LIVING VERSION of that exact character in a podcast studio.\n\nMASCOT IDENTITY - CRITICAL: Study the reference image carefully. PRESERVE the mascot's EXACT distinctive features: specific colors, unique markings, facial characteristics, expression style, and personality. This must be RECOGNIZABLE as the team's actual mascot character - not a generic animal. If the mascot has specific coloring, patterns, or facial features, keep those exactly. The character design must match the reference.\n\nREALISM: Render this specific mascot character as if it were a REAL LIVING CREATURE - with real skin/fur/scale texture, real eyes with depth and life, natural lighting on the body. Imagine the mascot character came to life as a real being, maintaining all its unique design features but with photorealistic rendering. NOT a costume, NOT a human in a suit - a living breathing version of that exact mascot character.\n\nCHARACTER POSE: Wearing casual clothing with team colors or team jersey. Black over-ear headphones. Expressive face matching the mascot's personality, showing skeptical or reactive expression. Positioned RIGHT side of frame, body oriented toward someone across the table. Looking strictly toward the left side of the frame (PROFILE or 3/4 VIEW) at the other host. NEVER looking at the camera/lens. Upper body shot.\n\nSTUDIO: Dark charcoal acoustic foam panels (#2D2D2D). Warm key light front-right, blue/purple RGB accent on back wall. Silver podcast mic bottom-left. Slight background bokeh.\n\nCOMPOSITION: 9:16 portrait. Character RIGHT, looking LEFT (Side profile or 3/4 view). EYES AVERTED from camera. Medium close-up. Eye-level. Shallow depth of field.\n\nPROHIBITED: NO generic animals - must look like THE SPECIFIC MASCOT. NO mascot costumes or humans in suits. NO costume seams/zippers/fabric texture. NO text/logos/watermarks. NO EYE CONTACT with camera. Must look LEFT."
      outputs:
        away_podcast_frame_path: "$.get('image_path')"

    # 10. Upload HOME podcast frame to Google Storage
    - type: connector
      name: upload-home-podcast-frame
      description: Upload generated HOME podcast frame to Google Storage
      condition: "$.get('home_podcast_frame_path') is not None"
      connector:
        name: google-storage
        command: invoke_upload
      inputs:
        image_path: "$.get('home_podcast_frame_path')"
      outputs:
        home_podcast_frame_url: "$.get('url')"

    # 11. Upload AWAY podcast frame to Google Storage
    - type: connector
      name: upload-away-podcast-frame
      description: Upload generated AWAY podcast frame to Google Storage
      condition: "$.get('away_podcast_frame_path') is not None"
      connector:
        name: google-storage
        command: invoke_upload
      inputs:
        image_path: "$.get('away_podcast_frame_path')"
      outputs:
        away_podcast_frame_url: "$.get('url')"

    # 12. Store all mascot and podcast frame URLs in a document
    - type: document
      name: store-mascot-images
      condition: "$.get('home_mascot_url') is not None or $.get('away_mascot_url') is not None"
      config:
        action: save
      documents:
        soccer-mascot-images: |
          {
            'title': $.get('home_team', '') + ' vs ' + $.get('away_team', '') + ' - Mascot & Podcast Frames',
            'eventCode': $.get('eventCode'),
            'matchup': $.get('home_team', '') + ' vs ' + $.get('away_team', ''),
            'home_team': $.get('home_team', ''),
            'away_team': $.get('away_team', ''),
            'home_mascot_url': $.get('home_mascot_url'),
            'away_mascot_url': $.get('away_mascot_url'),
            'home_podcast_frame_url': $.get('home_podcast_frame_url'),
            'away_podcast_frame_url': $.get('away_podcast_frame_url'),
            'home_mascot_query': $.get('home_team') + ' football club mascot official',
            'away_mascot_query': $.get('away_team') + ' football club mascot official',
            'timestamp': datetime.utcnow().isoformat()
          }
      metadata:
        eventCode: "$.get('eventCode')"
        document_type: "'mascot-images'"
      outputs:
        mascot_document_id: "$.get('documents')[0].get('_id')"
