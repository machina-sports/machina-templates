workflow:
  name: soccer-kalshi-sync-events-single-series
  title: Soccer - Sync Kalshi Events (Single Series, Paginated)
  description: |
    Fetches Kalshi GAME events for a single series_ticker with cursor pagination (up to 400 via 2 pages),
    then fuzzy-matches them against sport:Event fixtures and persists enriched kalshi-events docs.
  context-variables:
    debugger:
      enabled: true
  inputs:
    league_id: $.get('league_id')
    series_ticker: $.get('series_ticker')
    # Desired total events to fetch (implemented as 2 pages max: 200 + 200)
    desired_limit: $.get('desired_limit', 400)
    force_update: $.get('force_update', False)
  outputs:
    series_ticker: $.get('series_ticker')
    events_synced: $.get('total_events_synced', 0)
    events_matched: $.get('match_count', 0)
    workflow-status: "'executed'"
  tasks:

    # Page 1: Kalshi events (API max limit is 200)
    - type: connector
      name: load-events-page-1
      condition: $.get('series_ticker') is not None
      connector:
        name: kalshi
        command: get-events
      inputs:
        series_ticker: $.get('series_ticker')
        limit: 200 if int($.get('desired_limit', 400)) > 200 else int($.get('desired_limit', 400))
      outputs:
        events_page_1: $.get('events', [])
        cursor_page_1: $.get('cursor', '')

    # Page 2: Kalshi events, if requested
    - type: connector
      name: load-events-page-2
      condition: int($.get('desired_limit', 400)) > 200 and $.get('cursor_page_1', '') not in [None, '']
      connector:
        name: kalshi
        command: get-events
      inputs:
        series_ticker: $.get('series_ticker')
        cursor: $.get('cursor_page_1')
        limit: 200 if int($.get('desired_limit', 400)) >= 400 else (int($.get('desired_limit', 400)) - 200)
      outputs:
        events_page_2: $.get('events', [])

    # Combine pages
    - type: mapping
      name: combine-events
      inputs:
        events_page_1: $.get('events_page_1', [])
        events_page_2: $.get('events_page_2', [])
      outputs:
        all_events: $.get('all_events', [])
        total_events_synced: len($.get('all_events', []))

    # Load sport:Event fixtures for matching (past + upcoming)
    - type: document
      name: load-fixtures
      condition: len($.get('all_events', [])) > 0
      config:
        action: search
        search-limit: 2500
        search-vector: false
      filters:
        value.sport:competition.@id: f"urn:apifootball:league:{$.get('league_id')}"
      inputs:
        name: "'sport:Event'"
      outputs:
        sport_events: $.get('documents', [])
        sport_events_count: len($.get('documents', []))

    # Fuzzy match
    - type: connector
      name: fuzzy-match-events
      condition: $.get('sport_events_count', 0) > 0 and len($.get('all_events', [])) > 0
      connector:
        name: soccer-market-event-matcher
        command: match_markets_to_events
      inputs:
        markets: $.get('all_events', [])
        events: $.get('sport_events', [])
        name_threshold: 0.4
        date_tolerance_hours: 24
      outputs:
        matches: $.get('matches', [])
        match_count: $.get('match_count', 0)

    # Enrich
    - type: connector
      name: enrich-matched-events
      condition: len($.get('matches', [])) > 0
      connector:
        name: enrich-matched-events
        command: enrich_matched_events
      inputs:
        matches: $.get('matches', [])
      outputs:
        enriched_events: $.get('enriched_events', [])

    # Save enriched
    - type: document
      name: save-enriched-kalshi-events
      condition: len($.get('enriched_events', [])) > 0
      config:
        action: bulk-update
        embed-selector: $.get('originalTitle')
        embed-vector: true
        force-update: true
      connector:
        name: machina-ai
        command: invoke_embedding
        model: text-embedding-3-small
      document_name: "'kalshi-events'"
      documents:
        items: "$.get('enriched_events', [])"

