workflow:
  name: soccer-kalshi-market-integration
  title: Soccer Kalshi Integration
  description: Connects soccer forecasts with real-time Kalshi markets.
  context-variables:
    debugger:
      enabled: true
    google-genai:
      credential: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL"
      project_id: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID"
      api_key: "$TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY"
  inputs:
    prediction_document_id: "$.get('document_id')"
  outputs:
    workflow-status: "'executed'"
  tasks:
    - type: document
      name: load-prediction
      config:
        action: search
        search-limit: 1
      filters:
        document_id: "$.get('prediction_document_id')"
      inputs:
        name: "'soccer-prediction'"
      outputs:
        prediction_val: "$.get('documents')[0].get('value') if len($.get('documents', [])) > 0 else {}"
        fixture_id: "$.get('documents')[0].get('value', {}).get('fixture_id') if len($.get('documents', [])) > 0 else None"

    - type: document
      name: load-kalshi-event
      condition: "$.get('fixture_id') is not None"
      config:
        action: search
        search-limit: 1
      filters:
        value.eventCode: "'urn:apifootball:sport_event:' + str($.get('fixture_id'))"
      inputs:
        name: "'kalshi-events'"
      outputs:
        event_exists: "len($.get('documents', [])) > 0"
        event_ticker: "$.get('documents')[0].get('metadata', {}).get('id') if len($.get('documents', [])) > 0 else None"

    - type: connector
      name: load-markets
      condition: "$.get('event_ticker') is not None"
      connector:
        name: kalshi
        command: get-markets
      inputs:
        event_ticker: "$.get('event_ticker')"
      outputs:
        markets: "$.get('markets', [])"

    - type: mapping
      name: kalshi-markets-summary
      condition: "len($.get('markets', [])) > 0"
      inputs:
        markets: "$.get('markets')"
      outputs:
        markets_summary: "$.get('markets_summary')"
        markets_count: "$.get('markets_count')"

    # Task name MUST match prompt name for type: prompt
    - type: prompt
      name: kalshi_edge_analyst
      condition: "$.get('markets_count', 0) > 0"
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        prediction_data: "$.get('prediction_val')"
        markets_summary: "$.get('markets_summary')"
      outputs:
        edge_analysis: "$"

    - type: document
      name: store-analysis
      condition: "$.get('edge_analysis') is not None"
      config:
        action: update
        force-update: true
      documents:
        soccer-kalshi-analysis: |
          {
            'prediction_id': $.get('prediction_document_id'),
            'fixture_id': $.get('fixture_id'),
            'analysis': $.get('edge_analysis', {}).get('analysis'),
            'summary': $.get('edge_analysis', {}).get('summary'),
            'selected': $.get('edge_analysis', {}).get('selected_market'),
            'markets_ranked': $.get('edge_analysis', {}).get('markets_ranked'),
            'should_trade': $.get('edge_analysis', {}).get('should_trade'),
            'timestamp': datetime.utcnow().isoformat()
          }
