workflow:
  name: soccer-collect-match-data
  title: Soccer Match Data Collection
  description: Phase 1 - Load event data, fetch team statistics, and gather news intelligence
  context-variables:
    debugger:
      enabled: true
    api-football:
      x-apisports-key: "$TEMP_CONTEXT_VARIABLE_API_FOOTBALL_API_KEY"
    google-genai:
      credential: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL"
      project_id: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID"
      api_key: "$TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY"
  inputs:
    eventCode: "$.get('eventCode')"
  outputs:
    workflow-status: "$.get('workflow_executed_status', 'executed')"
    data_document_id: "$.get('data_document_id')"
  tasks:
    # 1. Load match details
    - type: document
      name: load-event
      config:
        action: search
        search-limit: 1
      filters:
        metadata.event_code: $.get('eventCode')
      inputs:
        name: "'sport:Event'"
      outputs:
        event_doc: "$.get('documents')[0].get('value') if len($.get('documents', [])) > 0 else {}"
        league: "str($.get('documents')[0].get('value', {}).get('sport:competition', {}).get('@id', 'urn:apifootball:league:39')).split(':')[-1] if len($.get('documents', [])) > 0 else '39'"
        season: "str($.get('documents')[0].get('value', {}).get('sport:competition', {}).get('sport:season', {}).get('sport:year', '2025')) if len($.get('documents', [])) > 0 else '2025'"
        workflow_executed_status: "'executed'"

    # 2. Extract IDs for stats
    - type: connector
      name: extract-ids
      connector:
        name: soccer-aggregate-features
        command: aggregate_features
      inputs:
        event_doc: "$.get('event_doc')"
        fixture_id: "$.get('eventCode')"
      outputs:
        h_id: "$.get('feature_payload', {}).get('home', {}).get('id')"
        a_id: "$.get('feature_payload', {}).get('away', {}).get('id')"
        h_name: "$.get('feature_payload', {}).get('home', {}).get('name')"
        a_name: "$.get('feature_payload', {}).get('away', {}).get('name')"

    # 3. Fetch Stats
    - type: connector
      name: fetch-h-stats
      connector:
        name: api-football
        command: get-teams/statistics
      inputs:
        team: "$.get('h_id')"
        league: "$.get('league')"
        season: "$.get('season')"
      outputs:
        h_stats: "$"

    - type: connector
      name: fetch-a-stats
      connector:
        name: api-football
        command: get-teams/statistics
      inputs:
        team: "$.get('a_id')"
        league: "$.get('league')"
        season: "$.get('season')"
      outputs:
        a_stats: "$"

    # 4. Gather News - Task name MUST match prompt name
    - type: prompt
      name: news_query_generator
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        league: "$.get('league')"
        matchup: "$.get('h_name') + ' vs ' + $.get('a_name')"
        game_date: "$.get('event_doc', {}).get('schema:startDate')"
      outputs:
        news_queries: "$.get('news_queries', [])"

    - type: connector
      name: search-news
      condition: "len($.get('news_queries', [])) > 0"
      connector:
        name: google-genai
        command: invoke_search
        model: "gemini-3-pro-preview"
      foreach:
        concurrent: true
        name: query_obj
        expr: $
        value: $.get('news_queries')
      inputs:
        search_query: "$.get('query_obj').get('query')"
        recency_days: 3
      outputs:
        search_results: |
          [
            $.get('answer', '')
          ]

    - type: prompt
      name: news_evidence_extractor
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        matchup: "$.get('h_name') + ' vs ' + $.get('a_name')"
        search_results: "$.get('search_results', [])"
      outputs:
        evidence: "$"

    # 5. Store collected data for next phase
    - type: document
      name: store-match-data
      config:
        action: save
      documents:
        soccer-match-data: |
          {
            'title': $.get('h_name', '') + ' vs ' + $.get('a_name', '') + ' - Match Data',
            'eventCode': str($.get('eventCode')),
            'matchup': $.get('h_name', '') + ' vs ' + $.get('a_name', ''),
            'home_team': $.get('h_name', ''),
            'away_team': $.get('a_name', ''),
            'event_doc': $.get('event_doc'),
            'league': $.get('league'),
            'season': $.get('season'),
            'h_id': $.get('h_id'),
            'a_id': $.get('a_id'),
            'h_stats': $.get('h_stats'),
            'a_stats': $.get('a_stats'),
            'evidence': $.get('evidence', {}),
            'news_queries': $.get('news_queries', []),
            'search_results': $.get('search_results', []),
            'timestamp': datetime.utcnow().isoformat()
          }
      metadata:
        eventCode: "$.get('eventCode')"
        home_team: "$.get('h_name', '')"
        away_team: "$.get('a_name', '')"
        league: "$.get('league')"
        season: "$.get('season')"
        match_date: "$.get('event_doc', {}).get('schema:startDate')"
        document_type: "'match-data'"
        phase: "'data-collection'"
      outputs:
        data_document_id: "$.get('documents')[0].get('_id')"

