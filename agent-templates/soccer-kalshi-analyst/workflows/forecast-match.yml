workflow:
  name: soccer-forecast-match
  title: Soccer Match Forecast
  description: Full execution pipeline using statistical modeling and Kalshi market edge analysis.
  context-variables:
    debugger:
      enabled: true
    api-football:
      x-apisports-key: "$TEMP_CONTEXT_VARIABLE_API_FOOTBALL_API_KEY"
    google-genai:
      credential: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL"
      project_id: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID"
      api_key: "$TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY"
  inputs:
    eventCode: "$.get('eventCode')"
  outputs:
    workflow-status: "$.get('workflow_executed_status', 'executed')"
    prediction_document_id: "$.get('prediction_document_id')"
  tasks:
    # 1. Load match details
    - type: document
      name: load-event
      config:
        action: search
        search-limit: 1
      filters:
        metadata.event_code: $.get('eventCode')
      inputs:
        name: "'sport:Event'"
      outputs:
        event_doc: "$.get('documents')[0].get('value') if len($.get('documents', [])) > 0 else {}"
        league: "str($.get('documents')[0].get('value', {}).get('sport:competition', {}).get('@id', 'urn:apifootball:league:39')).split(':')[-1] if len($.get('documents', [])) > 0 else '39'"
        season: "str($.get('documents')[0].get('value', {}).get('sport:competition', {}).get('sport:season', {}).get('sport:year', '2025')) if len($.get('documents', [])) > 0 else '2025'"
        workflow_executed_status: "'executed'"

    # 2. Extract IDs for stats
    - type: connector
      name: extract-ids
      connector:
        name: soccer-aggregate-features
        command: aggregate_features
      inputs:
        event_doc: "$.get('event_doc')"
        fixture_id: "$.get('eventCode')"
      outputs:
        h_id: "$.get('feature_payload', {}).get('home', {}).get('id')"
        a_id: "$.get('feature_payload', {}).get('away', {}).get('id')"
        h_name: "$.get('feature_payload', {}).get('home', {}).get('name')"
        a_name: "$.get('feature_payload', {}).get('away', {}).get('name')"

    # 3. Fetch Stats
    - type: connector
      name: fetch-h-stats
      connector:
        name: api-football
        command: get-teams/statistics
      inputs:
        team: "$.get('h_id')"
        league: "$.get('league')"
        season: "$.get('season')"
      outputs:
        h_stats: "$"

    - type: connector
      name: fetch-a-stats
      connector:
        name: api-football
        command: get-teams/statistics
      inputs:
        team: "$.get('a_id')"
        league: "$.get('league')"
        season: "$.get('season')"
      outputs:
        a_stats: "$"

    # 4. Gather News - Task name MUST match prompt name
    - type: prompt
      name: news_query_generator
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        league: "$.get('league')"
        matchup: "$.get('h_name') + ' vs ' + $.get('a_name')"
        game_date: "$.get('event_doc', {}).get('schema:startDate')"
      outputs:
        news_queries: "$.get('news_queries', [])"

    - type: connector
      name: search-news
      condition: "len($.get('news_queries', [])) > 0"
      connector:
        name: google-genai
        command: invoke_search
        model: "gemini-3-pro-preview"
      foreach:
        concurrent: true
        name: query
        expr: $
        value: $.get('news_queries')
      inputs:
        search_query: "$.get('query')"
        recency_days: 3
      outputs:
        search_results: |
          [
            $.get('answer', '')
          ]

    - type: prompt
      name: news_evidence_extractor
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        matchup: "$.get('h_name') + ' vs ' + $.get('a_name')"
        search_results: "$.get('search_results', [])"
      outputs:
        evidence: "$"

    # 5. Build Final Feature Set
    - type: connector
      name: final-aggregation
      connector:
        name: soccer-aggregate-features
        command: aggregate_features
      inputs:
        event_doc: "$.get('event_doc')"
        home_stats: "$.get('h_stats')"
        away_stats: "$.get('a_stats')"
        news_deltas: "$.get('evidence')"
      outputs:
        feature_payload: "$.get('feature_payload')"

    # 6. Forecast - Task names MUST match prompt names
    - type: prompt
      name: forecast_stats_analyst
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        feature_payload: "$.get('feature_payload')"
      outputs:
        stats_out: "$"

    - type: prompt
      name: forecast_evidence_analyst
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        feature_payload: "$.get('feature_payload')"
        news_evidence: "$.get('evidence', {})"
        stats_baseline: "$.get('stats_out', {})"
      outputs:
        evidence_out: "$"

    - type: prompt
      name: forecast_matchup_analyst
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        feature_payload: "$.get('feature_payload')"
      outputs:
        matchup_out: "$"

    - type: prompt
      name: forecast_risk_officer
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        components: "{'stats': $.get('stats_out'), 'evidence': $.get('evidence_out'), 'matchup': $.get('matchup_out')}"
        feature_payload: "$.get('feature_payload')"
      outputs:
        risk_out: "$"

    - type: prompt
      name: simulation_parameterizer
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        feature_payload: "$.get('feature_payload')"
        components: "{'stats': $.get('stats_out'), 'evidence': $.get('evidence_out'), 'matchup': $.get('matchup_out')}"
        risk: "$.get('risk_out')"
      outputs:
        sim_params: "$"

    - type: connector
      name: monte-carlo
      connector:
        name: soccer-monte-carlo
        command: run_monte_carlo_simulation
      inputs:
        simulation_parameters: "$.get('sim_params')"
        num_simulations: 10000
      outputs:
        sim_results: "$.get('simulation_results')"

    - type: prompt
      name: final_pricing
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        feature_payload: "$.get('feature_payload')"
        components: "{'stats': $.get('stats_out'), 'evidence': $.get('evidence_out'), 'matchup': $.get('matchup_out'), 'risk': $.get('risk_out')}"
        sim_results: "$.get('sim_results')"
      outputs:
        final_prediction: "$"

    - type: document
      name: store-prediction
      config:
        action: save
      documents:
        soccer-prediction: |
          {
            'title': $.get('h_name', '') + ' vs ' + $.get('a_name', '') + ' - AI Forecast',
            'fixture_id': str($.get('eventCode')),
            'matchup': $.get('h_name', '') + ' vs ' + $.get('a_name', ''),
            'home_team': $.get('h_name', ''),
            'away_team': $.get('a_name', ''),
            'league': $.get('league'),
            'season': $.get('season'),
            'match_date': $.get('event_doc', {}).get('schema:startDate'),
            'prediction': $.get('final_prediction'),
            'analysis_components': {
              'statistical_baseline': $.get('stats_out'),
              'evidence_adjustment': $.get('evidence_out'),
              'tactical_matchup': $.get('matchup_out'),
              'risk_assessment': $.get('risk_out'),
              'simulation_params': $.get('sim_params'),
              'simulation_results_summary': {
                'simulations_run': $.get('sim_results', {}).get('simulations_run', 10000),
                'method': $.get('sim_results', {}).get('method', 'unknown')
              }
            },
            'news_evidence': $.get('evidence', {}),
            'confidence': $.get('risk_out', {}).get('confidence', 0.5),
            'abstain_recommended': $.get('risk_out', {}).get('abstain', False),
            'timestamp': datetime.utcnow().isoformat()
          }
      metadata:
        eventCode: "$.get('eventCode')"
        home_team: "$.get('h_name', '')"
        away_team: "$.get('a_name', '')"
        league: "$.get('league')"
        season: "$.get('season')"
        match_date: "$.get('event_doc', {}).get('schema:startDate')"
        confidence: "$.get('risk_out', {}).get('confidence', 0.5)"
        abstain: "$.get('risk_out', {}).get('abstain', False)"
        document_type: "'prediction'"
      outputs:
        prediction_document_id: "$.get('document_id')"

    # 7. Kalshi Integration
    - type: document
      name: load-kalshi
      config:
        action: search
        search-limit: 1
      filters:
        value.eventCode: $.get('eventCode')
      inputs:
        name: "'kalshi-events'"
      outputs:
        k_ticker: "$.get('documents')[0].get('value', {}).get('event_ticker') if len($.get('documents', [])) > 0 else None"

    - type: connector
      name: load-markets
      condition: "$.get('k_ticker') is not None"
      connector:
        name: kalshi
        command: get-markets
      inputs:
        event_ticker: "$.get('k_ticker')"
      outputs:
        markets: "$.get('markets', [])"

    - type: mapping
      name: kalshi-markets-summary
      condition: "len($.get('markets', [])) > 0"
      inputs:
        markets: "$.get('markets')"
      outputs:
        m_summary: "$.get('markets_summary')"
        m_count: "$.get('markets_count')"

    - type: prompt
      name: kalshi_edge_analyst
      condition: "$.get('m_count', 0) > 0"
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        prediction_data: "$.get('final_prediction')"
        markets_summary: "$.get('m_summary')"
      outputs:
        edge_analysis: "$"

    - type: document
      name: store-edge
      condition: "$.get('edge_analysis') is not None"
      config:
        action: save
      documents:
        soccer-kalshi-analysis: |
          {
            'title': $.get('h_name', '') + ' vs ' + $.get('a_name', '') + ' - Kalshi Edge Analysis',
            'eventCode': $.get('eventCode'),
            'matchup': $.get('h_name', '') + ' vs ' + $.get('a_name', ''),
            'home_team': $.get('h_name', ''),
            'away_team': $.get('a_name', ''),
            'prediction_id': $.get('prediction_document_id'),
            'analysis': $.get('edge_analysis', {}).get('analysis'),
            'summary': $.get('edge_analysis', {}).get('summary'),
            'selected': $.get('edge_analysis', {}).get('selected_market'),
            'markets_ranked': $.get('edge_analysis', {}).get('markets_ranked'),
            'should_trade': $.get('edge_analysis', {}).get('should_trade'),
            'confidence': $.get('edge_analysis', {}).get('overall_confidence'),
            'risk_warnings': $.get('edge_analysis', {}).get('risk_warnings', []),
            'timestamp': datetime.utcnow().isoformat()
          }
      metadata:
        eventCode: "$.get('eventCode')"
        home_team: "$.get('h_name', '')"
        away_team: "$.get('a_name', '')"
        match_date: "$.get('event_doc', {}).get('schema:startDate')"
        should_trade: "$.get('edge_analysis', {}).get('should_trade', False)"
        selected_ticker: "$.get('edge_analysis', {}).get('selected_market', {}).get('ticker', '')"
        selected_tier: "$.get('edge_analysis', {}).get('selected_market', {}).get('tier', 'PASS')"
        confidence: "$.get('edge_analysis', {}).get('overall_confidence', 0)"
        document_type: "'kalshi-edge'"
