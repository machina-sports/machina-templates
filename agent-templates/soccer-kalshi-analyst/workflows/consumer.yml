workflow:
  name: soccer-kalshi-analysis-consumer
  title: Soccer - Kalshi Analysis Consumer
  description: Find upcoming soccer fixtures from the database that haven't been processed yet.
  context-variables:
    debugger:
      enabled: true
  inputs:
    eventCode: $.get('eventCode')
  outputs:
    fixture_id: $.get('target_fixture_id')
    workflow-status: $.get('fixture_found') is not True and 'skipped' or 'executed'
  tasks:
    # 1. Load specific fixture if ID provided
    - type: document
      name: load-fixture-by-id
      condition: $.get('eventCode') is not None
      config:
        action: search
        search-limit: 1
      filters:
        metadata.event_code: str($.get('eventCode'))
      inputs:
        name: "'sport:Event'"
      outputs:
        fixture_found: len($.get('documents', [])) > 0
        target_fixture_id: $.get('documents')[0].get('metadata', {}).get('eventCode') if $.get('documents') else None
        event_value: $.get('documents')[0].get('value', {}) if $.get('documents') else None
        event_doc_id: $.get('documents')[0].get('_id') if $.get('documents') else None

    # 2. Find next upcoming fixture in a 60-hour window (consistent with market agent)
    - type: document
      name: load-next-fixture
      condition: $.get('fixture_found') is not True
      config:
        action: search
        search-limit: 1
        search-sorters: ["value.schema:startDate", 1]
      filters:
        value.sport:status: "{'$in': ['NS', 'not_started']}"
        value.schema:startDate: |
          {
            '$gt': (datetime.utcnow() - timedelta(hours=6)).isoformat(),
            '$lt': (datetime.utcnow() + timedelta(hours=60)).isoformat()
          }
        value.version_control.processing: "{'$ne': True}"
        value.version_control.forecasted: "{'$ne': True}"
      inputs:
        name: "'sport:Event'"
      outputs:
        fixture_found: len($.get('documents', [])) > 0
        target_fixture_id: $.get('documents')[0].get('metadata', {}).get('eventCode') if $.get('documents') else None
        event_value: $.get('documents')[0].get('value', {}) if $.get('documents') else None
        event_doc_id: $.get('documents')[0].get('_id') if $.get('documents') else None

    # 3. Mark as processing (lock)
    - type: document
      name: mark-processing
      condition: $.get('fixture_found') is True
      config:
        action: update
        force-update: true
      filters:
        document_id: $.get('event_doc_id')
      documents:
        sport:Event: |
          {
            **$.get('event_value', {}),
            'version_control': {
              **$.get('event_value', {}).get('version_control', {}),
              'processing': True,
              'last_touched': datetime.utcnow().isoformat()
            }
          }
