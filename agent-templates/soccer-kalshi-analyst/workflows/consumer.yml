workflow:
  name: soccer-kalshi-analysis-consumer
  title: Soccer - Kalshi Analysis Consumer
  description: |
    Find upcoming soccer fixtures from all enabled leagues that haven't been processed yet.
    Supports Premier League, Serie A, Bundesliga, and extensible to more leagues.
  context-variables:
    debugger:
      enabled: true
  inputs:
    fixture_id: $.get('fixture_id')
    league_key: $.get('league_key')  # Optional: restrict to specific league
  outputs:
    fixture_id: $.get('target_fixture_id')
    league_id: $.get('target_league_id')
    league_key: $.get('target_league_key')
    workflow-status: $.get('fixture_found') is not True and 'skipped' or 'executed'
  tasks:

    # 0. Load league configuration
    - type: mapping
      name: soccer-league-config
      inputs:
        league_key: $.get('league_key')
      outputs:
        all_leagues: $.get('all_leagues', {})
        enabled_leagues: $.get('enabled_leagues', [])
        league_by_api_id: $.get('league_by_api_id', {})

    # 1. Load specific fixture if ID provided
    - type: document
      name: load-fixture-by-id
      condition: $.get('fixture_id') is not None
      config:
        action: search
        search-limit: 1
      filters:
        metadata.fixture_id: str($.get('fixture_id'))
      inputs:
        name: "'sport:Event'"
      outputs:
        fixture_found: len($.get('documents', [])) > 0
        target_fixture_id: $.get('documents')[0].get('metadata', {}).get('fixture_id') if $.get('documents') else None
        target_league_id: "str($.get('documents')[0].get('value', {}).get('sport:competition', {}).get('@id', '')).split(':')[-1] if $.get('documents') else None"
        event_value: $.get('documents')[0].get('value', {}) if $.get('documents') else None
        event_doc_id: $.get('documents')[0].get('_id') if $.get('documents') else None

    # 2. Find next upcoming fixture across ALL enabled leagues
    - type: document
      name: load-next-fixture
      condition: $.get('fixture_found') is not True
      config:
        action: search
        search-limit: 1
        search-sorters: ["value.schema:startDate", 1]
      filters:
        value.sport:status: "{'$in': ['NS', 'not_started']}"
        value.schema:startDate: |
          {
            '$gt': (datetime.utcnow() - timedelta(hours=6)).isoformat(),
            '$lt': (datetime.utcnow() + timedelta(hours=60)).isoformat()
          }
        value.version_control.processing: "{'$ne': True}"
        value.version_control.forecasted: "{'$ne': True}"
        # Filter by enabled leagues only
        value.sport:competition.@id: |
          {
            '$in': [
              'urn:apifootball:league:' + league.get('api_football_league_id')
              for league in $.get('enabled_leagues', [])
            ]
          }
      inputs:
        name: "'sport:Event'"
      outputs:
        fixture_found: len($.get('documents', [])) > 0
        target_fixture_id: $.get('documents')[0].get('metadata', {}).get('fixture_id') if $.get('documents') else None
        target_league_id: "str($.get('documents')[0].get('value', {}).get('sport:competition', {}).get('@id', '')).split(':')[-1] if $.get('documents') else None"
        event_value: $.get('documents')[0].get('value', {}) if $.get('documents') else None
        event_doc_id: $.get('documents')[0].get('_id') if $.get('documents') else None

    # 3. Resolve league key from league ID
    - type: mapping
      name: resolve-league-key
      condition: $.get('fixture_found') is True and $.get('target_league_id') is not None
      config:
        inline: true
      inputs:
        league_by_api_id: $.get('league_by_api_id', {})
        target_league_id: $.get('target_league_id')
      outputs:
        target_league_key: "$.get('league_by_api_id', {}).get($.get('target_league_id'), {}).get('key', 'unknown')"
        target_league_config: "$.get('league_by_api_id', {}).get($.get('target_league_id'), {})"

    # 4. Mark as processing (lock)
    - type: document
      name: mark-processing
      condition: $.get('fixture_found') is True
      config:
        action: update
        force-update: true
      filters:
        document_id: $.get('event_doc_id')
      documents:
        sport:Event: |
          {
            **$.get('event_value', {}),
            'version_control': {
              **$.get('event_value', {}).get('version_control', {}),
              'processing': True,
              'last_touched': datetime.utcnow().isoformat()
            }
          }
