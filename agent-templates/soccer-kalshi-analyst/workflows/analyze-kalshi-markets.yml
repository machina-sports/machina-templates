workflow:
  name: soccer-analyze-kalshi-markets
  title: Soccer Kalshi Market Analysis
  description: Phase 4 - Identify trading edges by comparing AI predictions against Kalshi market prices
  context-variables:
    debugger:
      enabled: true
    google-genai:
      credential: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_CREDENTIAL"
      project_id: "$TEMP_CONTEXT_VARIABLE_VERTEX_AI_PROJECT_ID"
      api_key: "$TEMP_CONTEXT_VARIABLE_GOOGLE_GENERATIVE_AI_API_KEY"
  inputs:
    eventCode: "$.get('eventCode')"
    prediction_document_id: "$.get('prediction_document_id')"
  outputs:
    workflow-status: "$.get('workflow_executed_status', 'executed')"
    kalshi_analysis_id: "$.get('kalshi_analysis_id')"
  tasks:
    # 1. Load prediction from previous phase
    - type: document
      name: load-prediction
      config:
        action: search
        search-limit: 1
      filters:
        document_id: $.get('prediction_document_id')
      inputs:
        name: "'soccer-prediction'"
      outputs:
        final_prediction: "$.get('documents')[0].get('value', {}).get('prediction', {}) if len($.get('documents', [])) > 0 else {}"
        h_name: "$.get('documents')[0].get('value', {}).get('home_team', '') if len($.get('documents', [])) > 0 else ''"
        a_name: "$.get('documents')[0].get('value', {}).get('away_team', '') if len($.get('documents', [])) > 0 else ''"
        match_date: "$.get('documents')[0].get('value', {}).get('match_date', '') if len($.get('documents', [])) > 0 else ''"
        workflow_executed_status: "'executed'"

    # 1b. Gate by kickoff time (mapping)
    - type: mapping
      name: kickoff-filter
      condition: "$.get('match_date') is not None and $.get('match_date') != ''"
      inputs:
        match_date: "$.get('match_date')"
      outputs:
        kickoff_dt: "$.get('kickoff_dt')"
        kickoff_ts: "$.get('kickoff_ts')"
        min_ts: "$.get('min_ts')"
        max_ts: "$.get('max_ts')"
        is_past_match: "$.get('is_past_match')"
        workflow_executed_status: "$.get('workflow_executed_status')"

    # 2. Kalshi Integration
    - type: document
      name: load-kalshi
      config:
        action: search
        search-limit: 1
      filters:
        value.eventCode: $.get('eventCode')
      inputs:
        name: "'kalshi-events'"
      outputs:
        k_ticker: "$.get('documents')[0].get('value', {}).get('event_ticker') if len($.get('documents', [])) > 0 else None"

    - type: connector
      name: load-markets
      condition: "$.get('k_ticker') is not None"
      connector:
        name: kalshi
        command: get-markets
      inputs:
        event_ticker: "$.get('k_ticker')"
      outputs:
        markets: "$.get('markets', [])"
        market-tickers: |
          [
            market.get('ticker', '')
            for market in $.get('markets', [])
          ]

    # 2b. Load trades around kickoff and keep exactly 1 trade per market (price)
    - type: connector
      name: load-market-trade-price
      condition: "$.get('is_past_match', False) is True and $.get('k_ticker') is not None and len($.get('market-tickers', [])) > 0 and $.get('min_ts') is not None and $.get('max_ts') is not None"
      connector:
        name: kalshi
        command: get-markets/trades
      foreach:
        name: market_ticker
        expr: $
        value: $.get('market-tickers', [])
      inputs:
        # IMPORTANT: kalshi /markets/trades uses query param name "ticker"
        ticker: "$.get('market_ticker')"
        min_ts: "$.get('min_ts')"
        max_ts: "$.get('max_ts')"
        limit: 1
      outputs:
        # Aggregated across foreach into a list of per-market items
        market_trade_prices: |
          [
            {
              'ticker': $.get('market_ticker'),
              **($.get('trades', [])[0] if len($.get('trades', [])) > 0 else {})
            }
          ]

    # 2c. Resolve 1 price per market and prepare Kelly inputs (pyscript connector)
    - type: connector
      name: resolve-market-prices
      condition: "len($.get('markets', [])) > 0"
      connector:
        name: soccer-kalshi-price-resolver
        command: resolve_market_prices
      inputs:
        markets: "$.get('markets', [])"
        market_trade_prices: "$.get('market_trade_prices', [])"
        is_past_match: "$.get('is_past_match', False)"
      outputs:
        market_prices: "$.get('market_prices', [])"
        prices_source: "$.get('prices_source', 'unknown')"
        markets_for_kelly: "$.get('markets_for_kelly', [])"
        m_summary: "$.get('markets_summary', [])"
        m_count: "$.get('markets_count', 0)"

    # 3. Calculate Kelly Criterion (Python math - more accurate than LLM)
    - type: connector
      name: calculate-kelly
      condition: "$.get('m_count', 0) > 0"
      connector:
        name: soccer-kelly-calculator
        command: batch_kelly_analysis
      inputs:
        raw_markets: "$.get('markets_for_kelly', $.get('markets', []))"
        prediction: "$.get('final_prediction', {})"
        home_team: "$.get('h_name', '')"
        away_team: "$.get('a_name', '')"
        confidence: "$.get('final_prediction', {}).get('confidence', 0.5)"
        bankroll: 1000
      outputs:
        kelly_analysis: "$"

    # 3b. Analyze Market Correlations (Python math - avoid double exposure)
    - type: connector
      name: analyze-correlations
      condition: "$.get('kelly_analysis') is not None"
      connector:
        name: soccer-correlation-analyzer
        command: analyze_market_correlations
      inputs:
        kelly_results: "$.get('kelly_analysis', {})"
        prediction: "$.get('final_prediction', {})"
        home_team: "$.get('h_name', '')"
        away_team: "$.get('a_name', '')"
      outputs:
        correlation_analysis: "$"

    # 4. Edge Analysis with Kelly and Correlation calculations
    - type: prompt
      name: kalshi_edge_analyst
      condition: "$.get('m_count', 0) > 0"
      connector:
        name: google-genai
        command: invoke_prompt
        model: "gemini-3-pro-preview"
        location: global
        provider: vertex_ai
      inputs:
        prediction_data: "$.get('final_prediction')"
        markets_summary: "$.get('m_summary')"
        kelly_calculations: "$.get('kelly_analysis', {})"
        correlation_analysis: "$.get('correlation_analysis', {})"
      outputs:
        edge_analysis: "$"

    # 5. Store edge analysis
    - type: document
      name: store-edge
      condition: "$.get('edge_analysis') is not None"
      config:
        action: save
      documents:
        soccer-kalshi-analysis: |
          {
            'title': $.get('h_name', '') + ' vs ' + $.get('a_name', '') + ' - Kalshi Edge Analysis',
            'eventCode': $.get('eventCode'),
            'matchup': $.get('h_name', '') + ' vs ' + $.get('a_name', ''),
            'home_team': $.get('h_name', ''),
            'away_team': $.get('a_name', ''),
            'prediction_id': $.get('prediction_document_id'),
            'is_past_match': $.get('is_past_match', False),
            'prices_source': $.get('prices_source', 'unknown'),
            'market_prices': $.get('market_prices', []),
            'analysis': $.get('edge_analysis', {}).get('analysis'),
            'summary': $.get('edge_analysis', {}).get('summary'),
            'selected': $.get('edge_analysis', {}).get('selected_market'),
            'markets_ranked': $.get('edge_analysis', {}).get('markets_ranked'),
            'should_trade': $.get('edge_analysis', {}).get('should_trade'),
            'confidence': $.get('edge_analysis', {}).get('overall_confidence'),
            'risk_warnings': $.get('edge_analysis', {}).get('risk_warnings', []),
            'kelly_python': $.get('kelly_analysis', {}),
            'calculation_method': 'python_kelly_calculator',
            'timestamp': datetime.utcnow().isoformat()
          }
      metadata:
        eventCode: "$.get('eventCode')"
        home_team: "$.get('h_name', '')"
        away_team: "$.get('a_name', '')"
        match_date: "$.get('match_date')"
        should_trade: "$.get('edge_analysis', {}).get('should_trade', False)"
        selected_ticker: "$.get('edge_analysis', {}).get('selected_market', {}).get('ticker', '')"
        selected_tier: "$.get('edge_analysis', {}).get('selected_market', {}).get('tier', 'PASS')"
        confidence: "$.get('edge_analysis', {}).get('overall_confidence', 0)"
        document_type: "'kalshi-edge'"
        phase: "'kalshi-integration'"
      outputs:
        kalshi_analysis_id: "$.get('documents')[0].get('_id')"

