workflow:
  name: soccer-kalshi-sync-all
  title: Soccer - Sync All Leagues & Markets
  description: |
    Master synchronization workflow that:
    1. Syncs fixtures from API-Football for all enabled leagues
    2. Syncs Kalshi events for all enabled league series
    3. Matches Kalshi events to sport:Event fixtures
    Run this workflow periodically (e.g., every 6 hours) to keep data fresh.
  context-variables:
    debugger:
      enabled: true
    api-football:
      x-apisports-key: "$TEMP_CONTEXT_VARIABLE_API_FOOTBALL_API_KEY"
    machina-ai:
      api_key: "$TEMP_CONTEXT_VARIABLE_SDK_OPENAI_API_KEY"
  inputs:
    sync_fixtures: $.get('sync_fixtures', True)
    sync_kalshi: $.get('sync_kalshi', True)
    match_events: $.get('match_events', True)
    league_key: $.get('league_key')  # Optional: restrict to specific league
  outputs:
    workflow-status: "'executed'"
    sync_summary: $.get('sync_summary', {})
  tasks:

    # 1. Sync fixtures from API-Football
    - type: workflow
      name: sync-fixtures
      condition: $.get('sync_fixtures', True) is True
      workflow:
        name: soccer-sync-fixtures
      inputs:
        sync_all: $.get('league_key') is None
        league_key: $.get('league_key')
      outputs:
        fixtures_synced: $.get('total_fixtures', 0)
        fixtures_leagues: $.get('leagues_synced', [])

    # 2. Sync Kalshi events
    - type: workflow
      name: sync-kalshi-events
      condition: $.get('sync_kalshi', True) is True
      workflow:
        name: soccer-sync-kalshi-events
      inputs:
        sync_all: $.get('league_key') is None
        league_key: $.get('league_key')
      outputs:
        kalshi_events_synced: $.get('total_events', 0)
        kalshi_series: $.get('series_synced', [])

    # 3. Match Kalshi events to fixtures
    - type: workflow
      name: match-kalshi-events
      condition: $.get('match_events', True) is True
      workflow:
        name: soccer-match-kalshi-events
      inputs:
        league_key: $.get('league_key')
        limit: 100
      outputs:
        events_matched: $.get('match_count', 0)
        matched_markets: $.get('markets_matched', [])

    # 4. Build sync summary
    - type: mapping
      name: build-summary
      config:
        inline: true
      inputs:
        fixtures_synced: $.get('fixtures_synced', 0)
        fixtures_leagues: $.get('fixtures_leagues', [])
        kalshi_events_synced: $.get('kalshi_events_synced', 0)
        kalshi_series: $.get('kalshi_series', [])
        events_matched: $.get('events_matched', 0)
      outputs:
        sync_summary: |
          {
            'fixtures': {
              'total': $.get('fixtures_synced', 0),
              'leagues': $.get('fixtures_leagues', [])
            },
            'kalshi_events': {
              'total': $.get('kalshi_events_synced', 0),
              'series': $.get('kalshi_series', [])
            },
            'matching': {
              'events_matched': $.get('events_matched', 0)
            },
            'timestamp': datetime.utcnow().isoformat()
          }

